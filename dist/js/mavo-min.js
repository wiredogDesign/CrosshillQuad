!function(){"use strict";function e(t,i,s){return i=void 0===i?1:i,(s=s||i+1)-i<=1?function(){if(arguments.length<=i||"string"===r.type(arguments[i]))return t.apply(this,arguments);var e,s=arguments[i];for(var a in s){var n=Array.prototype.slice.call(arguments);n.splice(i,1,a,s[a]),e=t.apply(this,n)}return e}:e(e(t,i+1,s),i,s-1)}function t(e,r,s){var a=i(s);if("string"===a){var n=Object.getOwnPropertyDescriptor(r,s);!n||n.writable&&n.configurable&&n.enumerable&&!n.get&&!n.set?e[s]=r[s]:(delete e[s],Object.defineProperty(e,s,n))}else if("array"===a)s.forEach((function(i){i in r&&t(e,r,i)}));else for(var o in r)s&&("regexp"===a&&!s.test(o)||"function"===a&&!s.call(r,o))||t(e,r,o);return e}function i(e){if(null===e)return"null";if(void 0===e)return"undefined";var t=(Object.prototype.toString.call(e).match(/^\[object\s+(.*?)\]$/)[1]||"").toLowerCase();return"number"==t&&isNaN(e)?"nan":t}var r=self.Bliss=t((function(e,t){return 2==arguments.length&&!t||!e?null:"string"===r.type(e)?(t||document).querySelector(e):e||null}),self.Bliss);t(r,{extend:t,overload:e,type:i,property:r.property||"_",listeners:self.WeakMap?new WeakMap:new Map,original:{addEventListener:(self.EventTarget||Node).prototype.addEventListener,removeEventListener:(self.EventTarget||Node).prototype.removeEventListener},sources:{},noop:function(){},$:function(e,t){return e instanceof Node||e instanceof Window?[e]:2!=arguments.length||t?Array.prototype.slice.call("string"==typeof e?(t||document).querySelectorAll(e):e||[]):[]},defined:function(){for(var e=0;e<arguments.length;e++)if(void 0!==arguments[e])return arguments[e]},create:function(e,t){return e instanceof Node?r.set(e,t):(1===arguments.length&&("string"===r.type(e)?t={}:(e=(t=e).tag,t=r.extend({},t,(function(e){return"tag"!==e})))),r.set(document.createElement(e||"div"),t))},each:function(e,t,i){for(var r in i=i||{},e)i[r]=t.call(e,r,e[r]);return i},ready:function(e,t,i){if("function"!=typeof e||t||(t=e,e=void 0),e=e||document,t&&("loading"!==e.readyState?t():r.once(e,"DOMContentLoaded",(function(){t()}))),!i)return new Promise((function(t){r.ready(e,t,!0)}))},Class:function(e){var t,i=["constructor","extends","abstract","static"].concat(Object.keys(r.classProps)),s=e.hasOwnProperty("constructor")?e.constructor:r.noop;2==arguments.length?(t=arguments[0],e=arguments[1]):(t=function(){if(this.constructor.__abstract&&this.constructor===t)throw new Error("Abstract classes cannot be directly instantiated.");t.super&&t.super.apply(this,arguments),s.apply(this,arguments)},t.super=e.extends||null,t.prototype=r.extend(Object.create(t.super?t.super.prototype:Object),{constructor:t}),t.prototype.super=t.super?t.super.prototype:null,t.__abstract=!!e.abstract);var a=function(e){return this.hasOwnProperty(e)&&-1===i.indexOf(e)};if(e.static)for(var n in r.extend(t,e.static,a),r.classProps)n in e.static&&r.classProps[n](t,e.static[n]);for(var n in r.extend(t.prototype,e,a),r.classProps)n in e&&r.classProps[n](t.prototype,e[n]);return t},classProps:{lazy:e((function(e,t,i){return Object.defineProperty(e,t,{get:function(){var e=i.call(this);return Object.defineProperty(this,t,{value:e,configurable:!0,enumerable:!0,writable:!0}),e},set:function(e){Object.defineProperty(this,t,{value:e,configurable:!0,enumerable:!0,writable:!0})},configurable:!0,enumerable:!0}),e})),live:e((function(e,t,i){return"function"===r.type(i)&&(i={set:i}),Object.defineProperty(e,t,{get:function(){var e=this["_"+t],r=i.get&&i.get.call(this,e);return void 0!==r?r:e},set:function(e){var r=this["_"+t],s=i.set&&i.set.call(this,e,r);this["_"+t]=void 0!==s?s:e},configurable:i.configurable,enumerable:i.enumerable}),e}))},include:function(){var e=arguments[arguments.length-1],t=2===arguments.length&&arguments[0],i=document.createElement("script");return t?Promise.resolve():new Promise((function(t,s){r.set(i,{async:!0,onload:function(){t(i),i.parentNode&&i.parentNode.removeChild(i)},onerror:function(){s(i)},src:e,inside:document.head})}))},load:function e(t,i){i=i?new URL(i,location.href):location.href,t=new URL(t,i);var s=e.loading=e.loading||{};return s[t+""]?s[t+""]:/\.css$/.test(t.pathname)?s[t+""]=new Promise((function(e,i){var s=r.create("link",{href:t,rel:"stylesheet",inside:document.head,onload:function(){e(s)},onerror:function(){i(s)}})})):s[t+""]=r.include(t)},fetch:function(e,i){if(!e)throw new TypeError("URL parameter is mandatory and cannot be "+e);var s=t({url:new URL(e,location),data:"",method:"GET",headers:{},xhr:new XMLHttpRequest},i);for(var a in s.method=s.method.toUpperCase(),r.hooks.run("fetch-args",s),"GET"===s.method&&s.data&&(s.url.search+=s.data),document.body.setAttribute("data-loading",s.url),s.xhr.open(s.method,s.url.href,!1!==s.async,s.user,s.password),i)if("upload"===a)s.xhr.upload&&"object"==typeof i[a]&&r.extend(s.xhr.upload,i[a]);else if(a in s.xhr)try{s.xhr[a]=i[a]}catch(e){self.console}var n=Object.keys(s.headers).map((function(e){return e.toLowerCase()}));for(var o in"GET"!==s.method&&-1===n.indexOf("content-type")&&s.xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded"),s.headers)void 0!==s.headers[o]&&s.xhr.setRequestHeader(o,s.headers[o]);var l=new Promise((function(e,t){s.xhr.onload=function(){document.body.removeAttribute("data-loading"),0===s.xhr.status||s.xhr.status>=200&&s.xhr.status<300||304===s.xhr.status?e(s.xhr):t(r.extend(Error(s.xhr.statusText),{xhr:s.xhr,get status(){return this.xhr.status}}))},s.xhr.onerror=function(){document.body.removeAttribute("data-loading"),t(r.extend(Error("Network Error"),{xhr:s.xhr}))},s.xhr.ontimeout=function(){document.body.removeAttribute("data-loading"),t(r.extend(Error("Network Timeout"),{xhr:s.xhr}))},s.xhr.send("GET"===s.method?null:s.data)}));return l.xhr=s.xhr,l},value:function(e){var t="string"!=typeof e;return r.$(arguments).slice(+t).reduce((function(e,t){return e&&e[t]}),t?e:self)}}),r.Hooks=new r.Class({add:function(e,t,i){if("string"==typeof arguments[0])(Array.isArray(e)?e:[e]).forEach((function(e){this[e]=this[e]||[],t&&this[e][i?"unshift":"push"](t)}),this);else for(var e in arguments[0])this.add(e,arguments[0][e],arguments[1])},run:function(e,t){this[e]=this[e]||[],this[e].forEach((function(e){e.call(t&&t.context?t.context:t,t)}))}}),r.hooks=new r.Hooks,r.property,r.Element=function(e){this.subject=e,this.data={},this.bliss={}},r.Element.prototype={set:e((function(e,t){e in r.setProps?r.setProps[e].call(this,t):e in this?this[e]=t:this.setAttribute(e,t)}),0),transition:function(e,t){return new Promise(function(i,s){if("transition"in this.style&&0!==t){var a=r.extend({},this.style,/^transition(Duration|Property)$/);r.style(this,{transitionDuration:(t||400)+"ms",transitionProperty:Object.keys(e).join(", ")}),r.once(this,"transitionend",(function(){clearTimeout(n),r.style(this,a),i(this)}));var n=setTimeout(i,t+50,this);r.style(this,e)}else r.style(this,e),i(this)}.bind(this))},fire:function(e,t){var i=document.createEvent("HTMLEvents");return i.initEvent(e,!0,!0),this.dispatchEvent(r.extend(i,t))},bind:e((function(e,t){if(arguments.length>1&&("function"===r.type(t)||t.handleEvent)){var i=t;(t="object"===r.type(arguments[2])?arguments[2]:{capture:!!arguments[2]}).callback=i}var s=r.listeners.get(this)||{};e.trim().split(/\s+/).forEach((function(e){if(e.indexOf(".")>-1){var i=(e=e.split("."))[1];e=e[0]}s[e]=s[e]||[],0===s[e].filter((function(e){return e.callback===t.callback&&e.capture==t.capture})).length&&s[e].push(r.extend({className:i},t)),r.original.addEventListener.call(this,e,t.callback,t)}),this),r.listeners.set(this,s)}),0),unbind:e((function(e,t){if(t&&("function"===r.type(t)||t.handleEvent)){var i=t;t=arguments[2]}"boolean"==r.type(t)&&(t={capture:t}),(t=t||{}).callback=t.callback||i;var s=r.listeners.get(this);(e||"").trim().split(/\s+/).forEach((function(e){if(e.indexOf(".")>-1){var i=(e=e.split("."))[1];e=e[0]}if(s){for(var a in s)if(!e||a===e)for(var n,o=0;n=s[a][o];o++)i&&i!==n.className||t.callback&&t.callback!==n.callback||!!t.capture!=!!n.capture&&(e||t.callback||void 0!==t.capture)||(s[a].splice(o,1),r.original.removeEventListener.call(this,a,n.callback,n.capture),o--)}else if(e&&t.callback)return r.original.removeEventListener.call(this,e,t.callback,t.capture)}),this)}),0),when:function(e,t){var i=this;return new Promise((function(r){i.addEventListener(e,(function i(s){t&&!t.call(this,s)||(this.removeEventListener(e,i),r(s))}))}))},toggleAttribute:function(e,t,i){arguments.length<3&&(i=null!==t),i?this.setAttribute(e,t):this.removeAttribute(e)}},r.setProps={style:function(e){for(var t in e)t in this.style?this.style[t]=e[t]:this.style.setProperty(t,e[t])},attributes:function(e){for(var t in e)this.setAttribute(t,e[t])},properties:function(e){r.extend(this,e)},events:function(e){if(1!=arguments.length||!e||!e.addEventListener)return r.bind.apply(this,[this].concat(r.$(arguments)));var t=this;if(r.listeners){var i=r.listeners.get(e);for(var s in i)i[s].forEach((function(e){r.bind(t,s,e.callback,e.capture)}))}for(var a in e)0===a.indexOf("on")&&(this[a]=e[a])},once:e((function(e,t){var i=this,s=function(){return r.unbind(i,e,s),t.apply(i,arguments)};r.bind(this,e,s,{once:!0})}),0),delegate:e((function(e,t,i){r.bind(this,e,(function(e){e.target.closest(t)&&i.call(this,e)}))}),0,2),contents:function(e){(e||0===e)&&(Array.isArray(e)?e:[e]).forEach((function(e){var t=r.type(e);/^(string|number)$/.test(t)?e=document.createTextNode(e+""):"object"===t&&(e=r.create(e)),e instanceof Node&&this.appendChild(e)}),this)},inside:function(e){e&&e.appendChild(this)},before:function(e){e&&e.parentNode.insertBefore(this,e)},after:function(e){e&&e.parentNode.insertBefore(this,e.nextSibling)},start:function(e){e&&e.insertBefore(this,e.firstChild)},around:function(e){e&&e.parentNode&&r.before(this,e),this.appendChild(e)}},r.Array=function(e){this.subject=e},r.Array.prototype={all:function(e){var t=r.$(arguments).slice(1);return this[e].apply(this,t)}},r.add=e((function(e,t,i,s){i=r.extend({$:!0,element:!0,array:!0},i),"function"==r.type(t)&&(!i.element||e in r.Element.prototype&&s||(r.Element.prototype[e]=function(){return this.subject&&r.defined(t.apply(this.subject,arguments),this.subject)}),!i.array||e in r.Array.prototype&&s||(r.Array.prototype[e]=function(){var e=arguments;return this.subject.map((function(i){return i&&r.defined(t.apply(i,e),i)}))}),i.$&&(r.sources[e]=r[e]=t,(i.array||i.element)&&(r[e]=function(){var t=[].slice.apply(arguments),s=t.shift(),a=i.array&&Array.isArray(s)?"Array":"Element";return r[a].prototype[e].apply({subject:s},t)})))}),0),r.add(r.Array.prototype,{element:!1}),r.add(r.Element.prototype),r.add(r.setProps),r.add(r.classProps,{element:!1,array:!1});var s=document.createElement("_");r.add(r.extend({},HTMLElement.prototype,(function(e){return"function"===r.type(s[e])})),null,!0)}(),function(e){"use strict";var t="Compound",i="MemberExpression",r="Literal",s=function(e,t){var i=new Error(e+" at character "+t);throw i.index=t,i.description=e,i},a={"-":!0,"!":!0,"~":!0,"+":!0},n={"||":1,"&&":2,"|":3,"^":4,"&":5,"==":6,"!=":6,"===":6,"!==":6,"<":7,">":7,"<=":7,">=":7,"<<":8,">>":8,">>>":8,"+":9,"-":9,"*":10,"/":10,"%":10},o=function(e){var t,i=0;for(var r in e)(t=r.length)>i&&e.hasOwnProperty(r)&&(i=t);return i},l=o(a),h=o(n),u={true:!0,false:!1,null:null},d=function(e){return n[e]||0},c=function(e,t,i){return{type:"||"===e||"&&"===e?"LogicalExpression":"BinaryExpression",operator:e,left:t,right:i}},p=function(e){return 48<=e&&e<=57},m=function(e){return 36===e||95===e||65<=e&&e<=90||97<=e&&e<=122||128<=e&&!n[String.fromCharCode(e)]},v=function(e){return 36===e||95===e||65<=e&&e<=90||97<=e&&e<=122||48<=e&&e<=57||128<=e&&!n[String.fromCharCode(e)]},f=function(e){for(var o,f,g=0,y=e.charAt,b=e.charCodeAt,x=function(t){return y.call(e,t)},M=function(t){return b.call(e,t)},w=e.length,A=function(){for(var e=M(g);32===e||9===e||10===e||13===e;)e=M(++g)},E=function(){var e,t,i=C();return A(),63!==M(g)?i:(g++,(e=E())||s("Expected expression",g),A(),58===M(g)?(g++,(t=E())||s("Expected expression",g),{type:"ConditionalExpression",test:i,consequent:e,alternate:t}):void s("Expected :",g))},k=function(){A();for(var t=e.substr(g,h),i=t.length;0<i;){if(n.hasOwnProperty(t)&&(!m(M(g))||g+t.length<e.length&&!v(M(g+t.length))))return g+=i,t;t=t.substr(0,--i)}return!1},C=function(){var e,t,i,r,a,n,o,l,h;if(n=N(),!(t=k()))return n;for(a={value:t,prec:d(t)},(o=N())||s("Expected expression after "+t,g),r=[n,a,o];(t=k())&&0!==(i=d(t));){for(a={value:t,prec:i},h=t;2<r.length&&i<=r[r.length-2].prec;)o=r.pop(),t=r.pop().value,n=r.pop(),e=c(t,n,o),r.push(e);(e=N())||s("Expected expression after "+h,g),r.push(a,e)}for(e=r[l=r.length-1];1<l;)e=c(r[l-1].value,r[l-2],e),l-=2;return e},N=function(){var t,i,r;if(A(),t=M(g),p(t)||46===t)return O();if(39===t||34===t)return $();if(91===t)return D();for(r=(i=e.substr(g,l)).length;0<r;){if(a.hasOwnProperty(i)&&(!m(M(g))||g+i.length<e.length&&!v(M(g+i.length))))return g+=r,{type:"UnaryExpression",operator:i,argument:N(),prefix:!0};i=i.substr(0,--r)}return!(!m(t)&&40!==t)&&T()},O=function(){for(var e,t,i="";p(M(g));)i+=x(g++);if(46===M(g))for(i+=x(g++);p(M(g));)i+=x(g++);if("e"===(e=x(g))||"E"===e){for(i+=x(g++),"+"!==(e=x(g))&&"-"!==e||(i+=x(g++));p(M(g));)i+=x(g++);p(M(g-1))||s("Expected exponent ("+i+x(g)+")",g)}return t=M(g),m(t)?s("Variable names cannot start with a number ("+i+x(g)+")",g):46===t&&s("Unexpected period",g),{type:r,value:parseFloat(i),raw:i}},$=function(){for(var e,t="",i=x(g++),a=!1;g<w;){if((e=x(g++))===i){a=!0;break}if("\\"===e)switch(e=x(g++)){case"n":t+="\n";break;case"r":t+="\r";break;case"t":t+="\t";break;case"b":t+="\b";break;case"f":t+="\f";break;case"v":t+="\v";break;default:t+=e}else t+=e}return a||s('Unclosed quote after "'+t+'"',g),{type:r,value:t,raw:i+t+i}},P=function(){var t,i=M(g),a=g;for(m(i)?g++:s("Unexpected "+x(g),g);g<w&&(i=M(g),v(i));)g++;return t=e.slice(a,g),u.hasOwnProperty(t)?{type:r,value:u[t],raw:t}:"this"===t?{type:"ThisExpression"}:{type:"Identifier",name:t}},S=function(e){for(var i,r,a=[],n=!1,o=0;g<w;){if(A(),(i=M(g))===e){n=!0,g++,41===e&&o&&o>=a.length&&s("Unexpected token "+String.fromCharCode(e),g);break}if(44===i){if(g++,++o!==a.length)if(41===e)s("Unexpected token ,",g);else if(93===e)for(var l=a.length;l<o;l++)a.push(null)}else(r=E())&&r.type!==t||s("Expected comma",g),a.push(r)}return n||s("Expected "+String.fromCharCode(e),g),a},T=function(){var e,t;for(t=40===(e=M(g))?L():P(),A(),e=M(g);46===e||91===e||40===e;)g++,46===e?(A(),t={type:i,computed:!1,object:t,property:P()}):91===e?(t={type:i,computed:!0,object:t,property:E()},A(),93!==(e=M(g))&&s("Unclosed [",g),g++):40===e&&(t={type:"CallExpression",arguments:S(41),callee:t}),A(),e=M(g);return t},L=function(){g++;var e=E();if(A(),41===M(g))return g++,e;s("Unclosed (",g)},D=function(){return g++,{type:"ArrayExpression",elements:S(93)}},j=[];g<w;)59===(o=M(g))||44===o?g++:(f=E())?j.push(f):g<w&&s('Unexpected "'+x(g)+'"',g);return 1===j.length?j[0]:{type:t,body:j}};if(f.version="0.3.4",f.toString=function(){return"JavaScript Expression Parser (JSEP) v"+f.version},f.addUnaryOp=function(e){return l=Math.max(e.length,l),a[e]=!0,this},f.addBinaryOp=function(e,t){return h=Math.max(e.length,h),n[e]=t,this},f.addLiteral=function(e,t){return u[e]=t,this},f.removeUnaryOp=function(e){return delete a[e],e.length===l&&(l=o(a)),this},f.removeAllUnaryOps=function(){return a={},l=0,this},f.removeBinaryOp=function(e){return delete n[e],e.length===h&&(h=o(n)),this},f.removeAllBinaryOps=function(){return n={},h=0,this},f.removeLiteral=function(e){return delete u[e],this},f.removeAllLiterals=function(){return u={},this},"undefined"==typeof exports){var g=e.jsep;(e.jsep=f).noConflict=function(){return e.jsep===f&&(e.jsep=g),f}}else"undefined"!=typeof module&&module.exports?exports=module.exports=f:exports.parse=f}(this),function(){if(self.Element&&(Element.prototype.matches||(Element.prototype.matches=Element.prototype.webkitMatchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||null),Element.prototype.matches)){var e=self.Stretchy={selectors:{base:'textarea, select:not([size]), input:not([type]), input[type="'+"text number url email tel".split(" ").join('"], input[type="')+'"]',filter:"*"},script:document.currentScript||i("script").pop(),resize:function(t){if(e.resizes(t)){var i,r=getComputedStyle(t),s=0;!t.value&&t.placeholder&&(i=!0,t.value=t.placeholder);var a=t.nodeName.toLowerCase();if("textarea"==a)t.style.height="0","border-box"==r.boxSizing?s=t.offsetHeight:"content-box"==r.boxSizing&&(s=-t.clientHeight+parseFloat(r.minHeight)),t.style.height=t.scrollHeight+s+"px";else if("input"==a)if(t.style.width="1000px",t.offsetWidth){t.style.width="0","border-box"==r.boxSizing?s=t.offsetWidth:"padding-box"==r.boxSizing?s=t.clientWidth:"content-box"==r.boxSizing&&(s=parseFloat(r.minWidth));var n=Math.max(s,t.scrollWidth-t.clientWidth);t.style.width=n+"px";for(var o=0;o<10&&(t.scrollLeft=1e10,0!=t.scrollLeft);o++)n+=t.scrollLeft,t.style.width=n+"px"}else t.style.width=t.value.length+1+"ch";else if("select"==a){var l,h=0<t.selectedIndex?t.selectedIndex:0,u=document.createElement("_");for(var d in u.textContent=t.options[h].textContent,t.parentNode.insertBefore(u,t.nextSibling),r){var c=r[d];/^(width|webkitLogicalWidth|length)$/.test(d)||"string"!=typeof c||(u.style[d]=c,/appearance$/i.test(d)&&(l=d))}u.style.width="",0<u.offsetWidth&&(t.style.width=u.offsetWidth+"px",r[l]&&"none"===r[l]||(t.style.width="calc("+t.style.width+" + 2em)")),u.parentNode.removeChild(u),u=null}i&&(t.value="")}},resizeAll:function(t){i(t||e.selectors.base).forEach((function(t){e.resize(t)}))},active:!0,resizes:function(t){return t&&t.parentNode&&t.matches&&t.matches(e.selectors.base)&&t.matches(e.selectors.filter)},init:function(){e.selectors.filter=e.script.getAttribute("data-filter")||(i("[data-stretchy-filter]").pop()||document.body).getAttribute("data-stretchy-filter")||e.selectors.filter,e.resizeAll(),self.MutationObserver&&!e.observer&&(e.observer=new MutationObserver((function(t){e.active&&t.forEach((function(t){"childList"==t.type&&e.resizeAll(t.addedNodes)}))})),e.observer.observe(document.documentElement,{childList:!0,subtree:!0}))},$$:i};"loading"!==document.readyState?requestAnimationFrame(e.init):document.addEventListener("DOMContentLoaded",e.init),window.addEventListener("load",(function(){e.resizeAll()}));var t=function(t){e.active&&e.resize(t.target)};document.documentElement.addEventListener("input",t),document.documentElement.addEventListener("change",t)}function i(e,t){return e instanceof Node||e instanceof Window?[e]:[].slice.call("string"==typeof e?(t||document).querySelectorAll(e):e||[])}}(),Stretchy.selectors.filter=".mv-editor:not([property]), .mv-autosize",async function(e,t){self.$=self.$||e,self.$$=self.$$||t;var i=self.Mavo=e.Class({constructor:function(r){if(this.treeBuilt=Mavo.promise(),this.dataLoaded=Mavo.promise(),this.deleted=[],this.element=r,this.inProgress=!1,this.index=Object.keys(i.all).length+1,Object.defineProperty(i.all,this.index-1,{value:this,configurable:!0}),this.id=Mavo.getAttribute(this.element,"mv-app","id")||`mavo${this.index}`,this.id in i.all){for(var s=2;this.id+s in i.all;s++);this.id+=s}i.all[this.id]=this,this.element.setAttribute("mv-app",this.id),this.observe({attribute:"lang",deep:!1},(()=>{var e=Mavo.getClosestAttribute(this.element,"lang")||Mavo.locale;this.locale=Mavo.Locale.get(e)}))(),this.autoEdit=this.element.classList.contains("mv-autoedit"),this.autoSave=this.element.hasAttribute("mv-autosave"),this.autoSaveDelay=1e3*(this.element.getAttribute("mv-autosave")||0),Mavo.setAttributeShy(this.element,"typeof",""),Mavo.hooks.run("init-start",this),t(i.selectors.multiple,this.element).forEach((e=>{i.setAttributeShy(e,"property","")})),t(i.selectors.primitive,this.element).forEach((t=>{if(e(i.selectors.property,t)){var r=Mavo.Primitive.getConfig(t);(r.attribute||r.hasChildren)&&!Mavo.is("multiple",t)||Mavo.setAttributeShy(t,"typeof","")}})),this.expressions=new Mavo.Expressions(this),i.observers=i.observers||new Mavo.Observers,i.observers.observer.observe(this.element,{characterData:!0,childList:!0,subtree:!0,attributes:!0}),Mavo.hooks.run("init-tree-before",this),this.root=new Mavo.Group(this.element,this),this.treeBuilt.resolve(),Mavo.hooks.run("init-tree-after",this),this.permissions=new Mavo.Permissions;var a=["source","storage","init","uploads"];a.forEach((e=>this.updateBackend(e))),this.observe({deep:!1,attribute:!0},(({attribute:e})=>{if(0===e.indexOf("mv-")){let t=e?.replace(/^mv-/,"")?.split("-")?.[0];a.includes(t)&&(this.updateBackend(t),("source"===t||!this.source&&("storage"===t||"init"===t&&!this.root.data))&&this.load())}})),this.permissions.can("login",(()=>{let e;if(null!==Mavo.Functions.url("login")&&1===this.index?e="login":null!==Mavo.Functions.url(this.id+"-login")&&(e=this.id+"-login"),void 0!==e){const t=new URL(location.href);t.searchParams.delete(e),history.replaceState(null,"",t),this.primaryBackend.login()}})),e.bind(this.element,"mv-login.mavo",(e=>{e.backend!=(this.source||this.storage)||this.root.data||this.unsavedChanges||this.load()})),this.bar=new Mavo.UI.Bar(this),this.needsEdit=this.calculateNeedsEdit(),this.setUnsavedChanges(!1),this.permissions.onchange((({action:e,value:t})=>{var i=this.element.getAttribute("mv-permissions")||"";i=i.trim().split(/\s+/).filter((t=>t!=e)),t&&i.push(e),this.element.setAttribute("mv-permissions",i.join(" "))})),this.permissions.can(["edit","add","delete"],(()=>{this.autoEdit&&this.edit()})),this.observe({attribute:"mv-mode"},(({element:e})=>{if(this.permissions.edit||this.permissions.add||this.permissions.delete){let t=i.Node.children(e);e:for(let r=0;r<t.length;r++){let s,a=t[r],n=a.mode;if(a.element==e)s=a.element.getAttribute("mv-mode"),a.modes=s;else{if(a.modes)continue e;s=i.getStyle(a.element.parentNode,"--mv-mode")}a.mode=s,n!=a.mode&&a["edit"==a.mode?"edit":"done"]()}}})),this.storage||this.source?this.permissions.can("read",(()=>this.load())):requestAnimationFrame((()=>{this.dataLoaded.resolve(),this.expressions.update(),e.fire(this.element,"mv-load")})),e.bind(this.element,"mv-load.mavo",(()=>{if(location.hash){var e=()=>{var e=document.getElementById(location.hash.slice(1));return(e||!location.hash)&&this.element.contains(e)&&requestAnimationFrame((()=>{Mavo.scrollIntoViewIfNeeded(e)})),e};e()||this.observe({attribute:"id",once:!0},e)}requestAnimationFrame((()=>Stretchy.resizeAll()))})),this.autoSave&&this.dataLoaded.then((()=>{var t=i.debounce((()=>{this.save()}),this.autoSaveDelay),r=e=>{e.node.saved&&this.autoSave&&t()};requestAnimationFrame((()=>{this.permissions.can("save",(()=>{e.bind(this.element,"mv-change.mavo:autosave",r)}),(()=>{e.unbind(this.element,"mv-change.mavo:autosave",r)}))}))})),this.element.addEventListener("keydown",(e=>{var t=e.target;if(this.permissions.save&&"S"==e.key&&e[i.superKey]&&!e.altKey)e.preventDefault(),this.save();else if("ArrowUp"===e.key||"ArrowDown"===e.key){if(t.matches("textarea, input[type=range], input[type=number]"))return;if(t.matches(".mv-editor")){var r=!0;t=t.parentNode}var s=Mavo.Node.get(t);if(s?.closestCollection){var a=s.getCousin("ArrowUp"===e.key?-1:1,{wrap:!0});a&&(r&&a.editing?(a.edit(),a.editor.focus()):a.element.focus(),e.preventDefault())}}})),e.bind(this.element,"click submit",i.Actions.listener),Mavo.hooks.run("init-end",this)},get editing(){return this.root.editing},observe(e={},t){let r=Object.assign({element:this.element},e);return i.observers?.observe(r,t)},unobserve(e,t){let r=Object.assign({element:this.element},e);return i.observers?.observe(r,t)},getData:function(e){let t={context:this,options:e};return t.data=this.root.getData(e),i.hooks.run("getdata-end",t),t.data},toJSON:function(){return i.toJSON(this.getData())},message:function(e,t={}){return new i.UI.Message(this,e,t)},error:function(e,...t){this.message(e,{type:"error",dismiss:["button","timeout"]}),t.length},render:function(e){var t={context:this,data:e};i.hooks.run("render-start",t),t.data&&this.root.render(t.data),this.unsavedChanges=!1,i.hooks.run("render-end",t)},edit:function(){this.root.edit(),e.bind(this.element,"mouseenter.mavo:edit mouseleave.mavo:edit",(e=>{if(e.target.matches(i.selectors.multiple)){e.target.classList.remove("mv-has-hovered-item");var t=e.target.parentNode.closest(i.selectors.multiple);t&&t.classList.toggle("mv-has-hovered-item","mouseenter"==e.type)}}),!0),this.setUnsavedChanges()},done:function(){this.root.done(),e.unbind(this.element,".mavo:edit"),this.unsavedChanges=!1},setUnsavedChanges:function(e){var t=!!e;return e||this.walk((i=>{if(i.unsavedChanges)return t=!0,!1===e&&(i.unsavedChanges=!1),!1})),this.unsavedChanges=t},updateBackend(e){let t,r,s=this[e];const a="mv-"+e;if(1==this.index&&(t=i.Functions.url(e)),t||(t=i.Functions.url(`${this.id}-${e}`)||this.element.getAttribute(a)||null),t&&(t=t.trim(),"none"==t&&(t=null)),t){let n=a+"-",o=Mavo.getAttributes(this.element,RegExp("^"+n)),l=Object.fromEntries(o.map((e=>[e.replace(n,""),this.element.getAttribute(e)])));s?.equals?.(t)||(this[e]=t=i.Backend.create(t,{format:this.element.getAttribute("mv-format"),...l,mavo:this},s),r=!0)}else this[e]=null;if(r=r||(t?!t.equals(s):!!s),r){this.storage||this.source||!this.init||(this.source=this.init,this.init=null);var n=this.storage?this.storage.permissions:new Mavo.Permissions({edit:!0,save:!1});n.parent=this.source?.permissions,this.permissions.parent=n,this.primaryBackend=this.storage||this.source}return r},async load(){var t=this.source||this.storage;if(t){this.inProgress="Loading",await t.ready;let i=await t.load().catch((e=>this.init&&this.init!=t?(t=this.init,this.init.ready.then((()=>this.init.load()))):Promise.reject(e))).catch((e=>{if(e){var t=e instanceof XMLHttpRequest?e:e.xhr;if(404==t?.status)this.render(null);else{var i=this._("problem-loading");t&&(i+=t.status?this._("http-error",e):": "+this._("cant-connect")),this.error(i,e)}}return null}));this.render(i),this.inProgress=!1,await Mavo.defer(),this.dataLoaded.resolve(),e.fire(this.element,"mv-load")}},async store(){if(!this.storage)return;let e;this.inProgress="Saving";try{e=await this.storage.store(this.getData())}catch(i){if(i){var t=this._("problem-saving");i instanceof XMLHttpRequest&&(t+=": "+(i.status?this._("http-error",i):this._("cant-connect"))),this.error(t,i)}e=null}return this.inProgress=!1,e},upload:function(e,t="images/"+e.name){return this.uploadBackend?(this.inProgress=this._("uploading"),this.uploadBackend.upload(e,t).then((e=>(this.inProgress=!1,e))).catch((e=>(this.error(this._("error-uploading"),e),this.inProgress=!1,null)))):Promise.reject()},async save(){i.hooks.run("save-start",this);let t=await this.store();t&&(e.fire(this.element,"mv-save",t),this.lastSaved=Date.now(),this.root.save(),this.unsavedChanges=!1)},walk:function(){return this.root.walk(...arguments)},calculateNeedsEdit:function(){var e=!1;return this.walk((t=>!e&&(e=!(t.modes||t instanceof Mavo.Group),!t.modes)),void 0,{descentReturn:!0}),e},changed:function(e){!this.root||this.expressions.active&&this.expressions.updateThrottled(e)},setDeleted:function(...e){if(this.deleted.forEach((e=>e.destroy())),this.deleted.length=[],this.deletionNotice?.close(),e.length){if(this.deleted.push(...e),1==e.length)var t=e[0].name;else{var i={},r=[];for(var s in e.forEach((e=>{i[e.name]=(i[e.name]||0)+1})),i)r.push(this._("n-items",{name:s,n:i[s]}));t=r.join(", ")}var a=this.deletionNotice=this.message([this._("item-deleted",{name:t}),{tag:"button",type:"button",textContent:this._("undo"),events:{click:()=>{this.undoDelete(),this.deletionNotice.close(!0)}}}],{classes:"mv-deleted",dismiss:{button:!0,timeout:2e4}});a.closed.then((e=>{!e&&this.deleted.length&&(this.deleted.forEach((e=>e.destroy())),this.deleted.length=0),this.deletionNotice==a&&(this.deletionNotice=null)}))}},undoDelete:function(){this.deleted.forEach((e=>e.collection.add(e,e.index))),this.deleted.length=0},destroy(){Mavo.hooks.run("mavo-destroy-start",this),this.editing&&this.done(),this.observer.destroy(),this.bar?.destroy(),Mavo.all[this.id]=Mavo.all[this.index-1]=null,this.root.destroy(),Mavo.hooks.run("mavo-destroy-end",this)},live:{inProgress:function(t){e.toggleAttribute(this.element,"mv-progress",t,t),e.toggleAttribute(this.element,"aria-busy",!!t,!!t),this.element.style.setProperty("--mv-progress-text",t?`"${this._(t)}"`:"")},unsavedChanges:function(e){this.element.classList.toggle("mv-unsaved-changes",e)},needsEdit:function(e){this.bar&&this.bar.toggle("edit",e&&this.permissions.edit)},storage:function(e){if(e!==this._storage&&!e){var t=new Mavo.Permissions({edit:!0,save:!1});t.parent=this.permissions.parent,this.permissions.parent=t}},primaryBackend:function(e){if((e=e||null)!=this._primaryBackend)return e},uploadBackend:{get:function(){const e=this.uploads;return e?.upload?(e.permissions.login&&e.login(),this.uploads):this.storage?.upload?this.storage:void 0}}},static:{version:"v0.2.4",all:{},get:function(e){if(e instanceof Element){for(var t in i.all)if(i.all[t].element==e)return i.all[t];return null}t="number"==typeof e?Object.keys(i.all)[e]:e;return i.all[t]||null},superKey:0===navigator.platform.indexOf("Mac")?"metaKey":"ctrlKey",base:"about:"==location.protocol?document.currentScript?document.currentScript.src:"http://mavo.io":location,dependencies:[e.ready().then((()=>i.Plugins.load()))],polyfillsNeeded:{blissfuljs:Array.from&&document.documentElement.closest&&self.URL&&"searchParams"in URL.prototype,"Intl.~locale.en":self.Intl,IntersectionObserver:self.IntersectionObserver,Symbol:self.Symbol,"Element.prototype.remove":Element.prototype.remove,"Element.prototype.before":Element.prototype.before,"Element.prototype.after":Element.prototype.after,"Element.prototype.prepend":Element.prototype.prepend,"Array.prototype.flat":Array.prototype.flat,"Array.prototype.flatMap":Array.prototype.flatMap},polyfills:[],init:function(e=document){var r=Array.isArray(arguments[0])?arguments[0]:t(i.selectors.init,e),s=r.filter((e=>!i.get(e))).map((e=>new i(e)));return s},observe:(e,t)=>(i.observers=i.observers||new Mavo.Observers,i.observers.observe(e,t)),unobserve(e,t){i.observers.unobserve(e,t)},warn:function e(t,r={}){e.history=e.history||new Set,i.warn.history.has(t),!1!==r.once&&e.history.add(t)},thenAll:function(r){return t(r).forEach((t=>{"promise"==e.type(t)&&(t=t.catch((e=>e)))})),Promise.all(r).then((e=>r.length==e.length?e:i.thenAll(r)))},promise:function(e){var t,i,r=new Promise(((r,s)=>{"function"==typeof e?e(r,s):e instanceof Promise&&(e.then(r),e.catch(s)),t=r,i=s}));return r.resolve=e=>(t(e),r),r.reject=e=>(i(e),r),r},defer:e=>new Promise((t=>void 0===e?requestAnimationFrame(t):setTimeout(t,e))),UI:{},hooks:new e.Hooks,properties:new Set,attributes:["mv-app","mv-storage","mv-source","mv-init","mv-path","mv-multiple-path","mv-format","mv-attribute","mv-default","mv-mode","mv-edit","mv-editor","mv-permisssions","mv-rel","mv-value"],lazy:{locale:()=>document.documentElement.lang||"en-GB"}}});["toNode","isProxy","route","parent","property","mavo","groupedBy","as"].forEach((t=>{e.lazy(i,t,(()=>Symbol(t)))})),Object.defineProperty(i.all,"length",{get:function(){return Object.keys(this).length}});{let t=i.selectors={init:"[mv-app], [data-mv-app]",property:"[property]",specificProperty:e=>`[property=${e}]`,group:"[typeof], [mv-group]",primitive:"[property]:not([typeof]):not([mv-group])",childGroup:"[typeof][property], [mv-group][property]",multiple:"[mv-multiple]",formControl:"input, select, option, textarea",textInput:["text","email","url","tel","search","number"].map((e=>`input[type=${e}]`)).join(", ")+", input:not([type]), textarea",ui:".mv-ui",container:{tr:"table",option:"select"}};e.extend(i.selectors,{item:t.multiple+", "+t.group,output:t.specificProperty("output")+", .mv-output"})}if(e.each(i.polyfillsNeeded,((e,t)=>{t||i.polyfills.push(e)})),i.ready=i.thenAll(i.dependencies),i.inited=i.promise(),await i.defer(),0<i.polyfills.length){var r="https://cdn.polyfill.io/v2/polyfill-min.js?unknown=polyfill&features="+i.polyfills.map((e=>e+"|gated")).join(",");i.dependencies.push(e.include(r))}await e.ready(),Mavo.attributeStartsWith("data-mv-").forEach((e=>{let t=e.ownerElement,i=e.name.replace("data-","");Mavo.setAttributeShy(t,i,e.value)})),t(i.selectors.init).forEach((function(e){i.get(e)||e.setAttribute("mv-progress","Loading")})),await i.ready,i.init(),i.inited.resolve()}(Bliss,Bliss.$),function(e,t){function i(){var e=r.getTarget();const i="mv-target-within";for(t(".mv-target-within").forEach((e=>e.classList.remove(i)));e?.classList;)e.classList.add(i),e=e.parentNode}var r=e.extend(Mavo,{load:(t,i=document.currentScript?.src??location)=>e.load(t,i),readFile:(e,t="DataURL")=>{var i=new FileReader;return new Promise(((r,s)=>{i.onload=()=>r(i.result),i.onerror=i.onabort=s,i["readAs"+t](e)}))},toJSON:e=>{if(null===e)return"";if("string"==typeof e)return e;try{return JSON.stringify(e,null,"\t")}catch(e){return e}},safeToJSON:function(e){var t=new WeakSet;return JSON.stringify(e,((e,i)=>{if("object"==typeof i&&null!==i){if(t.has(i))return;t.add(i)}return i}))},isPlainObject:t=>"object"===e.type(t)&&"Object"===Object.getPrototypeOf(t).constructor?.name,primitivify:(e,t)=>(e&&(t&&"object"==typeof t&&(Object.assign(e,t),t=Mavo.value(t)),e.valueOf=e.toJSON=e[Symbol.toPrimitive]=()=>t),e),objectify:(t,i)=>{var s=Mavo.value(t);if("object"!=typeof t||null===t){if(null===t)t={[Symbol.toStringTag]:"Null",toJSON:()=>null};else{var a=t.constructor;(t=new a(s))[Symbol.toStringTag]=a.name}r.primitivify(t,s)}return e.extend(t,i)},value:e=>e?.valueOf?e.valueOf():e,toArray:e=>void 0===e?[]:Array.isArray(e)?e:[e],delete:(e,t,i)=>{do{var r=e&&e.indexOf(t);-1<r&&e.splice(r,1)}while(-1<r&&i)},pushUnique:(e,t)=>{-1===e.indexOf(t)&&e.push(t)},union:(e,t)=>e instanceof Set&&t?(t.forEach((t=>e.add(t))),e):new Set([...e||[],...t||[]]),filter:(e,t)=>{for(var i=0;i<e.length;i++)t(e[i])||(e.splice(i,1),i--)},is:function(e,...t){for(let i=0;i<t.length;i++)if(t?.[i]?.matches?.(r.selectors[e]))return!0;return!1},getStyle:(e,t)=>{if(e)return getComputedStyle(e).getPropertyValue(t)?.trim()},data:function(e,t,i){if(!e)return null;var s,a=r.elementData.get(e)||{};return 2==arguments.length?s=a[t]:void 0===i?delete a[t]:s=a[t]=i,r.elementData.set(e,a),s},elementData:new WeakMap,elementPath:function(e,t){if(Array.isArray(t)){var i=(n=t).reduce(((e,t)=>e.children[t>>0]||e),e),r=n[n.length-1];if(r!=r>>0){var s=+(r+"").split(".")[1];0>r>>0&&(i=i.firstChild,s--);for(var a=0;a<s;a++)i=i.nextSibling}return i}for(var n=[],o=t;o&&o!=e;o=o.parentNode){for(var l=0,h=o===t&&1!==t.nodeType,u=(s=h?1:0,o);u=u[`previous${h?"":"Element"}Sibling`];)h?(s++,1==u.nodeType&&(h=!1)):l++;0<s&&(l=l-1+"."+s),n.unshift(l)}return o?n:null},revocably:{add:function(e,t){var i=r.revocably.isRemoved(e);return i?.parentNode?i.parentNode.replaceChild(e,i):e&&t&&!e.parentNode&&("function"==typeof t?t(e):t.appendChild(e)),i},remove:function(e,t){if(e){var i=r.data(e,"commentstub");return i||(t=t||e.id||e.className||e.nodeName,i=r.data(e,"commentstub",document.createComment(t))),e.parentNode&&e.parentNode.replaceChild(i,e),i}},isRemoved:function(e){if(!e||e.parentNode)return!1;var t=r.data(e,"commentstub");return!!t?.parentNode&&t},setAttribute:function(e,t,i){void 0===r.data(e,"attribute-"+t)&&r.data(e,"attribute-"+t,e.getAttribute(t)),e.setAttribute(t,i)},restoreAttribute:function(t,i){var s=r.data(t,"attribute-"+i);void 0!==s&&(e.toggleAttribute(t,i,s),r.data(t,"attribute-"+i,void 0))}},inView:{is:e=>{var t=e.getBoundingClientRect();return(0<=t.bottom&&t.bottom<=innerHeight||0<=t.top&&t.top<=innerHeight)&&(0<=t.right&&t.right<=innerWidth||0<=t.left&&t.left<=innerWidth)},when:(t,i=`${innerHeight/2}px ${innerWidth/2}px`)=>{var s=r.inView.observer=r.inView.observer||new IntersectionObserver((function(t,i){t.forEach((t=>{0<t.intersectionRatio&&(i.unobserve(t.target),e.fire(t.target,"mv-inview",{entry:t}))}))}),{rootMargin:i});return new Promise((e=>{r.is(t)&&e(),s.observe(t);var i=r=>{t.removeEventListener("mv-inview",i),r.stopPropagation(),e()};t.addEventListener("mv-inview",i)}))}},scrollIntoViewIfNeeded:e=>{e&&!Mavo.inView.is(e)&&e.scrollIntoView({behavior:"smooth"})},setAttributeShy:function(e,t,i){e.hasAttribute(t)||e.setAttribute(t,i)},getAttribute:function(e,...t){for(let i,r,s=0;i=t[s];s++)if(r=e.getAttribute(i),r)return r;return null},getClosestAttribute:function(e,t){return e.closest(`[${t}]`)?.getAttribute(t)??null},getTarget:function(){var e=location.hash.substr(1);return document.getElementById(e)},XPath:function(e,t=document){var i,r=t.ownerDocument||t,s=[];if(r.evaluate)for(var a=r.evaluate(e,t,null,XPathResult.ANY_TYPE,null);i=a.iterateNext();)s.push(i);return s},attributeStartsWith:function(e,t=document.documentElement){return r.XPath(`.//@*[starts-with(name(), "${e}")]`,t)},getAttributes:function(e,t){return e.getAttributeNames().filter((e=>t.test(e)))},in:function(e,t){if(t)return"object"==typeof t&&e in t||void 0!==t[e]},getCanonicalProperty:function(e,t){if(e&&(t||0===t)){if(r.in(t,e))return t;if(t.toLowerCase){var i=t.toLowerCase();if(r.in(i,e))return i;var s=Object.keys(e),a=s.map((e=>e.toLowerCase())).indexOf(i);if(-1<a)return s[a]}}},subset:function(t,i,r){if(3==arguments.length){if(i.length){var s=i[i.length-1],a=e.value(t,...i.slice(0,-1));return Array.isArray(a)&&Array.isArray(r)?a.splice(s,1,...r):a&&(a[i[i.length-1]]=r),t}return r}return"object"==typeof t&&i?.length?i.reduce(((e,t,r)=>{var s={},a=Mavo.Functions.get(e,t,s);return i[r]=Array.isArray(s.property)?s.property[0]:s.property,void 0===a&&s.query&&(a={[s.query.property]:s.query.value}),a}),t):t},clone:function(e){return e&&"object"==typeof e?JSON.parse(r.safeToJSON(e)):e},shallowClone:function(t){return t&&"object"==typeof t?Array.isArray(t)?[...t]:e.extend({},t):t},debounce:function(e,t){if(!t)return e;var i,r=null;return function(){var s=this,a=arguments;i=function(){e.apply(s,a),removeEventListener("beforeunload",i)},clearTimeout(r),r=setTimeout(i,t),addEventListener("beforeunload",i)}},escapeRegExp:e=>e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),observeResize:function(e,t){if(self.ResizeObserver){var i=null,r=t instanceof ResizeObserver?t:new ResizeObserver((e=>{var r=e[e.length-1].contentRect;i&&i.width==r.width&&i.height==r.height||(t(e),i=r)}));return r.observe(e),r}},Observer:class{constructor(e,t,i,r={}){i instanceof MutationObserver&&(this.observer=i),this.observer=this.observer||new MutationObserver(i),this.callback=i,this.update(e,t,r),this.run()}update(t,i,r){this.element=t,this.attribute=i,this.options=e.extend({},r),void 0!==r&&(r.attributes||r.childList||r.characterData)||(this.attribute&&Object.assign(this.options,{attributes:!0,attributeFilter:"all"==this.attribute?void 0:Mavo.toArray(this.attribute),attributeOldValue:!!r.oldValue}),(!this.attribute||"all"==this.attribute)&&Object.assign(this.options,{characterData:!0,childList:!0,subtree:!0,characterDataOldValue:!!r.oldValue})),this.observer?.running&&(this.stop(),this.run())}flush(){let e=this.observer?.takeRecords();e&&this.callback(e)}stop(){return this.observer?.disconnect(),this.running=!1,this}run(){return this.observer&&(this.observer.observe(this.element,this.options),this.running=!0),this}pause(){this.runOnResume=this.running,this.stop()}resume(){!1!==this.runOnResume&&this.run(),delete this.runOnResume}destroy(){this.stop(),this.observer=this.element=null}},rr:function(e){return e(),e},wrap:(e,t)=>0>e?t-1:e>=t?0:e,options:e=>{var t={};return e.trim().match(/(?:\\[,;]|[^,;])+/g)?.forEach((e=>{if(e){var i=(e=e.trim().replace(/\\([,;])/g,"$1")).match(/^\s*((?:\\:|[^:])+?)\s*:\s*(.+)$/);i?t[i[1].replace(/\\:/g,":")]=i[2]:t[e]=!0}})),t},BucketMap:class{constructor({arrays:e=!1}={}){this.map=new Map,this[Symbol.iterator]=this.map[Symbol.iterator],this.arrays=e}set(e,t){var i;this.arrays?(i=this.map.get(e)||[]).push(t):(i=this.map.get(e)||new Set).add(t);this.map.set(e,i)}delete(e,t){if(2==arguments.length){var i=this.map.get(e);i&&(this.arrays?r.delete(i,t):i.delete(t))}else this.map.delete(e)}forEach(...e){return this.map.forEach(...e)}}});r.Observers=class extends Map{constructor({observer:e,callback:t}={}){super();let i=r.Observers;this.callback=t||i.callback,this.observer=e||(i.observer=i.observer||new MutationObserver(this.callback))}applyRecord(e){for(let[t,i]of this.entries())r.Observers.matchesRecord(t,e)&&(i.call(this,{node:Mavo.Node.get(e.target,!0),element:e.target,type:e.type,attribute:e.attributeName,record:e}),t.once&&this.unobserve(t,i))}static matchesRecord(e,t){if(!1===e.active)return!1;let i=t.target;if(e.selector&&!i.matches?.(e.selector))return!1;if(e.attribute){if("attributes"!==t.type)return!1;if(!0!==e.attribute&&e.attribute!==t.attributeName&&!e.attribute.includes?.(t.attributeName))return!1}else if("attributes"===t.type&&!1===e.attribute)return!1;return!e.element||(!1===e.deep?i===e.element:e.element.contains(i))}flush(){let e=this.observer.takeRecords();e&&this.callback(e)}observe(e={},t){return this.set(e,t),t}unobserve(e,t){let i=this.find(e,t);for(let[e,t]of i.entries())this.delete(e)}pause(e){let t=this.find(e);for(let[e,i]of t.entries())e._active=!1!==e.active&&!1!==e._active,e.active=!1;return this.flush(),t}resume(e){e instanceof r.Observers||(e=this.find(e)),this.flush();for(let[t,i]of e.entries())t.active=t.active||t._active,delete t._active}find(e,t){let i=Object.keys(e),r=new Mavo.Observers;for(let[s,a]of this.entries())t&&t!==a||i.every((t=>s[t]===e[t]))&&r.set(s,a);return r}},r.Observers.callback=e=>{if(0!==this.size)for(let t of e)r.observers.applyRecord(t)},e.proxy=e.classProps.proxy=e.overload((function(e,t,i){return Object.defineProperty(e,t,{get:function(){return this[i][t]},set:function(e){this[i][t]=e},configurable:!0,enumerable:!0}),e})),document.addEventListener("mv-load",i),addEventListener("hashchange",i),Mavo.observe({attribute:"id"},i)}(Bliss,Bliss.$),function(e,t){var i=Mavo.Locale=e.Class({constructor:function(e,t){this.lang=e,this.phrases={},this.extend(t)},get fallback(){return i.all[this.baseLang]?i.all[this.baseLang]:this===i.default?void 0:i.default},extend:function(t){e.extend(this.phrases,t)},phrase:function(e,t){var i=e.toLowerCase(),r=this.phrases[i];if(void 0===r&&this.fallback&&(r=this.fallback.phrase(i)),void 0===r)r=i.replace(/\b-\b/g," ");else if(t){var s=r.match(/\{\w+(?=\})/g)?.map((e=>e.slice(1)))??[];Mavo.Functions.unique(s).forEach((e=>{e in t&&(r=r.replace(RegExp(`{${e}}`,"gi"),t[e]))}))}return r},live:{lang:function(e){this.baseLang=i.getBaseLang(e),e==this.baseLang&&(this.baseLang=null)}},static:{all:{},register:function(e,t){i.all[e]?i.all[e].extend(t):i.all[e]=new i(e,t)},match:function(e=""){return i.all[e]||i.all[i.getBaseLang(e)]},get:function(e){return i.match(e)||i.default},getBaseLang:function(e){return e.split("-")[0]},lazy:{default:()=>i.match(Mavo.locale)||i.all.en}}});Mavo.prototype._=function(e,t){return this.locale&&e?this.locale.phrase(e,t):e},Mavo.ready.then((()=>{t("datalist.mv-phrases[lang]").forEach((e=>{var i=t("option",e).reduce(((e,t)=>(e[t.value]=t.textContent.trim(),e)),{});Mavo.Locale.register(e.lang,i)}))}))}(Bliss,Bliss.$),Mavo.Locale.register("en",{second:"second",seconds:"seconds",minute:"minute",minutes:"minutes",hour:"hour",hours:"hours",day:"day",days:"days",week:"week",weeks:"weeks",month:"month",months:"months",year:"year",years:"years",edit:"Edit",editing:"Editing",save:"Save",import:"Import",export:"Export",logout:"Logout",login:"Login",loading:"Loading",uploading:"Uploading",saving:"Saving",dismiss:"Dismiss","logged-in-as":"Logged in to {id} as ","login-to":"Login to {id}","error-uploading":"Error uploading file","cannot-load-uploaded-file":"Cannot load uploaded file",filename:"Filename?","problem-saving":"Problem saving data","problem-loading":"Problem loading data","cannot-parse":"Can’t understand this file","http-error":"HTTP error {status}: {statusText}","cant-connect":"Can’t connect to the Internet","add-item":"Add {name}","add-item-before":"Add new {name} before","add-item-after":"Add new {name} after","drag-to-reorder":"Drag to reorder {name}","delete-item":"Delete this {name}","item-deleted":"{name} deleted","n-items":"{n} {name} items",undo:"Undo","gh-updated-file":"Updated {name}","gh-login-fork-options":"You have your own copy of this page, would you like to use it?","gh-use-my-fork":"Yes, show me my data."}),function(e,t){Mavo.attributes.push("mv-plugins");var i=Mavo.Plugins={loaded:{},async load(){if(i.plugins=new Set,t("[mv-plugins]").forEach((e=>{e.getAttribute("mv-plugins").trim().split(/\s+/).forEach((e=>i.plugins.add(e)))})),!i.plugins.size)return;let r=await fetch(i.url+"/plugins.json"),s=(await r.json()).plugin;return Mavo.thenAll(s.filter((e=>i.plugins.has(e.id))).map((t=>{if(i.loaded[t.id])return Promise.resolve();var r=`mavo-${t.id}.js`;if(t.repo)var s=`https://cdn.jsdelivr.net/gh/${t.repo}@master/${r}`;else s=`${i.url}/${t.id}/${r}`;return e.include(i.loaded[t.id],s)})))},register:function(t,r={}){if(!i.loaded[t]){for(let t in Mavo.hooks.add(r.hooks),r.extend){let i="Mavo"==t?Mavo:Mavo[t];"function"===e.type(i)?e.Class(i,r.extend[t]):e.extend(i,r.extend[t])}var s=[];if(r.ready&&s.push(r.ready),r.dependencies){var a=document.currentScript?document.currentScript.src:location,n=r.dependencies.map((e=>Mavo.load(e,a)));s.push(...n)}s.length&&Mavo.dependencies.push(...s),i.loaded[t]=r,r.init&&Promise.all(s).then((()=>r.init()))}},url:"https://plugins.mavo.io"}}(Bliss,Bliss.$),function(e,t){var i=Math.max;Mavo.attributes.push("mv-bar");var r=Mavo.UI.Bar=e.Class({constructor:function(t){if(this.mavo=t,this.element=e(".mv-bar",this.mavo.element),this.template=this.mavo.element.getAttribute("mv-bar")||"",this.element)for(let t in this.custom=!0,this.template+=" "+(this.element.getAttribute("mv-bar")||""),this.template=this.template.trim(),r.controls)this[t]=e(`.mv-${t}`,this.element),this[t]&&(this.template=this.template||"with",this.template+=` ${t}`);else this.element=e.create({className:"mv-bar mv-ui",start:this.mavo.element,innerHTML:"<button>&nbsp;</button>"});for(let t in this.element.classList.contains("mv-compact")&&(this.noResize=!0),this.controls=r.getControls(this.template),this.controls.length&&(this.targetHeight=this.element.offsetHeight),this.custom||(this.element.innerHTML=""),this.controls.forEach((t=>{let i=r.controls[t];for(var s in this[t]&&this[t].remove(),i.create?this[t]=i.create.call(this.mavo,this[t]):!this[t]&&(this[t]=e.create("button",{type:"button",className:`mv-${t}`,textContent:this.mavo._(t)})),this.add(t),i.permission?this.permissions.can(i.permission,(()=>{this.toggle(t,!i.condition||i.condition.call(this.mavo))}),(()=>{this.remove(t)})):i.condition&&!i.condition.call(this.mavo)&&this.remove(t),i.events)e.bind(this[t],s,i.events[s].bind(this.mavo))})),r.controls){let i=r.controls[t];i.action&&e.delegate(this.mavo.element,"click",".mv-"+t,(e=>{(!i.permission||this.permissions.is(i.permission))&&(i.action.call(this.mavo),e.preventDefault())}))}this.controls.length&&!this.noResize&&(this.resize(),self.ResizeObserver&&(this.resizeObserver=Mavo.observeResize(this.element,(()=>{this.resize()}))))},resize:function(){return this.targetHeight?(this.resizeObserver?.disconnect(),this.element.classList.remove("mv-compact","mv-tiny"),t("button, .mv-button",this.element).forEach((e=>{e.title===e.textContent&&(e.title="")})),this.element.offsetHeight>1.6*this.targetHeight&&(this.element.classList.add("mv-compact"),this.element.offsetHeight>1.2*this.targetHeight&&(this.element.classList.add("mv-tiny"),t("button, .mv-button",this.element).forEach((e=>{e.title||(e.title=e.textContent)})))),void this.resizeObserver?.observe(this.element)):void(this.targetHeight=this.element.offsetHeight)},add:function(e){var t=r.controls[e];t.prepare&&t.prepare.call(this.mavo),Mavo.revocably.add(this[e],this.element),this.resizeObserver||this.noResize||requestAnimationFrame((()=>this.resize()))},remove:function(e){var t=r.controls[e];Mavo.revocably.remove(this[e],"mv-"+e),t.cleanup&&t.cleanup.call(this.mavo),this.resizeObserver||this.noResize||requestAnimationFrame((()=>this.resize()))},toggle:function(e,t){return this[t?"add":"remove"](e)},proxy:{permissions:"mavo"},destroy(){this.resizeObserver.disconnect(),this.resizeObserver=null},static:{getControls:function(e){var t=Object.keys(r.controls);if(e&&(e=e.trim())){if("none"==e)return[];var s=/^with\s|\b(yes|no)-\w+\b/.test(e),a=(e=e.replace(/\byes-|^with\s+/g,"")).split(/\s+/);return a=Mavo.Functions.unique(a.reverse()).reverse(),s?t.filter((e=>{var t=a.lastIndexOf(e),s=a.lastIndexOf("no-"+e),n=t>i(-1,s),o=s>i(-1,t);return n||!r.controls[e].optional&&!o})):a}return t.filter((e=>!r.controls[e].optional))},controls:{status:{create:function(t){return t||e.create({className:"mv-status"})},prepare:function(){var t=this.primaryBackend;if(t?.user){var i=t.user,r=[i.name||""];i.avatar&&r.unshift(e.create("img",{className:"mv-avatar",src:i.avatar})," "),i.url&&(r=[e.create("a",{href:i.url,target:"_blank",contents:r})]),this.bar.status.textContent="",e.contents(this.bar.status,[{tag:"span",innerHTML:this._("logged-in-as",t)}," ",...r])}},permission:"logout"},edit:{action:function(){this.editing?(this.done(),this.bar.edit.textContent=this._("edit")):(this.edit(),this.bar.edit.textContent=this._("editing"))},permission:["edit","add","delete"],cleanup:function(){this.editing&&(this.done(),this.bar?.edit&&(this.bar.edit.textContent=this._("edit")))},condition:function(){return this.needsEdit}},save:{action:function(){this.save()},events:{"mouseenter focus":function(){this.element.classList.add("mv-highlight-unsaved")},"mouseleave blur":function(){this.element.classList.remove("mv-highlight-unsaved")}},permission:"save",condition:function(){return!this.autoSave||0<this.autoSaveDelay}},export:{create:function(t){var i;return(i=t?t.matches("a")?t:e.create("a",{className:"mv-button",around:t}):e.create("a",{className:"mv-export mv-button",textContent:this._("export")})).setAttribute("download",this.id+".json"),i},events:{mousedown:function(){this.bar.export.href="data:application/json;charset=UTF-8,"+encodeURIComponent(this.toJSON())}},permission:"edit",optional:!0},import:{create:function(t){var i=t||e.create("span",{role:"button",tabIndex:"0",className:"mv-import mv-button",textContent:this._("import"),events:{focus:()=>{r.focus()}}}),r=e.create("input",{type:"file",inside:i,events:{change:t=>{var i=t.target.files[0];if(i){var r=e.extend(new FileReader,{onload:()=>{this.inProgress=!1;try{var e=JSON.parse(r.result);this.render(e)}catch(e){this.error(this._("cannot-parse"))}},onerror:()=>{this.error(this._("problem-loading"))}});this.inProgress=this._("uploading"),r.readAsText(i)}}}});return i},optional:!0},login:{action:function(){this.primaryBackend.login()},permission:"login"},logout:{action:function(){this.primaryBackend.logout()},permission:"logout"}}}})}(Bliss,Bliss.$),function(e){Mavo.UI.Message=e.Class({constructor:function(t,i,r={}){if(this.mavo=t,this.message=i,this.closed=Mavo.promise(),this.options=r,this.element=e.create({className:"mv-ui mv-message"+(r.type?" mv-"+r.type:""),["string"==e.type(this.message)?"innerHTML":"contents"]:this.message,events:{click:()=>Mavo.scrollIntoViewIfNeeded(this.mavo.element)},[this.mavo.bar?"after":"start"]:(this.mavo.bar||this.mavo).element}),r.style&&e.style(this.element,r.style),r.classes&&this.element.classList.add(...r.classes.split(/\s+/)),"error"==r.type?this.element.setAttribute("role","alert"):this.element.setAttribute("aria-live","polite"),r.dismiss=r.dismiss||{},"string"==typeof r.dismiss||Array.isArray(r.dismiss)){var s={};Mavo.toArray(r.dismiss).forEach((e=>{s[e]=!0})),r.dismiss=s}if(r.dismiss.button&&e.create("button",{type:"button",className:"mv-close mv-ui",textContent:"×",events:{click:()=>this.close()},start:this.element,title:this.mavo._("dismiss")}),r.dismiss.timeout){var a="number"==typeof r.dismiss.timeout?r.dismiss.timeout:5e3;e.bind(this.element,{mouseenter:()=>clearTimeout(this.closeTimeout),mouseleave:Mavo.rr((()=>this.closeTimeout=setTimeout((()=>this.close()),a)))})}r.dismiss.submit&&this.element.addEventListener("submit",(e=>{e.preventDefault(),this.close(e.target)}))},async close(t){clearTimeout(this.closeTimeout);var i=this.element.style.transition?1e3*parseFloat(window.getComputedStyle(this.element,null).transitionDuration):400;await e.transition(this.element,{opacity:0},i),e.remove(this.element),this.closed.resolve(t)}})}(Bliss,Bliss.$),function(e){var t=Mavo.Permissions=e.Class({constructor:function(i){this.triggers=[],this.hooks=new e.Hooks,this.parentChanged=t.prototype.parentChanged.bind(this),this.set(i)},set:function(e){for(var t in e)this[t]=e[t]},on:function(e){return Mavo.toArray(e).forEach((e=>this[e]=!0)),this},off:function(e){return(e=Array.isArray(e)?e:[e]).forEach((e=>this[e]=!1)),this},can:function(e,t,i){this.observe(e,!0,t),i&&this.cannot(e,i)},cannot:function(e,t){this.observe(e,!1,t)},observe:function(e,t,i){e=Mavo.toArray(e),this.is(e,t)&&i(),this.triggers.push({actions:e,value:t,callback:i,active:!0})},is:function(e,t=!0){var i=Mavo.toArray(e).map((e=>!!this[e])).reduce(((e,t)=>e||t));return t?i:!i},onchange:function(e){this.hooks.add("change",e),t.actions.forEach((t=>{e.call(this,{action:t,value:this[t]})}))},parentChanged:function(t={}){void 0!==this["_"+t.action]||t.from==t.value||(this.fireTriggers(t.action),this.hooks.run("change",e.extend({context:this},t)))},changed:function(e,t,i){(t=!!t)==(i=!!i)||(this["_"+e]=t,this.fireTriggers(e),this.hooks.run("change",{action:e,value:t,from:i,context:this}))},fireTriggers:function(e){this.triggers.forEach((t=>{var i=this.is(t.actions,t.value);t.active&&-1<t.actions.indexOf(e)&&i?(t.active=!1,t.callback()):!i&&(t.active=!0)}))},or:function(e){return t.actions.forEach((t=>{this[t]=this[t]||e[t]})),this},live:{parent:function(e){var i=this._parent;i==e||(this._parent=e,i&&Mavo.delete(i.hooks.change,this.parentChanged),t.actions.forEach((t=>{this.parentChanged({action:t,value:e?e[t]:void 0,from:i?i[t]:void 0})})),e&&e.onchange(this.parentChanged))}},static:{actions:[],register:function(i,r){return Array.isArray(i)?void i.forEach((e=>t.register(e,r))):(e.live(t.prototype,i,{get:function(){var e=this["_"+i];return void 0===e&&this.parent?this.parent[i]:e},set:function(e,t){r&&r.call(this,e,t),this.changed(i,e,t)}}),void t.actions.push(i))}}});t.register(["read","save"]),t.register("login",(function(e){e&&this.logout&&(this.logout=!1)})),t.register("logout",(function(e){e&&this.login&&(this.login=!1)})),t.register("edit",(function(e){e&&(this.add=this.delete=!0)})),t.register(["add","delete"],(function(e){e||(this.edit=!1)}))}(Bliss,Bliss.$),function(e){var t=Math.min,i=Mavo.Backend=e.Class({constructor:function(e,t={}){this.update(e,t),this.permissions=new Mavo.Permissions},update:function(e,t={}){this.source=e,this.url=new URL(this.source,Mavo.base),this.options=t,this.mavo=t.mavo,this.format=Mavo.Formats.create(t.format,this),(this.constructor.key??t.key)&&(this.key=t.key??this.constructor.key)},async get(t=new URL(this.url)){"data:"!=t.protocol&&!1!==this.constructor.useCache&&t.searchParams.set("timestamp",Date.now());try{return(await e.fetch(t.href)).responseText}catch(e){return null}},async load(){await this.ready;let e=await this.get();return"string"==typeof e?(e=e.replace(/^\ufeff/,""),this.format.parse(e)):e},async store(e,{path:t,format:i=this.format}={}){await this.ready;var r="string"==typeof e?e:await i.stringify(e);return await this.put(r,t),{data:e,serialized:r}},ready:Promise.resolve(),login:()=>Promise.resolve(),logout:()=>Promise.resolve(),put:()=>Promise.reject(),isAuthenticated:function(){return!!this.accessToken},oAuthParams:()=>"",toString:function(){return`${this.id} (${this.url})`},equals:function(e){return e===this||e&&this.id==e.id&&this.source==e.source},request:function(t,i,r="GET",s={}){if((s=e.extend({},s)).method=s.method||r,s.responseType=s.responseType||"json",s.headers=e.extend({"Content-Type":"application/json; charset=utf-8"},s.headers||{}),this.isAuthenticated()&&(s.headers.Authorization=s.headers.Authorization||`Bearer ${this.accessToken}`),s.data=i,t=new URL(t,this.constructor.apiDomain),"GET"==s.method&&!1!==this.constructor.useCache&&t.searchParams.set("timestamp",Date.now()),"object"===e.type(s.data))if("GET"==s.method){for(let e in s.data){let i=void 0===s.data[e]?"delete":"set";t.searchParams[i](e,s.data[e])}delete s.data}else s.data=JSON.stringify(s.data);return e.fetch(t,s).catch((e=>e?.xhr?Promise.reject(e.xhr):void this.mavo.error("Something went wrong while connecting to "+this.id,e))).then((e=>"HEAD"==s.method?e:e.response))},oAuthenticate:function(e){return this.ready.then((()=>this.isAuthenticated()?Promise.resolve():new Promise(((i,r)=>{var s=this.id.toLowerCase();if(e)this.accessToken=localStorage[`mavo:${s}token`],this.accessToken&&i(this.accessToken);else{var a={width:t(1e3,innerWidth-100),height:t(800,innerHeight-100)};a.top=(screen.height-a.height)/2,a.left=(screen.width-a.width)/2;var n={url:location.href,backend:this.id};this.authPopup=open(`${this.constructor.oAuth}?client_id=${this.key}&state=${encodeURIComponent(JSON.stringify(n))}`+this.oAuthParams(),"popup",`width=${a.width},height=${a.height},left=${a.left},top=${a.top}`),!this.authPopup&&(this.mavo.error("Login popup was blocked! Please check your popup blocker settings."),r(Error("Login popup was blocked! Please check your popup blocker settings."))),addEventListener("message",(e=>{if(e.source===this.authPopup)for(var t in e.data.backend==this.id&&(this.accessToken=localStorage[`mavo:${s}token`]=e.data.token),this.accessToken||r(Error("Authentication error")),i(this.accessToken),Mavo.all){var a=Mavo.all[t].primaryBackend;a&&a.id===this.id&&a!==this&&!a.isAuthenticated()&&a.login(!0)}}))}}))))},oAuthLogout:function(){if(this.isAuthenticated()){var t=this.id.toLowerCase();localStorage.removeItem(`mavo:${t}token`),delete this.accessToken,this.permissions.off(["edit","add","delete","save"]).on("login"),e.fire(this.mavo.element,"mv-logout",{backend:this})}return Promise.resolve()},static:{create:function(e,t={},r){let s;return t.type&&(s=Mavo.Functions.get(i,t.type)),e&&!s&&(s=i.types.find((i=>i.test(e,t)))||i.Remote),s&&r?.constructor===s&&r.constructor.prototype.hasOwnProperty("update")?(r.update(e,t),r):s?new s(e,t):null},types:[],register:function(e){return i[e.prototype.id]=e,i.types.push(e),e}}});i.register(e.Class({id:"Element",extends:i,constructor:function(){this.permissions.on(["read","edit","save"])},update:function(t,i){this.super.update.call(this,t,i),this.element=e(this.source)||e.create("script",{type:"application/json",id:this.source.slice(1),inside:document.body})},get:function(){return Promise.resolve(this.element.textContent)},put:function(e){return Promise.resolve(this.element.textContent=e)},static:{test:e=>0===e.indexOf("#")}})),i.register(e.Class({id:"Remote",extends:i,constructor:function(){this.permissions.on("read")},static:{test:()=>!1}})),i.register(e.Class({extends:i,id:"Local",constructor:function(){this.permissions.on(["read","edit","save"]),this.key=this.mavo.id},get:function(){return Promise[this.key in localStorage?"resolve":"reject"](localStorage[this.key])},put:function(e){return e?localStorage[this.key]=e:delete localStorage[this.key],Promise.resolve(e)},static:{test:e=>"local"==e}}))}(Bliss,Bliss.$),function(e){var t=Mavo.Formats={},i=t.Base=e.Class({abstract:!0,constructor:function(e){this.backend=e},proxy:{mavo:"backend"},parse:function(e){return this.constructor.parse(e,this)},stringify:function(e){return this.constructor.stringify(e,this)},static:{parse:e=>Promise.resolve(e),stringify:e=>Promise.resolve(e),extensions:[],dependencies:[],ready:function(){return Promise.all(this.dependencies.map((t=>e.include(t.test(),t.url))))}}}),r=(t.JSON=e.Class({extends:t.Base,static:{parse:e=>Promise.resolve(e?JSON.parse(e):null),stringify:e=>Promise.resolve(Mavo.toJSON(e)),extensions:[".json",".jsonld"]}}),t.Text=e.Class({extends:t.Base,constructor:function(){this.property=this.mavo.root.getNames("Primitive")[0]},static:{extensions:[".txt"],parse:(e,t)=>Promise.resolve({[t?t.property:"content"]:e}),stringify:(e,t)=>Promise.resolve(e[t?t.property:"content"])}}),t.CSV=e.Class({extends:t.Base,constructor:function(){this.property=this.mavo.root.getNames("Collection")[0],this.options=e.extend({},t.CSV.defaultOptions)},static:{extensions:[".csv",".tsv"],defaultOptions:{header:!0,dynamicTyping:!0,skipEmptyLines:!0},dependencies:[{test:()=>self.Papa,url:"https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.4/papaparse-min.js"}],ready:i.ready,parse:async(e,t)=>{await r.ready();var i=Papa.parse(e,r.defaultOptions),s=t?t.property:"content";if(t&&(t.options.delimiter=i.meta.delimiter,t.options.linebreak=i.meta.linebreak),i.meta.aborted)throw i.meta.errors.pop();return{[s]:i.data}},stringify:async(e,t)=>{await r.ready();var i=t?t.property:"content",s=t?t.options:r.defaultOptions;return Papa.unparse(e[i],s)}}}));Object.defineProperty(t,"create",{value:function(e,i){if(e&&"object"==typeof e)return e;if("string"==typeof e)for(var r in e=e.toLowerCase(),t){var s=t[r];if(r.toLowerCase()==e)return new s(i)}if(!e){var a=(i.url?i.url.pathname:i.source).match(/\.\w+$/)?.[0]??".json";s=t.JSON;for(var r in t)-1<t[r].extensions.indexOf(a)&&(s=t[r]);return new s(i)}}})}(Bliss,Bliss.$),function(e,t){var i=Mavo.Node=class{constructor(t,r,s={}){if(!t||!r)throw new Error("Mavo.Node constructor requires an element argument and a mavo object");var a={context:this,options:s};this.uid=i.all.push(this)-1,this.property=null,this.element=t,this.isHelperVariable=this.element.matches("meta"),e.extend(this,a.options),i.elements.set(t,[...i.elements.get(this.element)||[],this]),this.mavo=r,this.group=this.parent=this.parentGroup=a.options.group,this.template=a.options.template,this.alias=this.element.getAttribute("mv-alias"),this.template?this.template.copies.push(this):this.copies=[],this.fromTemplate("property","type","storage","path")||(this.property=i.getProperty(t),this.type=Mavo.Group.normalize(t),this.storage=this.element.getAttribute("mv-storage"),this.path=this.getPath()),this.modes=this.element.getAttribute("mv-mode"),Mavo.hooks.run("node-init-start",a),this.mode=Mavo.getStyle(this.element,"--mv-mode")||"read",this.collection=a.options.collection,this.collection&&(this.group=this.parentGroup=this.collection.parentGroup);var n=this.template;if(n?.expressions&&(this.expressions=n.expressions.map((e=>new Mavo.DOMExpression({template:e,item:this,mavo:this.mavo})))),this instanceof Mavo.Group||this.collection){var o=Mavo.DOMExpression.search(this.element).filter((e=>"mv-value"==e.originalAttribute))[0];o&&(o.mavoNode=this,this.expressionText=o,this.storage=this.storage||"none",this.modes="read",this.collection&&(this.collection.expressions=[...this.collection.expressions||[],o],o.mavoNode=this.collection,this.collection.storage=this.collection.storage||"none",this.collection.modes="read"))}Mavo.hooks.run("node-init-end",a)}get editing(){return"edit"==this.mode}get isRoot(){return!this.property}get name(){return Mavo.Functions.readable(this.property||this.type).toLowerCase()}get saved(){return"none"!==this.storage}get properties(){return Object.keys(this.liveData.data[Mavo.route])}postInit(){"edit"==this.modes&&this.edit()}destroy(){this.template&&Mavo.delete(this.template.copies,this),this.expressions&&this.expressions.forEach((e=>e.destroy())),this.itembar&&this.itembar.destroy(),delete i.all[this.uid],this.propagate("destroy")}getLiveData(){return this.liveData.proxy}isDataNull(e={}){var t={context:this,options:e,result:!this.saved&&!e.live};return Mavo.hooks.run("node-isdatanull",t),t.result}walk(e,t=[],i={}){var r=(t,s)=>{if(!1!==(a=e(t,s)))for(let e in t.children){let n=t.children[e];var a;if(n instanceof Mavo.Node)if(!1===(a=r.call(n,n,[...s,e]))&&!i.descentReturn)return!1}return!1!==a};return r(this,t)}walkUp(e){for(var t=this;t=t.parentGroup;){var i=e(t);if(void 0!==i)return i}}edit({force:t}={}){return this.mode="edit",!(!t&&"edit"!=this.mode)&&(e.fire(this.element,"mv-edit",{mavo:this.mavo,node:this}),void Mavo.hooks.run("node-edit-end",this))}done({force:t}={}){return this.mode=Mavo.getStyle(this.element.parentNode,"--mv-mode")||"read",!(!t&&"read"!=this.mode)&&(e.unbind(this.element,".mavo:edit"),e.fire(this.element,"mv-done",{mavo:this.mavo,node:this}),this.propagate("done"),void Mavo.hooks.run("node-done-end",this))}save(){this.unsavedChanges=!1,this.propagate("save")}propagate(e){for(let t in this.children){let i=this.children[t];i instanceof Mavo.Node&&("function"==typeof e?e.call(i,i):e in i&&i[e]())}}fromTemplate(...e){return this.template&&e.forEach((e=>this[e]=this.template[e])),!!this.template}async render(t,i={}){if(i.live=i.live||Mavo.in(Mavo.isProxy,t),i.root=i.root||this,delete this.pending,"promise"===e.type(t)){let e=this.pending=t;try{t=await e}catch(e){t=e}if(this.pending!==e)return;delete this.pending}i.live&&(t=Mavo.clone(t)),this.oldData=this.data,this.data=t,i.live||(t=Mavo.subset(t,this.inPath));var r={context:this,data:t,options:i};if(Mavo.hooks.run("node-render-start",r),!this.isHelperVariable)if(!Array.isArray(this.children)&&Array.isArray(r.data)){if(this.isRoot){var s=this.children.main instanceof Mavo.Collection?"main":this.getNames(((e,t)=>t instanceof Mavo.Collection&&!t.expressions?.[0]?.isDynamicObject))[0];s&&(r.data={[s]:r.data})}this.isRoot&&s||(this.inPath.push("0"),r.data=r.data[0])}else 1==this.childrenNames?.length&&this.childrenNames[0]===this.property&&null!==r.data&&Mavo.isPlainObject(r.data)&&(r.data=r.data[this.property]);this===i.root&&(this.expressionsEnabled=!1);var a=this.editing;a&&this.done();var n=this.dataRender(r.data,i);return a&&this.edit(),this===i.root&&(this.save(),this.expressionsEnabled=!0,n&&requestAnimationFrame((()=>this.mavo.expressions.update(this)))),Mavo.hooks.run("node-render-end",r),n}dataChanged(t,i={}){var r=e.extend({action:t,property:this.property,mavo:this.mavo,node:this},i);e.fire(i.element||this.element,"mv-change",r),this.mavo.changed(r)}toString(){return`#${this.uid}: ${this.constructor.name} (${this.property})`}getClosestCollection(){var e=this.closestItem;return e?e.collection:null}getClosestItem(){return Array.isArray(this.collection?.children)?this:this.parentGroup?.closestItem||null}getPath(){var e=this.parent?.path||[];return this.property?[...e,this.property]:e}pathFrom(e){for(var t=this.path,i=e.path,r=0;r<t.length&&i[r]==t[r];r++);return t.slice(r)}getDescendant(e){return e.reduce(((e,t)=>e.children[t]),this)}getCousin(e,t={}){if(!this.closestCollection)return null;var i=this.closestCollection,r=Math.abs(e),s=0>e?-1:1;if(i.length<r+1)return null;var a=this.closestItem.index+e;t.wrap&&(a=Mavo.wrap(a,i.length));for(var n,o=0;o<i.length;o++){n=a+o*s,t.wrap&&(n=Mavo.wrap(n,i.length));var l=i.children[n];if(l)break}if(!l||l==this.closestItem)return null;if(this.collection)return l;var h=this.pathFrom(this.closestItem);return l.getDescendant(h)}contains(e){do{if(e===this)return!0;e=e.parent}while(e);return!1}eval(e,t){return new Mavo.Expression(e).eval(this.getLiveData(),t)}static create(e,t,i={}){return Mavo.is("multiple",e)&&!i.collection?new Mavo.Collection(e,t,i):new(Mavo[Mavo.is("group",e)?"Group":"Primitive"])(e,t,i)}static getProperty(e){var t=e.getAttribute("property")||e.getAttribute("itemprop");if(!t){var r=e.getAttribute("mv-multiple");e.hasAttribute("property")&&(!(t=r||e.name||e.id||e.classList[0])&&(t=i.generatePropertyName(null===r?"prop":"collection",e)))}return t&&e.setAttribute("property",t),t}static generatePropertyName(t,i=document.documentElement){for(var r,s=i.closest(Mavo.selectors.init),a="";1e4>a;a++)if(r=t+a,!e(Mavo.selectors.specificProperty(r),s))return r}static get(e,t){var r=(i.elements.get(e)||[]).filter((e=>!Array.isArray(e.children)));return 2>r.length||!t?r[0]:r[0]instanceof Mavo.Group?r[1]:void 0}static getClosest(e,t){var r;do{r=i.get(e,t)}while(!r&&(e=e.parentNode));return r}static getClosestItem(e){var t=i.getClosest(e);return t instanceof Mavo.Primitive&&!t.collection?t.parent:t}static children(e){var i=Mavo.Node.get(e);return i?[i]:(i=t(Mavo.selectors.property,e).map((e=>Mavo.Node.get(e))).filter((t=>!e.contains(t.parentGroup.element))).map((e=>e.collection||e)),Mavo.Functions.unique(i))}};e.Class(i,{toJSON:Mavo.prototype.toJSON,lazy:{closestCollection:function(){return this.getClosestCollection()},closestItem:function(){return this.getClosestItem()},inPath:function(){var e=this instanceof Mavo.Collection?"mv-multiple-path":"mv-path";return(this.element.getAttribute(e)||"").split("/").filter((e=>e.length))}},live:{store:function(t){e.toggleAttribute(this.element,"mv-storage",t)},unsavedChanges:function(e){return!e||this.saved&&this.editing||(e=!1),Array.isArray(this.children)||this.element.classList.toggle("mv-unsaved-changes",e),e},mode:function(t){if(this._mode!=t){if(this.modes&&t!=this.modes&&(t=this.modes),this._mode=t,!Array.isArray(this.children)&&-1<[null,"","read","edit"].indexOf(this.element.getAttribute("mv-mode"))){var i=this.modes||"edit"==t;let r=Mavo.observers.pause({attribute:"mv-mode"});e.toggleAttribute(this.element,"mv-mode",t,i),Mavo.observers.resume(r)}return t}},modes:function(e){return e&&"read"!=e&&"edit"!=e?null:(this._modes=e,void(e&&this.mode!=e&&(this.mode=e)))},collection:function(e){this.parent=e||this.parentGroup},index:function(e){this._index!==e&&(this._index=e,this.liveData.updateKey())},expressionsEnabled:{get:function(){return!1!==this._expressionsEnabled&&(!this.parent||this.parent.expressionsEnabled)}}},static:{all:[],elements:new WeakMap}}),Mavo.observe({attribute:"mv-storage"},(function({node:e}){e&&(e.storage=e.element.getAttribute("mv-storage"))}))}(Bliss,Bliss.$),function(e,t){var i=Mavo.Group=class extends Mavo.Node{constructor(e,i,r){super(e,i,r),this.children={},this.group=this,Mavo.hooks.run("group-init-start",this),Mavo.Primitive.getValueAttribute(this.element)&&(this.children[this.property]=new Mavo.Primitive(this.element,this.mavo,{group:this}));var s=t(Mavo.selectors.property+", "+Mavo.selectors.multiple,this.element).filter((e=>this.element===(e.parentNode.closest(Mavo.selectors.childGroup)||this.mavo.element))),a={};s.forEach((e=>{var t=Mavo.Node.getProperty(e);"multiple"!==a[t]&&(a[t]=Mavo.is("multiple",e)?"multiple":(a[t]||0)+1)})),s.forEach((e=>{var t=Mavo.Node.getProperty(e),i={template:this.template?this.template.children[t]:null,group:this},r=a[t];if("multiple"===r){var s=this.children[t];s instanceof Mavo.Collection?s.add(e):Mavo.is("multiple",e)?(this.children[t]=new Mavo.Collection(e,this.mavo,i),(s||[]).forEach(((e,i)=>this.children[t].add(e,i)))):this.children[t]=[...s||[],e]}else 1<r?this.children[t]?this.children[t].add(e):this.children[t]=new Mavo.ImplicitCollection(e,this.mavo,i):this.children[t]=Mavo.Node.create(e,this.mavo,i)})),this.childrenNames=Object.keys(this.children),this.vocab=Mavo.getClosestAttribute(this.element,"vocab"),this.postInit(),Mavo.hooks.run("group-init-end",this)}get isRoot(){return!this.property}getNames(e="Node"){var t="function"==typeof e?e:(t,i)=>i instanceof Mavo[e];return Object.keys(this.children).filter((e=>t(e,this.children[e])))}getData(e={}){var t={context:this,options:e};if(this.isDataNull(e))return null;for(var r in t.data=Mavo.shallowClone(Mavo.subset(this.data,this.inPath))||{},this.children){var s=this.children[r];if(s.saved)var a=s.getData(t.options);s.saved&&null!==Mavo.value(a)?t.data[s.property]=a:delete t.data[s.property]}return this.childrenNames.length||this.isRoot||this.collection?1===this.childrenNames.length&&this.property in this.children?t.data=t.data[this.property]:t.data&&"object"==typeof t.data&&(this.type&&this.type!=i.DEFAULT_TYPE&&(t.data["@type"]=this.type),this.vocab&&(t.data["@context"]=this.vocab)):t.data=null,t.data=Mavo.subset(this.data,this.inPath,t.data),Mavo.hooks.run("node-getdata-end",t),t.data}edit(e={}){return!1!==super.edit()&&Promise.all(Object.keys(this.children).map((t=>this.children[t].edit(e))))}dataRender(t,i={}){if(!t)return;let r,s,a,n=!1;if("object"!=typeof t){s=!0;let i=this.property;if(!(this.property in this.children)){let r=e.type(t),s=e=>(this.children[e]instanceof Mavo.Primitive)+(this.children[e].datatype==r);i=Object.keys(this.children).filter((e=>!this.children[e].expressionText)).sort(((e,t)=>s(e)-s(t))).reverse()[0]}i||(i=this.property,r=!0),t={[i]:t},this.data=Mavo.subset(this.data,this.inPath,t)}if(this.propagate((r=>{let s=t[r.property];if(r.alias){let i=r.alias.split(" ");for(let n,o=0;o<i.length;o++)if(n=i[o],void 0!==t[n]){r.currentAlias=n,a=a||e.extend({},t),s=t[r.currentAlias];break}}n=r.render(s,i)||n})),a&&this.propagate((e=>{e.currentAlias&&(t[e.property]=a[e.currentAlias],!(e.currentAlias in this.children)&&delete t[e.currentAlias])})),!s||r){let e=Mavo.subset(this.oldData,this.inPath);for(let i in t)if(!(i in this.children)){let r=t[i];n=n||t[i]!==this.liveData.data[i],this.liveData.set(i,r),"object"==typeof r||e&&e[i]==r||this.dataChanged("propertychange",{property:i})}}return n}static normalize(e){if(Mavo.is("group",e)){var t=Mavo.getAttribute(e,"typeof","mv-group")||i.DEFAULT_TYPE;return e.setAttribute("typeof",t),t}return null}};e.Class(i,{lazy:{liveData:function(){return new Mavo.Data(this,{})}},static:{all:new WeakMap,DEFAULT_TYPE:"Item"}})}(Bliss,Bliss.$),async function(e,t){var i=Mavo.Primitive=class extends Mavo.Node{constructor(t,r,s){if(super(t,r,s),this.liveData=new Mavo.Data(this),this.fromTemplate("config","attribute","templateValue","originalEditor")||(this.config=i.getConfig(t),this.attribute=this.config.attribute,this.attribute&&!document.xmlVersion&&(this.attribute=this.attribute.toLowerCase())),this.datatype=this.config.datatype,"modes"in this.config&&(this.modes=this.config.modes,this.element.setAttribute("mv-mode",this.config.modes)),Mavo.hooks.run("primitive-init-start",this),this.expressionText=this.expressionText||Mavo.DOMExpression.search(this.element,this.attribute),this.expressionText&&!this.expressionText.mavoNode&&(this.expressionText.primitive=this,this.storage=this.storage||"none",this.modes="read",this.element.setAttribute("aria-live","polite")),this.config.init&&this.config.init.call(this,this.element),this.config.initOnce&&!this.config.initOnce.called&&(this.config.initOnce.call(this,this.element),this.config.initOnce.called=!0),this.config.changeEvents&&e.bind(this.element,this.config.changeEvents,(e=>{e.target===this.element&&(this.value=this.getValue())})),this.expressionText)this.setValue(this.expressionText.value,{silent:!0});else{if(this.element.hasAttribute("aria-label")?this.label=this.element.getAttribute("aria-label"):(this.label=Mavo.Functions.readable(this.property),this.pauseObserver(),this.element.setAttribute("aria-label",this.label),this.resumeObserver()),this.element.hasAttribute("mv-editor")){this.originalEditorUpdated();let e=this.editorValue;this.datatype||"number"!=typeof e&&"boolean"!=typeof e||(this.datatype=typeof e)}this.templateValue=this.getValue(),this._default=this.element.getAttribute("mv-default"),null===this.default?(this._default=this.modes?this.templateValue:this.editorValue,this.defaultSource=this.modes?"template":"editor"):""===this.default?(this._default=this.templateValue,this.defaultSource="template"):(this.defaultExpression=Mavo.DOMExpression.search(this.element,"mv-default"),this.defaultExpression&&(this.defaultExpression.output=e=>this.default=e),this.defaultSource="attribute");var a=!this.template||this.template.templateValue!=this.templateValue||"edit"==this.modes;this.initialValue=void 0===this.default&&a?this.templateValue:this.default,void 0===this.initialValue&&(this.initialValue=this.emptyValue),this.setValue(this.initialValue,{silent:!0})}this.postInit(),Mavo.hooks.run("primitive-init-end",this)}get editorValue(){let t=this.editor||this.originalEditor;if(t){if(t.matches(Mavo.selectors.formControl))return i.getValue(t,{datatype:this.datatype});let r=e(Mavo.selectors.output+", "+Mavo.selectors.formControl,t);if(r)return i.getValue(r)}}set editorValue(t){if(this.config.setEditorValue&&"boolean"!==this.datatype)return this.config.setEditorValue.call(this,t);if(this.editor)if(this.editor.matches(Mavo.selectors.formControl)){if(this.editor.matches("select")){let i=[...this.editor.options].find((e=>e.value==t))?.textContent;void 0===i&&e.create("option",{className:"mv-volatile",textContent:t,inside:this.editor,selected:!0,disabled:!0})}i.setValue(this.editor,t,{config:this.editorDefaults})}else{var r=e(Mavo.selectors.output+", "+Mavo.selectors.formControl,this.editor);r&&i.setValue(r,t)}}destroy(){super.destroy(),this.originalEditorObserver?.destroy()}isDataNull(e){return super.isDataNull(e)||null===this._value||void 0===this._value}getData(e={}){var t={context:this,options:e};return this.isDataNull(e)?null:(t.data=this.value,""!==t.data||this.templateValue&&this.initialValue===this.templateValue||(t.data=null),this.inPath.length&&(t.data=Mavo.subset(this.data,this.inPath,t.data)),Mavo.hooks.run("node-getdata-end",t),t.data)}get pausedObserver(){return 0<this.observerPauses?.length}pauseObserver(){Mavo.observers.flush(),this.observerPauses=this.observerPauses||[],this.observerPauses.push(1)}resumeObserver(){Mavo.observers.flush(),this.observerPauses?.pop?.()}save(){this.savedValue=this.value,this.unsavedChanges=!1}initEdit(){!this.editor&&this.originalEditor&&(this.editor=this.originalEditor.cloneNode(!0)),this.editorUpdated(),this.initEdit=null}generateDefaultEditor(){let t=this.config.editor;t&&"boolean"!=this.datatype||(t=Mavo.Elements.defaultConfig[this.datatype||"string"].editor),this.editor=e.create("function"===e.type(t)?t.call(this):t),this.editorValue=this.value}updateEditType(){let e=this.element.getAttribute("mv-edit-type")?.trim()??"auto";return"auto"===e&&(e=this.config.editType??"auto"),"auto"===e&&(e=this.attribute?"popup":"inline"),this.editType=e}editorUpdated(){this.editor||this.generateDefaultEditor(),e.bind(this.editor,{"input change":()=>{this.value=this.editorValue},"mv-change":t=>{"output"===t.property&&(t.stopPropagation(),e.fire(this.editor,"input"))}}),this.editor.matches("textarea")||this.editor.addEventListener("focus",(()=>{this.editor.select?.()})),"placeholder"in this.editor&&!this.editor.placeholder&&(this.editor.placeholder=`(${this.label})`);for(let e of Mavo.getAttributes(this.element,/^mv-editor-/)){let t=this.element.getAttribute(e);e=e.replace(/^mv-editor-/,""),this.editor.setAttribute(e,t)}}originalEditorUpdated(){let t=this.originalEditor,i=this.element.getAttribute("mv-editor");try{this.originalEditor=e(i)}catch(e){this.originalEditor=null}t===this.originalEditor||(this.originalEditor?(this.editor&&(this.editor=this.originalEditor.cloneNode(!0),this.setValue(this.value,{force:!0,silent:!0})),(!this.template||this.originalEditor!==this.template.originalEditor)&&(this.originalEditorObserver?.destroy(),this.originalEditorObserver=new Mavo.Observer(this.originalEditor,"all",(()=>{let e=[this];if(this.template){let t=this.copies.filter((e=>e.originalEditor===this.originalEditor));e.push(...t)}for(let t of e)"editor"==t.defaultSource&&(t.default=this.originalEditor.value),t.editor&&(t.editor=this.originalEditor.cloneNode(!0)),t.setValue(t.value,{force:!0,silent:!0})})))):this.editor&&(this.generateDefaultEditor(),this.editorUpdated()))}edit(t={}){let r=this.editing;if(!1===super.edit(t))return!1;if(!t.force&&r&&!this.initEdit)return!0;if("object"===e.type(this._value))return!1;if(r||(-1===this.element.tabIndex&&Mavo.revocably.setAttribute(this.element,"tabindex","0"),!this.modes&&e.bind(this.element,"click.mavo:edit",(e=>{this.editor.contains(e.target)||e.preventDefault()}))),this.closestCollection&&this.editor&&this.editor.matches(Mavo.selectors.textInput)){let t=this.editor.matches("textarea");t||e.bind(this.editor,"paste.mavo:edit",(t=>{if(this.closestCollection.editing&&t.clipboardData){let i=t.clipboardData.getData("text/plain");const r=/\r?\n|\r/;if(r.test(i)){t.preventDefault();let s=i.split(r);this.editor.setRangeText(s[0]),e.fire(this.editor,"input");let a=this.closestCollection,n=closestItem?.index||0;for(let e=1;e<s.length;e++){this.closestItem;let t=a.add(void 0,n+e);a.editItem(t),this.getCousin(e).render(s[e])}}}})),e.bind(this.editor,"keydown.mavo:edit",(e=>{if(this.closestCollection.editing)if("Enter"!=e.key||!e.shiftKey&&t){if("Backspace"==e.key&&(this.empty||e[Mavo.superKey])){let t=this.getCousin(1)||this.getCousin(-1);this.closestCollection.delete(this.closestItem),t&&(t.edit(),t.editor.focus()),e.preventDefault()}}else{if(this.bottomUp)return;let i=this.closestItem,r=this.closestCollection.add(void 0,i?.index+1);this.closestCollection.editItem(r);let s=this.getCousin(1);requestAnimationFrame((()=>{s.edit(),s.editor.focus()})),t&&e.preventDefault()}}))}if(this.config.edit)return this.config.edit.call(this),this.initEdit=null,!0;if(this.pauseObserver(),this.initEdit&&this.initEdit(),this.editor.classList.toggle("mv-editor","popup"!==this.editType),"popup"===this.editType){this.popup||(this.popup=new Mavo.UI.Popup(this)),this.popup.prepare();let t=["mousedown","focus","dragover","dragenter"].map((e=>e+".mavo:edit")).join(" ");e.bind(this.element,t,(()=>this.popup.show()))}else"inline"===this.editType&&(this.editor.isConnected||(this.editorValue=this.value,this.config.hasChildren?this.element.textContent="":i.setText(this.element,""),!this.contentExpression&&(this.contentExpression=Mavo.DOMExpression.search(this.element,null)),this.contentExpression&&(this.contentExpression.active=!1),this.element.prepend(this.editor)),this.collection||Mavo.revocably.restoreAttribute(this.element,"tabindex"));return this.resumeObserver(),!0}done(i){return!1!==super.done(i)&&(e.unbind(this.element,".mavo:edit"),this.pauseObserver(),this.config.done?void this.config.done.call(this):("popup"===this.editType?this.popup?.close():"inline"===this.editType&&this.editor&&(this.editor.remove(),this.contentExpression&&(this.contentExpression.active=!0,this.contentExpression.update()),this.setValue(this.editorValue,{silent:!0,force:!0})),this.editor?.matches("select")&&t(".mv-volatile",this.editor).forEach((e=>{e.selected||e.remove()})),this.resumeObserver(),void(!this.collection&&Mavo.revocably.restoreAttribute(this.element,"tabindex"))))}dataRender(t,{live:i,root:r}={}){var s=this._value;return"object"===e.type(t)&&(Symbol.toPrimitive in t?t=t[Symbol.toPrimitive]("default"):this.editing&&this.done()),void 0===t?!this.modes&&this.value===this.templateValue&&(this.value=this.closestCollection?this.default:this.templateValue):this.value=t,this._value!==s}find(e,t={}){if(this.property==e&&t.exclude!==this)return this}getValue(){return this.editing&&this.editor&&this.editor!==this.element?this.editorValue:i.getValue(this.element,{config:this.config,attribute:this.attribute,datatype:this.datatype})}setValue(e,t={}){void 0===e&&(e=null);let r=this.datatype;if(this.datatype||"number"!=typeof e&&"boolean"!=typeof e||(this.datatype=typeof e),e=i.safeCast(e,this.datatype),!t.force&&e===this._value&&r==this.datatype)return e;if(this.pauseObserver(),this.editor&&this.editorValue!=e&&(this.editorValue=e),"popup"==this.editType||!this.editor||this.editor!==document.activeElement&&!this.element.contains(this.editor))if(this.config.setValue)this.config.setValue.call(this,this.element,e);else if(!t.dataOnly){let t,r=this.originalEditor||this.editor;r?.matches("select")&&(t=[...r.options].find((t=>t.value==e))?.textContent),i.setValue(this.element,e,{config:this.config,attribute:this.attribute,datatype:this.datatype,presentational:t,node:this})}return this.empty=!e&&0!==e,this._value=e,this.liveData.update(),t.silent||(this.saved&&(this.unsavedChanges=this.mavo.unsavedChanges=!0),this.dataChanged("propertychange",{value:e})),this.resumeObserver(),e}dataChanged(e="propertychange",t){return super.dataChanged(e,t)}async upload(e,t=e.name){if(!this.mavo.uploadBackend||!self.FileReader)return;var i=URL.createObjectURL(e);this.pauseObserver(),this.element.setAttribute(this.attribute,i),this.resumeObserver();var r=(this.element.getAttribute("mv-upload-path")||"")+"/"+t;let s=await this.mavo.upload(e,r);var a=Mavo.getClosestAttribute(this.element,"mv-upload-url");a&&(s=new URL(r,new URL(a,location))+""),this.value=s,this.element.matches("a")||(this.pauseObserver(),this.element.setAttribute(this.attribute,i),this.resumeObserver())}createUploadPopup(t,i="file",r){var s={context:this,type:t,kind:i,ext:r,mainInput:e.create("input",{type:"url",placeholder:`http://example.com/${i}.${r}`,className:"mv-output","aria-label":`URL to ${i}`})};if(this.mavo.uploadBackend&&self.FileReader){var a=e=>e&&(!t||0===e.type.indexOf(t.replace("*","")));return s.events={paste:e=>{var r=Array.from(e.clipboardData.items).find((e=>"file"===e.kind)),s=r?.type.split("/")[1];if(r&&a(r)){var n=e.clipboardData.getData("text")||`pasted-${i}-${Date.now()}.${s}`,o=prompt(this.mavo._("filename"),n);""===o&&(o=n),null!==o&&(this.upload(r.getAsFile(),o,t),e.preventDefault())}},"drag dragstart dragend dragover dragenter dragleave drop":e=>{e.preventDefault(),e.stopPropagation()},"dragover dragenter":()=>{s.popup.classList.add("mv-dragover"),this.element.classList.add("mv-dragover")},"dragleave dragend drop":()=>{s.popup.classList.remove("mv-dragover"),this.element.classList.remove("mv-dragover")},drop:e=>{var t=e.dataTransfer.files[0];t&&a(t)&&this.upload(t)}},Mavo.hooks.run("primitive-createuploadpopup-beforecreate",s),s.popup=e.create({className:"mv-upload-popup",contents:[s.mainInput,{tag:"input",type:"file","aria-label":`Upload ${i}`,accept:t,events:{change:e=>{var t=e.target.files[0];t&&a(t)&&this.upload(t)}}},{className:"mv-tip",innerHTML:"<strong>Tip:</strong> You can also drag & drop or paste!"}],events:s.events}),e.bind(this.element,s.events),Mavo.hooks.run("primitive-createuploadpopup-beforereturn",s),s.popup}return s.mainInput}static getText(e){var t=e.nodeType===Node.TEXT_NODE?e:e.firstChild;return t?.nodeType===Node.TEXT_NODE?t.nodeValue:""}static setText(e,t){var i=e.nodeType===Node.TEXT_NODE?e:e.firstChild;i?.nodeType===Node.TEXT_NODE?i.nodeValue=t:e.prepend(t)}static getValueAttribute(e,t=Mavo.Elements.search(e)){var i=e.getAttribute("mv-attribute")||t.attribute;return i&&"null"!==i&&"none"!==i||(i=null),i}static safeCast(e,t){var r=i.cast(e,t);return"boolean"==t?!!e&&(!!("true"===e||0<e)||e):"number"==t?/^[-+]?[0-9.e]+$/i.test(e+"")?r:e:null==e?e:r}static cast(e,t){return"number"===t?+e:"boolean"===t?!!e:"string"===t?e+"":e}static getValue(e,{config:t,attribute:r,datatype:s}={}){return t||(t=i.getConfig(e,r)),r=t.attribute,s=t.datatype,t.getValue&&r==t.attribute?t.getValue(e):(a=r in e&&i.useProperty(e,r)?e[r]:r?e.getAttribute(r):e.getAttribute("content")||i.getText(e)||null,i.safeCast(a,s));var a}static getConfig(e,t,r){void 0===t&&(t=e.getAttribute("mv-attribute")||void 0),("null"==t||"none"==t)&&(t=null);var s=void 0===t||t==i.getValueAttribute(e);!r&&s&&(r=e.getAttribute("datatype")||void 0);var a=Mavo.Elements.search(e,t,r);return void 0===(a=Object.assign({},a)).attribute&&(a.attribute=t||null),void 0===a.datatype&&(a.datatype=r),a}static async setValue(t,r,s={}){if(i.pending.get(t)?.[s.attribute],"promise"===e.type(r)){i.pending.has(t)||i.pending.set(t,{});let e=r;i.pending.get(t)[s.attribute]=e;try{r=await e}catch(e){r=e}if(i.pending.get(t)[s.attribute]!==e)return;i.pending.get(t)?.[s.attribute]}if(1===t.nodeType&&(s.config||(s.config=i.getConfig(t,s.attribute)),s.attribute=void 0===s.attribute?s.config.attribute:s.attribute,s.datatype=void 0===s.datatype?s.config.datatype:s.datatype,s.config.setValue&&s.attribute==s.config.attribute))return s.config.setValue(t,r,s.attribute);if(null!==r||s.datatype||(r=""),s.attribute){if(s.attribute in t&&i.useProperty(t,s.attribute)&&t[s.attribute]!==r)try{t[s.attribute],t[s.attribute]=r}catch(e){}"boolean"==s.datatype?r!=t.hasAttribute(s.attribute)&&e.toggleAttribute(t,s.attribute,r,r):t.getAttribute(s.attribute)!=r&&t.setAttribute(s.attribute,r)}else{var a=s.presentational??i.format(r,s);s.node&&!s.config.hasChildren?i.setText(t,a):t.textContent=a,a!==r&&t.setAttribute&&t.setAttribute("content",r)}}static useProperty(e,t){return!(-1<["href","src"].indexOf(t))&&"http://www.w3.org/2000/svg"!=e.namespaceURI}static format(t,r={}){if("number"===e.type(t)||"number"==r.datatype){if(null===t)return"";if(!(r.attribute||r.element?.matches("style, pre")))return i.formatNumber(t)}return Array.isArray(t)?t.map(i.format).join(", "):"object"===e.type(t)?Mavo.toJSON(t):t}};e.Class(i,{lazy:{emptyValue:function(){switch(this.datatype){case"boolean":return!1;case"number":return 0}return""},editorDefaults:function(){return this.editor&&i.getConfig(this.editor)},editType:function(){return this.updateEditType()}},live:{editor:function(e){this._editor===e||(this._editor?.replaceWith(e),this._editor=e,"editor"===this.defaultSource&&(this.default=this.editorValue),this.editorUpdated())},default:function(e){this.value==this._default&&(this.value=e)},value:function(e){return this.setValue(e)},datatype:function(t){t!==this._datatype&&("boolean"==t&&!this.attribute&&(this.attribute=Mavo.Elements.defaultConfig.boolean.attribute),e.toggleAttribute(this.element,"datatype",t,t&&"string"!==t))},empty:function(t){let i=t&&!this.modes&&(!this.attribute||!e(Mavo.selectors.property,this.element))&&("boolean"!==this.datatype||this.attribute===Mavo.Elements.defaultConfig.boolean.attribute);this.element.classList.toggle("mv-empty",!!i)}},static:{all:new WeakMap,pending:new Map,lazy:{formatNumber:()=>{var e=new Intl.NumberFormat(Mavo.locale,{maximumFractionDigits:2});return function(t){return t===1/0||t===-1/0?0>t?"-∞":"∞":e.format(t)}}}}}),Mavo.observe({id:"primitive"},(function({node:e,type:t,attribute:i,record:r,element:s}){if(e instanceof Mavo.Primitive&&e.config&&!e.pausedObserver)if("mv-default"!==i||e.defaultExpression){if("aria-label"===i)e.label=s.getAttribute("aria-label"),Mavo.in("placeholder",e.editor)&&(e.editor.placeholder=`(${e.label})`);else if(i&&"mv-editor"===i)e.originalEditorUpdated();else if(i&&"mv-edit-type"===i){let t=e.editing;t&&e.done({force:!0}),e.updateEditType(),t&&e.edit({force:!0})}else if(i&&0===i.indexOf("mv-editor-"))e.editor?.setAttribute(i.slice(10),s.getAttribute(i));else if(!1!==e.config.observer){let r=e.config.subtree;r||e.editing&&"edit"!==e.modes||(r=i===e.attribute||e.config.observedAttributes?.includes(i)||"characterData"===t&&!e.attribute),r&&(e.value=e.getValue())}}else e.default=s.getAttribute("mv-default")})),await e.ready();let r=["checkbox","color","date","datetime-local","email","file","month","number","password","radio","range","search","submit","tel","text","time","url","week","datetime"],s=Mavo.attributeStartsWith("mv-edit-").filter((e=>"mv-edit-type"!==e.name||r.includes(e.value))).map((e=>e.name));Mavo.attributeStartsWith("mv-editor-");if(e("[mv-edit]")&&s.unshift("mv-edit"),0<s.length){let e=[...new Set(s)];for(let i of e){let e=i.replace(/^mv-edit(-|$)/,"mv-editor$1"),r=t(`[${i}]`);for(let t of r)Mavo.setAttributeShy(t,e,t.getAttribute(i))}}}(Bliss,Bliss.$),function(e){Mavo.UI.Popup=e.Class({constructor:function(t){this.primitive=t,this.position=()=>{var t=this.primitive.element.getBoundingClientRect(),i=t.left,r=t.bottom,s=!1;if(this.element.offsetHeight&&(this.height=this.element.getBoundingClientRect().height||this.height),this.height+r+20>innerHeight)if(20<t.top-this.height){s=!0;r=t.top-this.height-20}else r=innerHeight-this.height-20;this.element.classList.toggle("mv-point-down",s),e.style(this.element,{top:`${r}px`,left:`${i}px`})},this.element=e.create("div",{className:"mv-popup",hidden:!0,contents:{tag:"fieldset",contents:[{tag:"legend",textContent:this.primitive.label+":"},this.editor]},events:{keyup:e=>{(13==e.keyCode||27==e.keyCode)&&(this.element.contains(document.activeElement)&&this.primitive.element.focus(),e.stopPropagation(),this.hide())},transitionend:this.position}}),this.editor.matches("select")&&(this.editor.size=Math.min(10,this.editor.children.length)),this.hideCallback=e=>{this.element.contains(e.target)||this.primitive.element.contains(e.target)||this.hide()}},show:function(){e.unbind([this.primitive.element,this.element],".mavo:showpopup"),this.shown=!0,this.element.style.transition="none",this.element.removeAttribute("hidden"),this.position(),this.element.setAttribute("hidden",""),this.element.style.transition="",document.body.appendChild(this.element),setTimeout((()=>{this.element.removeAttribute("hidden")}),100),e.bind(document,"focus click",this.hideCallback,!0),window.addEventListener("scroll",this.position,{passive:!0})},hide:function(){e.unbind(document,"focus click",this.hideCallback,!0),window.removeEventListener("scroll",this.position,{passive:!0}),this.element.setAttribute("hidden",""),this.shown=!1,setTimeout((()=>{e.remove(this.element)}),1e3*parseFloat(getComputedStyle(this.element).transitionDuration)||400)},prepare:function(){e.bind(this.primitive.element,{"click.mavo:edit":()=>{this.show()},"keyup.mavo:edit":e=>{-1<[13,113].indexOf(e.keyCode)&&(this.show(),this.editor.focus())}}),this.element.contains(this.editor)||this.element.append(this.editor)},close:function(){this.hide(),e.unbind(this.primitive.element,".mavo:edit .mavo:preedit .mavo:showpopup")},proxy:{editor:"primitive"}})}(Bliss,Bliss.$),function(e,t){var i=Math.min,r=Math.max,s=Mavo.Elements={};Object.defineProperties(s,{register:{value:function(t,i){if("object"!=typeof arguments[0]){if(i.extend){var r=s[i.extend];i=e.extend(e.extend({},r),i)}if(-1<t.indexOf("@")){var a=t.split("@");i.selector=i.selector||a[0]||"*",void 0===i.attribute&&(i.attribute=a[1])}return i.selector=i.selector||t,i.id=t,Array.isArray(i.attribute)?i.attribute.forEach((r=>{var a=e.extend({},i);a.attribute=r,s[`${t}@${r}`]=a})):s[t]=i,s}for(let e in arguments[0])s.register(e,arguments[0][e])}},search:{value:function(t,i,r){var a=s.matches(t,i,r);0===a.length&&r&&(a=s.matches(t,i));var n=a[a.length-1];if(n)return n;var o=e.extend({},s.defaultConfig[r||"string"]);return o.attribute=void 0===i?o.attribute:i,o}},matches:{value:function(e,t,i){var r=[];for(var a in s){var n=s[a];if((void 0===t&&n.default||t===n.attribute)&&(void 0===i||"string"===i||i===n.datatype)){var o=n.selector||a;e.matches(o)&&(!n.test||n.test(e,t,i))&&r.push(n)}}return r}},isSVG:{value:e=>"http://www.w3.org/2000/svg"==e.namespaceURI},defaultConfig:{value:{string:{editor:{tag:"input"}},number:{editor:{tag:"input",type:"number"}},boolean:{attribute:"content",editor:{tag:"input",type:"checkbox"}}}}}),s.register({"@hidden":{datatype:"boolean"},"@y":{test:s.isSVG,datatype:"number"},"@x":{default:!0,test:s.isSVG,datatype:"number"},media:{default:!0,selector:"img, video, audio",attribute:"src",editor:function(){var e=this.element.nodeName.toLowerCase();return e="img"==e?"image":e,Mavo.setAttributeShy(this.element,"mv-upload-path",e+"s"),this.createUploadPopup(e+"/*",e,"png")}},"a, link":{default:!0,attribute:"href"},"a[mv-upload-path], link[mv-upload-path]":{default:!0,attribute:"href",editor:function(){var e=this.element.getAttribute("type"),t=e&&!/\/\*$/.test(e)?e.split("/")[1]:"pdf";return this.createUploadPopup(e,void 0,t)}},"video, audio":{attribute:["autoplay","buffered","loop"],datatype:"boolean"},details:{attribute:"open",datatype:"boolean"},"input, select, button, textarea":{attribute:"disabled",datatype:"boolean"},formControl:{selector:"input",default:!0,attribute:"value",modes:"edit",editType:"self",changeEvents:"input change",edit:()=>{},done:()=>{},init:function(){this._editor=this.element}},select:{extend:"formControl",selector:"select",subtree:!0},"select[multiple]":{extend:"select",selector:"select[multiple]",getValue:e=>Array.from(e.selectedOptions).map((e=>e.value)).join(),setValue:(e,t)=>{t=Array.isArray(t)?t:(t+"").split(/\s*,/),Array.from(e.options).forEach((e=>{e.selected=!1,(t=t.map((e=>e+""))).includes(e.value)&&(e.selected=!0)}))}},option:{attribute:null,modes:"read",default:!0},textarea:{extend:"formControl",selector:"textarea",attribute:null,getValue:e=>e.value,setValue:(e,t)=>e.value=t},formNumber:{extend:"formControl",selector:"input[type=range], input[type=number]",datatype:"number",setValue:function(t,i){t.value=i,t.setAttribute("value",i);var r=i>t.value?"max":"min";isNaN(i)||t.value==i||Mavo.data(t,"boundObserver")||(0===Mavo.observers.find({element:t,id:"oob"}).size&&Mavo.observe({id:"oob",element:t,attribute:r,once:!0},(()=>t.value=i)),requestAnimationFrame((()=>{e.bind(t,"input mv-change",(function i(){Mavo.unobserve({element:t,id:"oob"}),e.unbind(t,"input mv-change",i)}))})))},observedAttributes:["min","max"]},checkbox:{extend:"formControl",selector:"input[type=checkbox]",attribute:"checked",datatype:"boolean",changeEvents:"click"},"input[type=checkbox]":{attribute:"indeterminate",datatype:"boolean"},radio:{extend:"formControl",selector:"input[type=radio]",attribute:"checked",modes:"edit",getValue:t=>{if(t.form)return t.form[t.name].value;let i=e(`input[type=radio][name="${t.name}"]:checked`);return i&&i.value},setValue:(t,i)=>{if(t.form)return void(t.form[t.name].value=i);let r=e(`input[type=radio][name="${t.name}"][value="${i}"]`);r&&(r.checked=!0)},initOnce:function(){function e(e){e.name;for(let i of t(`input[type=radio][name="${e.name}"]`)){let e=Mavo.Node.get(i,!0);e&&(e.value=e.getValue())}}document.addEventListener("change",(t=>{t.target.matches("input[type=radio]")&&e(t.target)})),Mavo.observe({attribute:"value",selector:"input[type=radio]"},(t=>e(t.element)))},observedAttributes:["value"]},counter:{extend:"formControl",selector:"button, .counter",attribute:"mv-clicked",datatype:"number",init:function(e){"mv-clicked"===this.attribute&&(e.setAttribute("mv-clicked","0"),e.addEventListener("click",(()=>{let t=+e.getAttribute("mv-clicked")||0;this.value=++t})))}},"meter, progress":{default:!0,attribute:"value",datatype:"number",edit:function(){var t=+this.element.getAttribute("min")||0,s=+this.element.getAttribute("max")||1,a=s-t,n=+this.element.getAttribute("mv-editor-step")||(1<a?1:a/100);e.bind(this.element,"mousemove.mavo:edit",(e=>{var o=this.element.getBoundingClientRect().left,l=r(0,(e.clientX-o)/this.element.offsetWidth),h=t+a*l,u=h%n;h=r(t,i(h+=u>n/2?n-u:-u,s)),this.pauseObserver(),this.element.setAttribute("value",h),this.resumeObserver()})),e.bind(this.element,"mouseleave.mavo:edit",(()=>{this.pauseObserver(),this.element.setAttribute("value",this.value),this.resumeObserver()})),e.bind(this.element,"click.mavo:edit",(()=>{this.value=this.getValue()})),e.bind(this.element,"keydown.mavo:edit",(e=>{if(e.target==this.element&&(37==e.keyCode||39==e.keyCode)){var a=n*(39==e.keyCode?1:-1)*(e.shiftKey?10:1),o=this.value+a;o=r(t,i(o,s)),this.element.setAttribute("value",o),e.preventDefault()}}))},done:function(){e.unbind(this.element,".mavo:edit")},observedAttributes:["min","max"]},meta:{default:!0,attribute:"content"},block:{default:!0,selector:"p, div, dt, dd, h1, h2, h3, h4, h5, h6, article, section, address, pre",editor:function(){var t=getComputedStyle(this.element),i=0===t.display.indexOf("inline")?"input":"textarea",r=e.create(i);if("textarea"==i){var s=this.element.offsetWidth;s&&(r.width=s),r.style.whiteSpace={normal:"pre-wrap",nowrap:"pre"}[t.whiteSpace]||"inherit"}return r},setEditorValue:function(e){this.datatype&&"string"!=this.datatype&&(e+="");var t=getComputedStyle(this.element);return e=e||"",-1<["normal","nowrap"].indexOf(t.whiteSpace)&&(e=e.replace(/\r?\n/g," ")),-1<["normal","nowrap","pre-line"].indexOf(t.whiteSpace)&&(e=e.replace(/^[ \t]+|[ \t]+$/gm,"").replace(/[ \t]+/g," ")),this.editor.value=e,!0}},time:{attribute:"datetime",default:!0,init:function(){if(!this.fromTemplate("dateType")){var e=Mavo.DOMExpression.search(this.element,null),t=this.element.getAttribute("datetime")||"YYYY-MM-DD";for(var i in this.config.dateTypes)if(this.config.dateTypes[i].test(t))break;this.dateType=i,e||(this.element.textContent=this.config.defaultFormats[this.dateType](this.property),this.mavo.expressions.extract(this.element,null),(e=Mavo.DOMExpression.search(this.element,null))&&this.mavo.treeBuilt.then((()=>{e.update()})))}},dateTypes:{month:/^[Y\d]{4}-[M\d]{2}$/i,time:/^[H\d]{2}:[M\d]{2}/i,"datetime-local":/^[Y\d]{4}-[M\d]{2}-[D\d]{2} [H\d]{2}:[Mi\d]{2}/i,date:/^[Y\d]{4}-[M\d]{2}-[D\d]{2}$/i},defaultFormats:{date:e=>`[day(${e})] [month(${e}, 'shortname')] [year(${e})]`,month:e=>`[month(${e}, 'name')] [year(${e})]`,time:e=>`[hour(${e}, '00')]:[minute(${e}, '00')]`,"datetime-local":function(e){return this.date(e)+" "+this.time(e)}},editor:function(){return{tag:"input",type:this.dateType}}},"circle@r":{default:!0,datatype:"number"},circle:{attribute:["cx","cy"],datatype:"number"},text:{default:!0,editType:"popup"},".mv-toggle":{default:!0,attribute:"aria-checked",datatype:"boolean",edit:function(){Mavo.revocably.setAttribute(this.element,"role","checkbox"),e.bind(this.element,"click.mavo:edit keyup.mavo:edit keydown.mavo:edit",(e=>{("click"==e.type||" "==e.key||"Enter"==e.key)&&("keydown"!=e.type&&(this.value=!this.value),e.preventDefault(),e.stopPropagation())}))},done:function(){Mavo.revocably.restoreAttribute(this.element,"role"),e.unbind(this.element,".mavo:edit")}}})}(Bliss,Bliss.$),function(e,t){Mavo.attributes.push("mv-multiple","mv-order","mv-accepts","mv-initial-items","mv-like");var i=Mavo.Collection=class extends Mavo.Node{constructor(e,t,i){super(e,t,i),this.templateElement=this.element,this.children=[],this.liveData=new Mavo.Data(this,[]),this.marker=document.createComment("mv-marker"),Mavo.data(this.marker,"collection",this),this.templateElement.after(this.marker),this.addButton=this.createAddButton(),this.templateElement.hasAttribute("mv-like")&&Mavo.warn("@mv-like is deprecated and will be removed in the next version of Mavo"),this.mavo.root||!this.templateElement.hasAttribute("mv-like")?this.init():this.mavo.treeBuilt.then((()=>this.init()))}createAddButton(){var i=`button[class~="mv-add-${this.property}"]`,r=this.parentGroup.element,s=t(i,r).filter((e=>!this.templateElement.contains(e)&&!Mavo.data(e,"collection")))[0];return s?(s.compareDocumentPosition(this.marker)&Node.DOCUMENT_POSITION_FOLLOWING&&Mavo.setAttributeShy(this.templateElement,"mv-order","desc"),Mavo.revocably.remove(s)):s=e.create("button",{type:"button",className:"mv-ui",textContent:this.mavo._("add-item",this)}),s.classList.add("mv-add",`mv-add-${this.property}`),Mavo.data(s,"collection",this),Mavo.setAttributeShy(s,"mv-action",`add(${this.property})`),s}init(){if(!this.fromTemplate("templateElement","accepts","initialItems","like","likeNode")){if(this.like=this.templateElement.getAttribute("mv-like"),this.like){var e=[];this.mavo.walk((t=>{t instanceof i&&t.property===this.like&&t!==this&&e.push(t)})),0<e.length?(this.likeNode=e.sort(((e,t)=>e.pathFrom(this).length-t.pathFrom(this).length))[0],this.likeNode=this.likeNode.likeNode||this.likeNode,this.likeNode=this.likeNode.template||this.likeNode):this.like=null}this.accepts=this.templateElement.getAttribute("mv-accepts"),this.accepts=new Set(this.accepts?.split(/\s+/)),this.initialItems=+(this.templateElement.getAttribute("mv-initial-items")||(this.like?0:1)),this.templateElement=this.templateElement.cloneNode(!0)}if(this.likeNode){this.itemTemplate=this.likeNode.itemTemplate||this.likeNode;var t=this.likeNode.templateElement||this.likeNode.collection?.templateElement||this.likeNode.element;this.templateElement=t.cloneNode(!0),this.templateElement.setAttribute("property",this.property),this.accepts.size||(this.accepts=this.likeNode.accepts||this.accepts)}else if(0<this.initialItems||!this.template){var r=this.createItem(this.element);this.add(r,void 0,{silent:!0})}this.mavo.treeBuilt.then((()=>{if(this.initialItems){if(1<this.initialItems)for(let e=1;e<this.initialItems;e++)this.add()}else r?this.delete(r,{silent:!0}):this.element.remove()})),this.postInit(),Mavo.hooks.run("collection-init-end",this)}get length(){return this.children.length}getData(e={}){var t={context:this,options:e};return t.data=this.children.map((e=>e.getData(t.options))).filter((e=>null!==Mavo.value(e))),t.data=Mavo.subset(this.data,this.inPath,t.data),Mavo.hooks.run("node-getdata-end",t),t.data}createItem(e){e||(e=this.templateElement.cloneNode(!0));var t=this.itemTemplate||this.template?.itemTemplate||null,i=Mavo.Node.create(e,this.mavo,{collection:this,template:t,property:this.property,type:this.type});return this.itemTemplate||(this.itemTemplate=t||i),i}add(t,i,r={}){if((t=t instanceof Node?Mavo.Node.get(t)||this.createItem(t):t||this.createItem()).collection!=this){t.collection&&(t.collection.splice({remove:t}),t.collection.dataChanged("delete"));let e=t.getData(),i=t.editing;t.element.remove(),t.destroy(),t=this.createItem(),i&&this.editItem(t),t.render(e)}void 0===i&&(i=this.bottomUp?0:this.length);var s=this.children?.[i]?.element??this.marker;e.before(t.element,s);var a={context:this,item:t};return a.previousIndex=t.index,a.changed=this.splice({remove:a.item},{index:i,add:a.item}),this.mavo.expressions.active&&!r.silent&&requestAnimationFrame((()=>{a.changed.forEach((e=>{e.dataChanged(e==a.item&&void 0===a.previousIndex?"add":"move"),e.unsavedChanges=!0})),this.unsavedChanges=this.mavo.unsavedChanges=!0,this.mavo.expressions.update(a.item)})),Mavo.hooks.run("collection-add-end",a),a.item}splice(...e){e.forEach((e=>{void 0===e.index&&e.remove&&isNaN(e.remove)&&(e.index=this.children.indexOf(e.remove),e.remove=1)})),e.sort(((e,t)=>t.index-e.index));var t=[],i=[];e.forEach((e=>{-1<e.index&&(e.remove||e.add)&&(e.remove=e.remove||0,e.add=Mavo.toArray(e.add),i.push(...this.children.splice(e.index,+e.remove,...e.add)))})),i=new Set(i);for(let e,r=0;r<this.length;r++)e=this.children[r],i.delete(e),e&&e.index!==r&&(e.index=r,t.push(e));return i.forEach((e=>{e.expressions?.forEach((t=>{e.mavo.expressions.unregister(t)}))})),this.liveData.update(),t}async delete(t,{silent:i,undoable:r=!i,transition:s=!i,destroy:a=!r}={}){return t.element.classList.remove("mv-highlight"),this.splice({remove:t}),!i&&s&&(await e.transition(t.element,{opacity:0}),t.element.style.opacity=""),e.remove(t.element),i||(this.unsavedChanges=t.unsavedChanges=this.mavo.unsavedChanges=!0,t.collection.dataChanged("delete",{index:t.index})),r?this.mavo.setDeleted(t):a&&t.destroy(),t}move(e,t){var i=e.index+t+(0<t);i=Mavo.wrap(i,this.children.length+1),this.add(e,i)}editItem(e,t={}){e.preEdit?.resolve("abort");let i=t.immediately||Mavo.inView.is(e.element);return e.preEdit=Mavo.promise(i?Promise.resolve():Mavo.inView.when(e.element)),e.preEdit.then((i=>{if("abort"!==i)return e.itembar||(e.itembar=new Mavo.UI.Itembar(e)),e.itembar.add(),e.edit(t)}))}doneItem(e){e.itembar?.remove(),e.preEdit?.resolve("abort")}edit(t={}){if(!1===super.edit())return!1;if(!this.addButton.parentNode){var r=this.element.tagName.toLowerCase();if(r in Mavo.selectors.container)var s=this.marker.parentNode.closest(Mavo.selectors.container[r]);else if(this.bottomUp&&this.children[0])s=this.children[0].element;s=s||this.marker,Mavo.revocably.add(this.addButton,(t=>e[this.bottomUp?"before":"after"](t,s)))}return i.dragula.then((()=>{this.getDragula()})),Promise.all(this.children.map((e=>this.editItem(e,t))))}done(){return!1!==super.done()&&(Mavo.revocably.remove(this.addButton),void this.propagate((e=>this.doneItem(e))))}dataChanged(e,t={}){return t.element=t.element||this.marker,super.dataChanged(e,t)}dataRender(e,t={}){if(void 0!==e){e=null===e?[]:Mavo.toArray(e).filter((e=>null!==e));for(var i=!1,r=0;r<this.children.length;r++)s=this.children[r],r<e.length?i=s.render(e[r],t)||i:(i=!0,this.delete(s,{silent:!0}),r--);if(e.length>r){for(var s,a=document.createDocumentFragment(),n=r;n<e.length;n++){i=(s=this.createItem()).render(e[n],t)||i,this.children.push(s),s.index=n,a.appendChild(s.element);var o={context:this,item:s};Mavo.hooks.run("collection-add-end",o)}this.marker.before(a)}if(this.liveData.update(),e.length>r)for(n=r;n<this.children.length;n++)this.children[n].dataChanged("add");return i}}isCompatible(e){return e&&this.itemTemplate.constructor==e.itemTemplate.constructor&&(e===this||e.template==this||this.template==e||this.template&&this.template==e.template||-1<this.accepts.has(e.property))}destroy(){super.destroy(),this.dragula?.destroy(),this.dragula=null,this.propagate("destroy")}getDragula(){return this.dragula?this.dragula:this.template?(Mavo.pushUnique(this.template.getDragula().containers,this.marker.parentNode),this.dragula=this.template.dragula||this.template.getDragula()):(this.dragula=dragula({containers:[this.marker.parentNode],isContainer:e=>!!this.accepts.size&&Array.from(e.childNodes).some((e=>{var t=i.get(e);return t&&this.accepts.has(t.property)})),moves:(e,t,i)=>i.classList.contains("mv-drag-handle")&&i.closest(Mavo.selectors.multiple)==e,accepts:function(e,t,r,s){if(e.contains(t))return!1;var a=s?.previousElementSibling??t.lastElementChild,n=i.get(a)||i.get(s);return!!n&&Mavo.Node.get(e)?.collection.isCompatible(n)}}),this.dragula.on("drop",(e=>{var t=Mavo.Node.get(e),r=e.nextElementSibling,s=e.previousElementSibling,a=i.get(s)||i.get(r),n=Mavo.Node.get(s)||Mavo.Node.get(r);if(n&&n.collection!=a&&(n=null),!t.collection.isCompatible(a))return this.dragula.cancel(!0);var o=n?n.index+(n.element===s):a.length;a.add(t,o)})),i.dragulas.push(this.dragula),this.dragula)}getClosestCollection(){return this}static get(e){var t=Mavo.data(e,"collection");return t||(Mavo.Node.get(e)?.collection||null)}static async delete(e,t={}){if(0===(e=e.filter((e=>!!e.collection))).length)return[];if(1===e.length){return[await e[0].collection.delete(e[0],t)]}let i=new Mavo.BucketMap({arrays:!0}),r=new Set,s=e.map((async e=>{r.add(e.collection);let t=await e.collection.delete(e,{silent:!0,undoable:!1,destroy:!1});return t.unsavedChanges=!0,i.set(e.mavo,e),t})),a=await Promise.all(s);return!1!==t.silent&&(r.forEach((e=>{e.unsavedChanges=e.mavo.unsavedChanges=!0,e.dataChanged("delete")})),!1!==t.undoable&&i.forEach(((e,t)=>{t.setDeleted(...e)}))),a}};e.Class(i,{lazy:{bottomUp:function(){return/^desc\b/i.test(this.templateElement.getAttribute("mv-order"))}},static:{dragulas:[],lazy:{dragula:()=>e.include(self.dragula,"../../dist/js/dragula-min.js")}}})}(Bliss,Bliss.$),Bliss,Bliss.$,Mavo.ImplicitCollection=class extends Mavo.Node{constructor(e,t,i){super(e,t,i),this.children=[],this.liveData=new Mavo.Data(this,[]),this.add(e),this.postInit(),Mavo.hooks.run("implicit-collection-init-end",this)}get length(){return this.children.length}getData(e={}){var t={context:this,options:e,data:[]};if(this.children.forEach((i=>{i.isDataNull()||t.data.push(i.getData(e))})),this.data){var i=Mavo.toArray(Mavo.subset(this.data,this.inPath));i.length>t.data.length&&(t.data=t.data.concat(i.slice(t.data.length)))}return Array.isArray(t.data)&&1>=t.data.length&&(t.data=1===t.data.length?t.data[0]:null),t.data=Mavo.subset(this.data,this.inPath,t.data),Mavo.hooks.run("node-getdata-end",t),t.data}add(e){var t=Mavo.Node.create(e,this.mavo,{collection:this,template:this.template?.children?.[this.length]??null,property:this.property,type:this.type});return t.index=this.length,this.children.push(t),this.liveData.update(),t}edit(e={}){return!1!==super.edit()&&Promise.all(this.children.map((t=>t.edit(e))))}dataRender(e,t={}){if(void 0!==e){var i=(e=null===e?[]:Mavo.toArray(e).filter((e=>null!==e))).length!==this.liveData.length;this.children.forEach(((r,s)=>i=r.render(e?.[s],t)??i))}this.liveData.update()}},function(e,t){var i=Mavo.UI.Itembar=e.Class({constructor:function(i){if(this.item=i,this.element=t(`.mv-item-bar:not([mv-rel]), .mv-item-bar[mv-rel="${this.item.property}"]`,this.item.element).filter((e=>e.closest(Mavo.selectors.multiple)==this.item.element&&!Mavo.data(e,"item")))[0],!this.element&&this.item.template?.itembar)this.element=this.item.template.itembar.element.cloneNode(!0),this.dragHandle=e(".mv-drag-handle",this.element)||this.item.element;else{this.element=this.element||e.create({className:"mv-item-bar mv-ui"});var r=this.collection.bottomUp,s="$item"+(r?", $index + 1":""),a=[{tag:"button",type:"button",title:this.mavo._("delete-item",this.item),className:"mv-delete","mv-action":"delete($item)"},{tag:"button",type:"button",title:this.mavo._("add-item-"+(r?"after":"before"),this.item),className:"mv-add","mv-action":`if($cmd, add($item, ${s}), add(${s}))`}];this.item instanceof Mavo.Group?(this.dragHandle=e.create({tag:"button",type:"button",title:this.mavo._("drag-to-reorder",this.item),className:"mv-drag-handle"}),a.push(this.dragHandle)):this.dragHandle=this.item.element,e.set(this.element,{"mv-rel":this.item.property,contents:a})}this.element.setAttribute("hidden",""),e.bind([this.item.element,this.element],"focusin mouseover",this),e.bind(this.element,{mouseenter:()=>{this.item.element.classList.add("mv-highlight")},mouseleave:()=>{this.item.element.classList.remove("mv-highlight")}}),this.dragHandle.addEventListener("keydown",(e=>{e.target===this.dragHandle&&this.item.editing&&37<=e.keyCode&&40>=e.keyCode&&(this.collection.move(this.item,38>=e.keyCode?-1:1),e.stopPropagation(),e.preventDefault(),e.target.focus())})),this.dragHandle!==this.item.element&&this.dragHandle.addEventListener("click",(e=>e.target.focus())),Mavo.data(this.element,"item",this.item)},destroy:function(){this.hide()},show:function(t){i.visible.forEach((e=>{e!=this&&(!this.sticky||e.sticky)&&(clearTimeout(e.hideTimeout),e.hide(t,i.DELAY))})),i.visible.add(this),(this.element.hasAttribute("hidden")||t&&!this.sticky)&&(this.element.removeAttribute("hidden"),this.sticky=this.sticky||t,e.bind([this.item.element,this.element],"focusout mouseleave",this))},hide:function(t,r=0){(!this.sticky||t)&&(r?this.hideTimeout=setTimeout((()=>this.hide(t)),r):(this.element.setAttribute("hidden",""),e.unbind([this.item.element,this.element],"focusout mouseleave",this),this.sticky=!1,i.visible.delete(this)))},handleEvent:function(e){var t=-1===e.type.indexOf("mouse");this.isWithinItem(e.target)&&(clearTimeout(this.hideTimeout),-1<["mouseleave","focusout","blur"].indexOf(e.type)?!this.isWithinItem(e.relatedTarget)&&this.hide(t,i.DELAY):(this.show(t),e.stopPropagation()))},isWithinItem:function(e){if(!e)return!1;var t=e.closest(".mv-item-bar");return t?t===this.element:e.closest(Mavo.selectors.item)===this.item.element},add:function(){if(!this.element.parentNode&&!Mavo.revocably.add(this.element)){var t=this.item.element.nodeName.toLowerCase();if(t in i.container)var r=e(i.container[t],this.item.element);(r||this.item.element).appendChild(this.element)}this.dragHandle==this.item.element&&this.item.element.classList.add("mv-drag-handle")},remove:function(){Mavo.revocably.remove(this.element),this.dragHandle==this.item.element&&this.item.element.classList.remove("mv-drag-handle")},live:{sticky:function(e){this.element.classList.toggle("mv-sticky",e)}},proxy:{collection:"item",mavo:"item"},static:{DELAY:100,visible:new Set,container:{details:"summary"}}})}(Bliss,Bliss.$),function(){var e=Mavo.Expression=class{constructor(e,t={}){this.options=t,this.expression=e}eval(e=Mavo.Data.stub){if(Mavo.hooks.run("expression-eval-beforeeval",this),this.function instanceof Error)return this.function;try{return this.function(e)}catch(t){return this.error(`Something went wrong with the expression ${this.expression}`,t.message,`Data was: ${JSON.stringify(e)}`),Mavo.hooks.run("expression-eval-error",{context:this,error:t}),t}}error(e,...t){t=t.join("\n")}toString(){return this.expression}changedBy(t){return e.changedBy(this.identifiers,t)}};Bliss.Class(e,{live:{expression:function(e){try{this.function=Mavo.Script.compile(e,this.options)}catch(t){return this.error(`There is something wrong with the expression ${e}`,t.message,"Not an expression? See https://mavo.io/docs/expressions/#disabling-expressions for information on how to disable expressions."),Mavo.hooks.run("expression-compile-error",{context:this,error:t}),this.function=t,e}if(this.ast=this.options.ast,delete this.options.ast,this.ast){let e=new Set;Mavo.Script.walk(this.ast,((t,i)=>{"Identifier"===t.type&&"callee"!==i?e.add(t.name):"MemberExpression"===t.type&&(t.object.name&&e.add(t.object.name),e.add(t.property.name))})),this.identifiers=[...e]}}}}),e.Syntax=class{constructor(e,t){this.start=e,this.end=t,this.regex=RegExp(`${Mavo.escapeRegExp(e)}([\\S\\s]*?)${Mavo.escapeRegExp(t)}`,"gi")}test(e){return this.regex.lastIndex=0,this.regex.test(e)}tokenize(e){var t,i=[],r=0;for(this.regex.lastIndex=0;null!==(t=this.regex.exec(e));)t.index>r&&i.push(e.substring(r,t.index)),r=this.regex.lastIndex,/\S/.test(t[1])?i.push(new Mavo.Expression(t[1])):i.push(t[0]);return r<e.length&&i.push(e.substring(r)),i}static create(t){if(t){var i=t.getAttribute("mv-expressions");if(i)return i=i.trim(),/\s/.test(i)?new e.Syntax(...i.split(/\s+/)):e.Syntax.ESCAPE}}},e.Syntax.ESCAPE=-1,e.Syntax.default=new e.Syntax("[","]")}(),function(e){var t=Mavo.DOMExpression=e.Class({constructor:function(e={}){this.mavo=e.mavo,this.template=e.template?.template||e.template;for(let t of["item","path","syntax","fallback","attribute","originalAttribute","expression","parsed","identifiers"])this[t]=void 0===e[t]&&this.template?this.template[t]:e[t];if(this.node=e.node,this.node||(this.node=Mavo.elementPath(this.item.element,this.path)),this.element=this.node,this.attribute=this.attribute||null,Mavo.hooks.run("domexpression-init-start",this),"mv-value"==this.attribute){this.originalAttribute="mv-value",this.attribute=Mavo.Primitive.getValueAttribute(this.element),this.fallback=this.fallback||Mavo.Primitive.getValue(this.element,{attribute:this.attribute});var i=this.element.getAttribute("mv-value");this.element.removeAttribute("mv-value"),this.parsed=[new Mavo.Expression(i)],this.expression=this.syntax.start+i+this.syntax.end}if(3===this.node.nodeType&&this.element===this.node&&(this.element=this.node.parentNode,(!this.node.parentNode.children.length||this.attribute)&&(this.node=this.element,this.element.normalize())),!this.expression){if(this.attribute){var r=Element.prototype.getAttribute.call(this.node,this.attribute);this.expression=(r||"").trim()}else{if(this.node.normalize(),1===this.node.childNodes.length&&3===this.node?.firstChild?.nodeType){var s=this.node.firstChild.textContent.match(/^\s*|\s*$/g);s[1]&&(this.node.firstChild.splitText(this.node.firstChild.textContent.length-s[1].length),this.node.after(this.node.lastChild)),s[0]&&(this.node.firstChild.splitText(s[0].length),this.node.parentNode.insertBefore(this.node.firstChild,this.node))}this.expression=this.node.textContent}this.parsed=this.template?this.template.parsed:this.syntax.tokenize(this.expression)}this.oldValue=this.value=this.parsed.map((e=>e instanceof Mavo.Expression?"":e)),this.identifiers=this.identifiers||this.parsed.flatMap((e=>e.identifiers||[])),t.special.add(this),this.mavo.treeBuilt.then((()=>{this.template||this.item||(this.item=Mavo.Node.getClosestItem(this.element)),"mv-value"==this.originalAttribute&&this.mavoNode&&this.mavoNode==this.item.collection&&Mavo.delete(this.item.expressions,this),this.mavo.expressions.register(this),Mavo.hooks.run("domexpression-init-treebuilt",this)})),Mavo.hooks.run("domexpression-init-end",this),t.elements.set(this.element,[...t.elements.get(this.element)||[],this])},destroy:function(){t.special.delete(this),this.mavo.expressions.unregister(this)},get isDynamicObject(){return"mv-value"==this.originalAttribute&&this.mavoNode&&!(this.mavoNode instanceof Mavo.Primitive)},changedBy:function(e){return this.isDynamicObject?!e||!this.mavoNode.contains(e.node):Mavo.Expression.changedBy(this.identifiers,e)},update:function(){if(!1!==this.active){var e={context:this},t=e;if(this.item)var i=this.isDynamicObject?this.item.parent:this.item,r=this.data=i.getLiveData();else r=void 0===this.data?Mavo.Data.stub:this.data;Mavo.hooks.run("domexpression-update-start",e),this.oldValue=this.value;var s=!1;e.value=this.value=this.parsed.map((e=>{if(e instanceof Mavo.Expression){var i={context:this,expr:e,parentEnv:t};return Mavo.hooks.run("domexpression-update-beforeeval",i),i.value=Mavo.value(i.expr.eval(r)),Mavo.hooks.run("domexpression-update-aftereval",i),s=!0,i.value instanceof Error?void 0===this.fallback?this.syntax.start+i.expr.expression+this.syntax.end:this.fallback:void 0===i.value||null===i.value?"":i.value}return e})),s&&(e.value=1===e.value.length?e.value[0]:e.value.map((e=>Mavo.Primitive.format(e,{attribute:this.attribute,element:this.element}))).join(""),this.output(e.value),Mavo.hooks.run("domexpression-update-end",e))}},output:function(e){this.primitive?(Mavo.in(Mavo.isProxy,e)&&(e=Mavo.clone(e)),this.primitive.value=e):this.mavoNode?this.mavoNode.render(e):Mavo.Primitive.setValue(this.node,e,{attribute:this.attribute})},live:{item:function(e){e&&this._item!=e&&(this._item&&Mavo.delete(this._item.expressions,this),e.expressions=e.expressions||[],e.expressions.push(this))}},static:{elements:new WeakMap,search:function(e,i){if(null===e)return e;i&&!e.ownerDocument.xmlVersion&&(i=i.toLowerCase());var r=t.elements.get(e)||[];return 1<arguments.length?r.length&&r.filter((e=>e.attribute===i))[0]||null:r},special:{add:function(e,t){if(t){var i=this.vars[t],r=-1<e.identifiers.indexOf(t),s=t.startsWith("$")&&-1<e.identifiers.indexOf(t.substr(1));i&&(r||s)&&(i.all=i.all||new Set,i.all.add(e),1===i.all.size?i.observe():!i.all.size&&i.unobserve())}else for(var t in this.vars)this.add(e,t)},delete:function(e,t){if(t){var i=this.vars[t];i.all=i.all||new Set,i.all.delete(e),i.all.size||i.unobserve()}else for(var t in this.vars)this.delete(e,t)},update:function(){this.update?.(...arguments),this.all.forEach((e=>e.update()))},event:function(e,{type:i,update:r,target:s=document}={}){this.vars[e]={observe:function(){this.callback=this.callback||t.special.update.bind(this),s.addEventListener(i,this.callback)},unobserve:function(){s.removeEventListener(i,this.callback)}},r&&(this.vars[e].update=function(t){Mavo.Functions[e]=r(t)})},vars:{$now:{observe:function(){var e=()=>{t.special.update.call(this),this.timer=requestAnimationFrame(e)};this.timer=requestAnimationFrame(e)},unobserve:function(){cancelAnimationFrame(this.timer)}}}}}});t.special.event("$mouse",{type:"mousemove",update:function(e){return{x:e.clientX,y:e.clientY}}}),t.special.event("$hash",{type:"hashchange",target:window})}(Bliss,Bliss.$),function(e,t){Mavo.attributes.push("mv-expressions");var i=Mavo.Expressions=e.Class({async constructor(e){this.mavo=e,this.active=!0,this.expressions=[],this.identifiers={};var t=Mavo.Expression.Syntax.create(this.mavo.element.closest("[mv-expressions]"))||Mavo.Expression.Syntax.default;this.traverse(this.mavo.element,void 0,t),this.scheduled={},await this.mavo.treeBuilt,this.expressions=[],this.update()},register:function(e){var t=this.identifiers;e.registeredApp=e.registeredApp||new Set,e.identifiers.forEach((i=>{t[i]instanceof Set||(t[i]=new Set),t[i].add(e),Mavo.all[i]instanceof Mavo&&Mavo.all[i]!==this.mavo&&!e.registeredApp.has(i)&&(e.registeredApp.add(i),Mavo.all[i].expressions.register(e))}))},unregister:function(e){var t=this.identifiers;e.identifiers.forEach((i=>{t[i]&&t[i].delete(e),i in Mavo.all&&"undefined"!=typeof domexpresssion&&Mavo.all[i].expressions.unregister(domexpresssion)}))},updateThrottled:function(e){if(this.active){var t=this.scheduled[e.action]=this.scheduled[e.action]||new Set;e.node.template?!t.has(e.node.template)&&(setTimeout((()=>{t.delete(e.node.template),this.update(e)}),i.THROTTLE),t.add(e.node.template)):requestAnimationFrame((()=>this.update(e)))}},update:function(e){if(this.active){var t,i;if(e instanceof Mavo.Node)i=e;else if(e instanceof Element)t=e.closest(Mavo.selectors.item),i=Mavo.Node.get(t);else{if(e){var r={updated:new Set};if(this.updateByIdThrottled(e.property,e,r),"propertychange"==e.action)e.node?.path&&this.updateByIdThrottled(e.node.path,e,r);else{this.updateById(Object.keys(Mavo.Data.special),e,r);var s=e.node.collection||e.node;this.updateById(s.properties,e,r)}return}i=this.mavo.root}i.walk((t=>!!t.expressionsEnabled&&void t.expressions?.forEach((t=>{e&&t.mavoNode===e||t.update()}))))}},updateByIdThrottled:function(e,t,r){if(e)if(e.forEach)e.forEach((e=>this.updateByIdThrottled(e,t,r)));else{var s=this.scheduledIds=this.scheduledIds||new Set;s.has(e)||(setTimeout((()=>{s.delete(e),this.updateById(e,t,r)}),i.THROTTLE),s.add(e))}},updateById:function(e,t,i){if(e.forEach)e.forEach((e=>this.updateById(e,t,i)));else{var r=this.identifiers[e];r&&r.forEach((e=>{"mv-value"==e.originalAttribute&&e.mavoNode&&!(e.mavoNode instanceof Mavo.Primitive)&&e.mavoNode.contains(t.node)||!i.updated.has(e)&&e.update()}))}},extract:function(e,t,r,s=Mavo.Expression.Syntax.default){t&&-1<i.skip.indexOf(t.name)||(t&&-1<i.directives.indexOf(t.name)||s!==Mavo.Expression.Syntax.ESCAPE&&s.test(t?t.value:e.textContent))&&(void 0===r&&(r=Mavo.elementPath(e.closest(Mavo.selectors.item),e)),this.expressions.push(new Mavo.DOMExpression({node:e,syntax:s,path:r,attribute:t?.name,mavo:this.mavo})))},traverse:function(e,i=[],r){if(8!==e.nodeType)if(3===e.nodeType)this.extract(e,null,i,r);else{if(e.normalize(),r=Mavo.Expression.Syntax.create(e)||r,Mavo.is("item",e)&&(i=[]),e.hasAttribute("mv-expressions-ignore"))var s=new Set(e.getAttribute("mv-expressions-ignore").trim().split(/\s*,\s*/));t(e.attributes).forEach((t=>{s&&s.has(t.name)||this.extract(e,t,i,r)}));var a=-1,n=0;e.matches("script:not([mv-expressions])")||t(e.childNodes).forEach((e=>{if(1==e.nodeType?(n=0,a++):n++,1==e.nodeType||3==e.nodeType){var t=0<n?`${a}.${n}`:a;this.traverse(e,[...i||[],t],r)}}))}},static:{directives:["mv-value"],skip:["mv-expressions","mv-action"],THROTTLE:50,directive:function(e,t){i.directives.push(e),Mavo.attributes.push(e),Mavo.Plugins.register(e,t)}}})}(Bliss,Bliss.$),function(e,t){Mavo.Expressions.directive("mv-if",{extend:{Primitive:{live:{hidden:function(e){this._hidden!==e&&(this._hidden=e,this.liveData.update(),this.dataChanged())}}},DOMExpression:{lazy:{childProperties:function(){var e=t(Mavo.selectors.property,this.element).filter((e=>e.closest("[mv-if]")==this.element)).map((e=>Mavo.Node.get(e)));return this.element.addEventListener("mv-change",(e=>{requestAnimationFrame((()=>{this.element.parentNode||this.item.element.dispatchEvent(e)}))})),e}}}},hooks:{"domexpression-init-start":function(){"mv-if"!=this.attribute||(!Mavo.Node.prototype.fromTemplate.call(this,"parsed","expression")&&(this.expression=this.element.getAttribute("mv-if"),this.parsed=[new Mavo.Expression(this.expression)],this.expression=this.syntax.start+this.expression+this.syntax.end),this.parentIf=this.element.parentNode&&Mavo.DOMExpression.search(this.element.parentNode.closest("[mv-if]"),"mv-if"),this.parentIf&&(this.parentIf.childIfs=(this.parentIf.childIfs||new Set).add(this)))},"domexpression-update-end":async function(){if("mv-if"===this.attribute){var e=this.value[0],t=this.oldValue[0];if(await this.item.mavo.treeBuilt,this.parentIf){var i=this.parentIf.value[0];this.value[0]=e=e&&i}!1!==i&&(e?Mavo.revocably.add(this.element):this.element.parentNode&&Mavo.revocably.remove(this.element,"mv-if")),e!==t&&(this.childProperties?.forEach((t=>t.hidden=!e)),this.childIfs?.forEach((e=>e.update())))}},"node-isdatanull":function(e){e.result=e.result||this.hidden&&e.options.live}}})}(Bliss,Bliss.$),function(e,t){var i=Math.round,r=Math.floor,s=Math.abs,a=Math.min;function n(e=""){return(e=t(e))||0===e?e+"":""}function o(e){return null===(e=Mavo.value(e))||!1===e||""===e}function l(e){return!t(e)}var h=Mavo.Functions={operators:{"=":"eq"},get:function(e,i,r={}){i=r.property=t(i);var s=Mavo.getCanonicalProperty(e,i);if(void 0!==s){r.property=s;var a=e[s];return"function"==typeof a&&0!==a.name.indexOf("bound")?a.bind(e):a}if(Array.isArray(e)&&i&&isNaN(i)){var n=i.indexOf("=");return-1<n?(r.query={property:i.slice(0,n),value:i.slice(n+1)},r.property=[],a=e.filter(((e,t)=>{var i=h.get(e,r.query.property)==r.query.value;return i&&r.property.push(t),i})),"id"==r.query.property&&(r.property=r.property[0],a=a[0]),void 0===a?r.property=e.length:0===a.length&&(r.property=[e.length]),a):e.map((e=>h.get(e,i)))}return null},url:(e,t=location)=>{if(void 0===e)return location.href;if(e){e=n(e).replace(/[^\w-:]/g);var i=t.search.match(RegExp(`[?&]${e}(?:=(.+?))?(?=$|&)`))||t.pathname.match(RegExp(`(?:^|\\/)${e}\\/([^\\/]*)`))}return null!==i&&e?decodeURIComponent(i[1]||""):null},first:(e,t)=>{if(void 0===t&&(t=e,e=void 0),void 0===t)return null;if(!Array.isArray(t))return void 0===e?t:[t];if(0>e)return h.last(s(e),t);for(var i=[],a=void 0===e?1:r(e),n=0;n<t.length&&i.length<a;n++)null!==Mavo.value(t[n])&&i.push(t[n]);return void 0===e?void 0===i[0]?null:i[0]:i},last:(e,t)=>{if(void 0===t&&(t=e,e=void 0),void 0===t)return null;if(!Array.isArray(t))return void 0===e?t:[t];if(0>e)return h.first(s(e),t);for(var i=[],a=void 0===e?1:r(e),n=t.length-1;0<=n&&i.length<a;n--)null!==Mavo.value(t[n])&&i.push(t[n]);return void 0===e?void 0===i[0]?null:i[0]:i},condense:e=>h.first(e.length,e),unique:function(e){return Array.isArray(e)?[...new Set(e.map(t))]:e},intersects:function(e,i){if(e&&i){var r=new Set(Mavo.toArray(i).map(t));return!(e=Mavo.toArray(e).map(t)).every((e=>!r.has(e)))}},sum:e.extend((function(e){return u.numbers(e,arguments).reduce(((e,t)=>+e+(+t||0)),0)}),{isAggregate:!0}),average:e.extend((function(e){return(e=u.numbers(e,arguments)).length&&h.sum(e)/e.length}),{isAggregate:!0,alias:"avg"}),median:e.extend((function(e){var t=Math.ceil,i=((e=u.numbers(e,arguments).sort(((e,t)=>e-t))).length-1)/2;return[m1,m2]=[e[r(i)],e[t(i)]],(m1+m2)/2||0}),{isAggregate:!0}),min:e.extend((function(e){return a(...u.numbers(e,arguments))}),{isAggregate:!0}),max:e.extend((function(e){return Math.max(...u.numbers(e,arguments))}),{isAggregate:!0}),atan2:e.extend(((e,t)=>Math.atan2(e,t)),{multiValued:!0,rightUnary:e=>e,default:1}),pow:e.extend(((e,t)=>Math.pow(e,t)),{multiValued:!0,default:1}),imul:e.extend(((e,t)=>Math.imul(e,t)),{multiValued:!0,default:1}),count:e.extend((function(e){return Mavo.toArray(e).filter((e=>!o(e))).length}),{isAggregate:!0}),reverse:function(e){return Mavo.toArray(e).slice().reverse()},round:e.extend(((e,t)=>l(e)||l(t)||!isFinite(e)?i(e):+(+e).toLocaleString("en-US",{useGrouping:!1,maximumFractionDigits:t})),{multiValued:!0,rightUnary:e=>e,default:0}),ordinal:e.extend((e=>{if(o(e))return"";if(10>e||20<e)var t=["th","st","nd","rd","th"][e%10];return t||"th"}),{multiValued:!0,alias:"th"}),digits:e.extend(((e,t,i)=>{if(void 0===i&&(i=t,t=void 0),isNaN(i))return null;var r=(i+"").split(".");return r[0]=r[0].slice(-e),void 0!==t&&r[1]&&(r[1]=r[1].slice(0,t)),(i=+r.join(".")).toLocaleString("en",{useGrouping:!1,minimumIntegerDigits:e,minimumFractionDigits:t,maximumFractionDigits:t||20})}),{multiValued:!0}),iff:function(e,i=e,r=null){return Array.isArray(e)?e.map(((e,s)=>{var n=t(e)?i:r;return Array.isArray(n)?n[a(s,n.length-1)]:n})):t(e)?i:r},group:(...e)=>0===e.length?{}:Object.assign(...e),list:(...e)=>e.flat(),random:e.extend(((e=0,t=100,i=1)=>{1==arguments.length&&(t=e,e=0);var s=Math.random();return r(s*((t-e)/i+1))*i+e}),{multiValued:!0}),range:(e,t,i)=>{void 0===i&&(void 0===t&&([e,t]=[0<=e?1:-1,e]),i=e<=t?1:-1);let s=r((t-e)/i+1);if(0>=s||!isFinite(s))return[e];let a=[];for(let t=0,r=e;t++<s;r+=i)a.push(r);return a},shuffle:e=>{if(Array.isArray(e)){for(var t,i=e.slice(),s=i.length-1;0<s;s--)t=r(Math.random()*(s+1)),[i[s],i[t]]=[i[t],i[s]];return i}return e},replace:e.extend(((e,t,i="",r=1)=>{if(Array.isArray(e))return e.map((e=>h.replace(e,t,i)));for(var s,a=RegExp(Mavo.escapeRegExp(t),"g"),n=e,o=0;n!=s&&o++<r;)s=n,n=n.replace(a,i);return n}),{multiValued:!0}),len:e.extend((e=>n(e).length),{multiValued:!0}),contains:e.extend(((t,i)=>{let r,s=e.type(t);if("object"===e.type(i))return 0<=JSON.stringify(t).indexOf(JSON.stringify(i));if("object"!==s&&"array"!==s)return 0<=h.search(t,i);for(let e in t)if(r=h.contains(t[e],i),Array.isArray(r)&&(r=Mavo.Functions.or(r)),r)return!0;return r}),{multiValued:!0}),search:e.extend(((e,t)=>(e=n(e),t=n(t),e&&t?e.toLowerCase().indexOf(t.toLowerCase()):-1)),{multiValued:!0}),starts:e.extend(((e,t)=>0===h.search(n(e),n(t))),{multiValued:!0}),ends:e.extend(((e,t)=>{[e,t]=[n(e),n(t)];var i=h.search(e,t);return-1<i&&i===e.length-t.length}),{multiValued:!0}),join:function(e,t){return Mavo.toArray(e).filter((e=>!o(e))).join(n(t))},idify:e.extend((e=>n(e).normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s-]/g,"").trim().replace(/\s+/g,"-").toLowerCase()),{multiValued:!0}),readable:e.extend((e=>n(e).replace(/([a-z])([A-Z])(?=[a-z])/g,((e,t,i)=>t+" "+i.toLowerCase())).replace(/([a-z0-9])[_\/-](?=[a-z0-9])/g,"$1 ").replace(/^[a-z]/,(e=>e.toUpperCase()))),{multiValued:!0}),uppercase:e.extend((e=>n(e).toUpperCase()),{multiValued:!0}),lowercase:e.extend((e=>n(e).toLowerCase()),{multiValued:!0}),from:e.extend(((e,t)=>h.between(e,t)),{multiValued:!0}),fromlast:e.extend(((e,t)=>h.between(e,t,"",!0)),{multiValued:!0}),to:e.extend(((e,t)=>h.between(e,"",t)),{multiValued:!0}),tofirst:e.extend(((e,t)=>h.between(e,"",t,!0)),{multiValued:!0}),between:e.extend(((e,t,i,r)=>{[e,t,i]=[n(e),n(t),n(i)];var s=t?e[r?"lastIndexOf":"indexOf"](t):-1,a=e[r?"indexOf":"lastIndexOf"](i);return t&&-1===s||-1===a?"":e.slice(s+1,-1!==a&&i?a:e.length)}),{multiValued:!0}),phrase:e.extend((function(t,i,r){3===arguments.length&&"string"===e.type(i)&&([r,i]=[i]);var s=r?Mavo.Locale.get(r):this?.[Mavo.mavo]?.locale??Mavo.Locale.default;return s.phrase(t,i)}),{needsContext:!0}),filename:e.extend((e=>new URL(n(e),Mavo.base).pathname.match(/[^/]+?$/)?.[0]),{multiValued:!0}),json:e=>Mavo.safeToJSON(e),split:e.extend(((e,t=/\s+/)=>e?(e=n(e)).split(t):[]),{multiValued:!0}),log:(...e)=>e[0],$mouse:{x:0,y:0},get $hash(){return location.hash.slice(1)},get $alt(){return!!h.$evt&&h.$evt.altKey},get $ctrl(){return!!h.$evt&&h.$evt.ctrlKey},get $shift(){return!!h.$evt&&h.$evt.shiftKey},get $cmd(){return!!h.$evt&&h.$evt[Mavo.superKey]},util:{numbers:function(e,i){return(e=Array.isArray(e)?e:i?$$(i):[e]).filter((e=>!isNaN(e)&&""!==t(e)&&null!==t(e))).map((e=>+e))},postProcess:function(t){var i,r=t.multiValued;if(!0===r||2===r?.length?i=(...e)=>{var i=r[0]||0,s=r[1]||1;return Mavo.Script.binaryOperation(e[i],e[s],{scalar:(r,a)=>(i in e&&(e[i]=r),s in e&&(e[s]=a),t(...e)),...t})}:t.isAggregate&&(i=function(e){if(Mavo.in(Mavo.groupedBy,e))return e.map((e=>i(e.$items)));var r=t.call(this,...arguments);return void 0===r?e:r}),i&&(e.extend(i,t),i.original=t),t.alias)for(let e of Mavo.toArray(t.alias))Mavo.Functions[e]=i||t;return i}}},u=h.util;Mavo.ready.then((()=>{Object.getOwnPropertyNames(Mavo.Functions).forEach((e=>{var t=u.postProcess(Mavo.Functions[e]);t&&(Mavo.Functions[e]=t)})),Object.getOwnPropertyNames(Math).forEach((e=>{1!==Math[e].length||Mavo.Functions.hasOwnProperty(e)||(Mavo.Functions[e]=t=>Mavo.Script.unaryOperation(t,(t=>Math[e](t))))}))}))}(Bliss,Mavo.value),function(e,t,i,r=i.util){var s=Math.floor,a=Math.abs,n={seconds:1,minutes:60};n.hours=60*n.minutes,n.days=24*n.hours,n.weeks=7*n.days,n.months=30.4368*n.days,n.years=52*n.weeks;var o={year:e=>e.getFullYear(),month:e=>e.getMonth()+1,day:e=>e.getDate(),weekday:e=>e.getDay()||7,hour:e=>e.getHours(),minute:e=>e.getMinutes(),second:e=>e.getSeconds(),ms:e=>e.getMilliseconds()};for(let t in e.extend(i,{get $now(){return new Date},$startup:new Date,get $today(){return i.date(new Date)},year:e.extend((function(){return r.dateComponent("year",...arguments)}),{multiValued:!0}),month:e.extend((function(){return r.dateComponent("month",...arguments)}),{multiValued:!0}),week:()=>1e3*n.weeks,day:e.extend((function(){return r.dateComponent("day",...arguments)}),{multiValued:!0}),weekday:e.extend((function(){return r.dateComponent("weekday",...arguments)}),{multiValued:!0}),hour:e.extend((function(){return r.dateComponent("hour",...arguments)}),{multiValued:!0}),minute:e.extend((function(){return r.dateComponent("minute",...arguments)}),{multiValued:!0}),second:e.extend((function(){return r.dateComponent("second",...arguments)}),{multiValued:!0}),ms:e.extend((function(){return r.dateComponent("ms",...arguments)}),{multiValued:!0}),date:e.extend((e=>(e=r.date(e))?`${i.year(e)}-${i.month(e,"00")}-${i.day(e,"00")}`:""),{multiValued:!0}),time:e.extend(((e,t="seconds")=>{if(!(e=r.date(e)))return"";var s=`${i.hour(e,"00")}:${"hours"==t?"00":i.minute(e,"00")}`;return("seconds"==t||"ms"==t)&&(s+=`:${i.second(e,"00")}`,"ms"==t&&(s+=`.${i.ms(e)}`)),s}),{multiValued:!0}),localTimezone:-(new Date).getTimezoneOffset()}),i.msTo=(e,t)=>s(a(t)/(1e3*n[e]))||0,n)i[t]=e.extend((function(e){return 0===arguments.length?1e3*n[t]:i.msTo(t,e)}),{multiValued:!0});i.duration=e.extend((function(e,t){(0===e||void 0===t)&&(t=1);let r=e||0,a=[];if(1>e)a=["0 ms"];else{let e=[...Object.keys(n).reverse(),"ms"];for(let o,l=0;o=e[l];l++){let e=o in n?1e3*n[o]:1,l=s(r/e);if(r%=e,0<l&&a.length<t){let e=1===l&&"ms"!==o?o.slice(0,-1):o;a.push(l+" "+i.phrase.call(this,e))}else if(0<a.length)break}}return 1===arguments.length?a[0]:a}),{needsContext:!0,multiValued:!0}),e.extend(i.util,{fixDateString:function(e){e=e.trim();var t=/^\d{4}-\d{2}(-\d{2})?/.test(e),r=-1<e.indexOf(":");return t||r?(e=t?e.replace(/^(\d{4}-\d{2})(?!-\d{2})/,"$1-01"):i.$today+" "+e,r?e=e.replace(/\-(\d{2})\s+(?=\d{2}:)/,"-$1T"):e+="T00:00:00",e=e.replace(/\s+/g,"")):null},dateComponent:function(e,t,s){if(1===arguments.length&&e+"s"in n)return i[e+"s"]();var a=r.date(t);if("year"===e){t=t&&t.match?t:t+"";var l=a?a.getFullYear()+"":(t.match(/\b[1-9]\d\d\b|\d+/)||[])[0]}if(!l&&!a)return"";l=l||o[e](a);return s?/^0+$/.test(s)?(l+"").padStart(s.length,"0").slice(-s.length):(s={name:"long",shortname:"short"}[s]||s,l=(l=a.toLocaleString(Mavo.locale,{[e]:s})).replace(/\u200e/g,"")):"year"===e?l:+l},date:function(i){if(!(i=t(i)))return null;var s=new Date(i);if("string"!==e.type(i)||!isNaN(s)&&s+""==i)return s;if(null===(i=r.fixDateString(i)))return null;var a=i.match(/[+-]\d{2}:?\d{2}|Z$/)?.[0];if(a)i=new Date(i);else{var n=i.match(/\d+/g);i=new Date(n[0],(n[1]||1)-1,n[2]||1,n[3]||0,n[4]||0,n[5]||0,n[6]||0)}return isNaN(i)?null:i}})}(Bliss,Mavo.value,Mavo.Functions),function(e,t,i){var r=Math.max,s=Mavo.Script={$fn:self.Proxy?new Proxy({[Symbol.unscopables]:{undefined:!0}},{get:(e,t)=>{var i,r=t.toLowerCase();return r in Mavo.Actions.Functions&&(i=Mavo.Actions.running?Mavo.Actions.Functions[r]:Mavo.Actions.nope),void 0===i&&(i=r in Mavo.Functions?Mavo.Functions[r]:Math[t]||Math[r]),i},has:(e,t)=>{var i=t.toLowerCase();return i in Mavo.Functions||i in Mavo.Actions.Functions||t in Math||i in Math}}):Mavo.Functions,addUnaryOperator:function(e,i){return i.symbol&&Mavo.toArray(i.symbol).forEach((t=>{s.unarySymbols[t]=e,jsep.addUnaryOp(t)})),e=>s.unaryOperation(e,(e=>i.scalar(t(e))))},unaryOperation:function(e,t){return Array.isArray(e)?e.map(t):t(e)},binaryOperation:function(e,t,i={}){var s;if(i.scalar="function"==typeof i?i:i.scalar,Array.isArray(t))if(Array.isArray(e)){s=[];var a=r(e.length,t.length),n=i.leftUnary||i.unary,o=i.rightUnary||i.unary,l=void 0===i.leftDefault?i.default:i.leftDefault,h=void 0===i.rightDefault?i.default:i.rightDefault;for(let r=0;r<a;r++)s[r]=!i.comparison||void 0!==e[r]&&void 0!==t[r]?void 0===e[r]?o?o(t[r]):i.scalar(l,t[r]):void 0===t[r]?n?n(e[r]):i.scalar(e[r],h):i.scalar(e[r],t[r]):i.default}else s=t.map((t=>i.scalar(e,t)));else s=Array.isArray(e)?e.map((e=>i.scalar(e,t))):i.scalar(e,t);return s},addBinaryOperator:function(e,r){return r.symbol&&Mavo.toArray(r.symbol).forEach((t=>{s.symbols[t]=e,r.precedence&&jsep.addBinaryOp(t,r.precedence)})),r.default=void 0===r.default?0:r.default,r.code||function(...e){1===e.length&&Array.isArray(e[0])&&(e=[...e[0]]),r.raw||(e=e.map(t));var a=!!r.comparison||e[0];for(let t=1;t<e.length;t++){let o=r.comparison?e[t-1]:a,l=e[t];Array.isArray(l)&&"number"==typeof r.default&&(l=i.numbers(l));var n=s.binaryOperation(o,l,r);a=r.comparison?s.binaryOperation(a,n,s.operators.and):n}return a}},symbols:{},unarySymbols:{},getOperatorName:(e,t)=>s[t?"unarySymbols":"symbols"][e]||e,isComparisonOperator:e=>{if(e){let t=s.operators[s.symbols[e]];return t&&t.comparison}},isStatic:e=>{if("Identifier"===e.type)return!1;for(let t of s.childProperties)if(e[t]&&"callee"!==t&&!s.isStatic(e[t]))return!1;return!0},operators:{not:{symbol:"!",scalar:e=>!t(e)},multiply:{scalar:(e,t)=>e*t,default:1,symbol:"*"},divide:{scalar:(e,t)=>e/t,rightUnary:e=>e,default:1,symbol:"/"},addition:{scalar:(e,t)=>{if(isNaN(e)||isNaN(t)){var r=i.date(e),s=i.date(t);if(r||s)return+r+ +s}return+e+ +t},symbol:"+"},plus:{scalar:e=>+e,symbol:"+"},subtract:{scalar:(e,t)=>{if(isNaN(e)||isNaN(t)){var r=i.date(e),s=i.date(t);if(r&&s)return r-s}return e-t},symbol:"-"},minus:{scalar:e=>-e,symbol:"-"},mod:{scalar:(e,t)=>{var i=e%t;return i+=0>i?t:0},symbol:"mod",precedence:10},lte:{comparison:!0,scalar:(e,t)=>([e,t]=s.getNumericalOperands(e,t),e<=t),default:!1,symbol:"<="},lt:{comparison:!0,scalar:(e,t)=>([e,t]=s.getNumericalOperands(e,t),e<t),default:!1,symbol:"<"},gte:{comparison:!0,scalar:(e,t)=>([e,t]=s.getNumericalOperands(e,t),e>=t),default:!1,symbol:">="},gt:{comparison:!0,scalar:(e,t)=>([e,t]=s.getNumericalOperands(e,t),e>t),default:!1,symbol:">"},eq:{comparison:!0,scalar:(e,t)=>e==t||Mavo.safeToJSON(e)===Mavo.safeToJSON(t),symbol:["=","=="],default:!1,precedence:7},neq:{comparison:!0,scalar:(e,t)=>e!=t&&Mavo.safeToJSON(e)!==Mavo.safeToJSON(t),symbol:["!="],default:!0,precedence:7},and:{scalar:(e,t)=>e&&t,default:!1,symbol:["&&","and"],precedence:2},or:{scalar:(e,t)=>e||t,default:!1,symbol:["||","or"],precedence:2},concatenate:{symbol:"&",default:"",scalar:(e,t)=>""+(e||"")+(t||""),precedence:10},keyvalue:{symbol:":",code:(...e)=>{for(var t=e.length-1,i=e[t];t--;)i={[e[t]]:i};return i},transformation:e=>{"Identifier"==e.left.type&&(e.left={type:"Literal",value:e.left.name,raw:JSON.stringify(e.left.name)})},precedence:4},filter:{symbol:"where",code:(e,...i)=>{for(let r of i)Array.isArray(e)?Array.isArray(r)?e=e.map(((e,i)=>t(r[i])?e:null)):(r=t(r),e="boolean"==typeof r?r?e:e.map((()=>null)):e.map((e=>e==r?e:null))):e=t(r)?e:null;return e},precedence:1,postFlattenTransformation:e=>{var t=e.arguments[0];for(let i=1;i<e.arguments.length;i++)s.isStatic(e.arguments[i])||(e.arguments[i]=Object.assign(s.parse("scope()"),{arguments:[t,e.arguments[i]]}))}},range:{symbol:"..",scalar:(e,t)=>Mavo.Functions.range(e,t),precedence:2,export:!1},has:{symbol:"in",code:function(i,...r){var s;return r.map((r=>{if(Array.isArray(r))var a=i=>{var s="object"===e.type(t(i))?Mavo.safeToJSON:t;return-1<r.map(s).indexOf(s(i))};else if("object"===e.type(r))a=e=>Mavo.in(t(e),r);else a=e=>Mavo.Functions.eq(e,r);var n=Mavo.Script.unaryOperation(i,a);s=void 0===s?n:Mavo.Functions.and(n,s)})),s},precedence:3},groupby:{symbol:"by",code:(t,i)=>{t=Mavo.toArray(t);var r=(i=Mavo.toArray(i))[Mavo.as]||i[0]?.[Mavo.toNode]?.property,s=new Mavo.BucketMap({arrays:!0}),a=[];return a[Mavo.groupedBy]=!0,t.forEach(((e,t)=>{let r=t<i.length?Mavo.value(i[t]):null;s.set(r,e)})),Mavo.in(Mavo.route,t)&&(a[Mavo.route]=Object.assign({},t[Mavo.route])),s.forEach(((i,s)=>{var n={$value:s,[r||"$value"]:s,$items:i};Mavo.in(Mavo.route,t)&&(i[Mavo.route]=n[Mavo.route]=Object.assign({},t[Mavo.route]),n[Mavo.route]=e.each(i[Mavo.route],(()=>new Set(["$items"])))),a.push(n)})),Mavo.Data.proxify(a)},precedence:2},as:{symbol:"as",code:(t,i)=>{if(void 0!==t&&"array"===e.type(t)&&void 0!==i){var r=t.slice();return Array.isArray(i)||void 0===i?.[Mavo.toNode]?.property?"string"===e.type(i)?(r[Mavo.as]=i,r):void 0===i[0]?.[Mavo.toNode]?.property?t:(r[Mavo.as]=i[0]?.[Mavo.toNode]?.property,r):(r[Mavo.as]=i?.[Mavo.toNode]?.property,r)}return t},precedence:3}},getNumericalOperands:function(e,t){if(isNaN(e)||isNaN(t)){var r=i.date(e),s=i.date(t);if(r&&s)return[r,s]}return[e,t]},childProperties:["arguments","callee","left","right","argument","elements","test","consequent","alternate","object","property","body"],walk:function(e,t,i={},r,a){if(!i.type||e.type===i.type)var n=t(e,r,a);if(!i.ignore||-1===i.ignore.indexOf(e.type))if(Array.isArray(e))for(let a of e)s.walk(a,t,i,r,e);else s.childProperties.forEach((r=>{e[r]&&s.walk(e[r],t,i,r,e)}));return void 0!==n&&a&&(a[r]=n),n},serializers:{BinaryExpression:e=>`${s.serialize(e.left,e)} ${e.operator} ${s.serialize(e.right,e)}`,UnaryExpression:e=>`${e.operator}${s.serialize(e.argument,e)}`,CallExpression:e=>{e.callee;let t=e.callee,i=e,r="callee";for(;"MemberExpression"===t.type;)i=t,t=t.object,r="object";if("MemberExpression"===e.callee.type&&"Identifier"===e.callee.property.type&&"call"===e.callee.property.name&&e.callee.object,"Identifier"===t.type){var a=t.name;if("scope"===a)return s.serializeScopeCall(e.arguments);a in Mavo.Script.$fn&&(i[r]={type:"MemberExpression",computed:!1,object:{type:"Identifier",name:"$fn"},property:t})}return`${s.serialize(e.callee,e)}(${e.arguments.map((t=>s.serialize(t,e))).join(", ")})`},ConditionalExpression:e=>`${s.serialize(e.test,e)}? ${s.serialize(e.consequent,e)} : ${s.serialize(e.alternate,e)}`,MemberExpression:e=>{let t,i=e;do{if("CallExpression"===i.type&&i.callee===t)break;t=i}while(i=i.parent);if(i){var r=e.computed?`[${s.serialize(e.property,e)}]`:`.${e.property.name}`;return`${s.serialize(e.object,e)}${r}`}r=e.computed?s.serialize(e.property,e):`"${e.property.name}"`;return`$fn.get(${s.serialize(e.object,e)}, ${r})`},ArrayExpression:e=>`[${e.elements.map((t=>s.serialize(t,e))).join(", ")}]`,Literal:e=>e.raw.replace(/\r/g,"\\r").replace(/\n/g,"\\n"),Identifier:e=>e.name,ThisExpression:()=>"this",Compound:e=>e.body.map((t=>s.serialize(t,e))).join(", ")},transformations:{BinaryExpression:e=>{let t=s.getOperatorName(e.operator),i=s.operators[t];i.transformation?.(e);var r=e,a={type:"CallExpression",arguments:[],callee:{type:"Identifier",name:t}};if(i.comparison){let e=[];do{let t=s.getOperatorName(r.operator);e.unshift({comparison:t,operand:r.right}),r=r.left}while(!1!==i.flatten&&s.isComparisonOperator(r.operator));let t=!1;for(let i=0;i<e.length-1;i++)if(e[i].comparison!=e[i+1].comparison){t=!0;break}a.arguments.push(r),t?(a.callee.name="compare",e.forEach((e=>{a.arguments.push({type:"Literal",value:e.comparison,raw:`"${e.comparison}"`}),a.arguments.push(e.operand)}))):e.forEach((e=>{a.arguments.push(e.operand)}))}else{do{a.arguments.unshift(r.right),r=r.left}while(!1!==i.flatten&&s.getOperatorName(r.operator)===t);a.arguments.unshift(r)}return i.postFlattenTransformation?.(a),a},UnaryExpression:e=>{var t=s.getOperatorName(e.operator,!0);if(t)return{type:"CallExpression",arguments:[e.argument],callee:{type:"Identifier",name:t}}},CallExpression:e=>{if("Identifier"==e.callee.type)if("if"==e.callee.name){e.callee.name="iff";var t=e.arguments[0];for(let i=1;i<e.arguments.length;i++)2==i&&(t=s.parse("not()")).arguments.push(e.arguments[0]),s.walk(e.arguments[i],(e=>{var i=e.callee.name;Mavo.Actions.Functions.hasOwnProperty(i)&&!/if$/.test(i)&&(e.callee.name+="if",e.arguments.unshift(t))}),{type:"CallExpression"})}else if("delete"==e.callee.name)e.callee.name="clear";else{var i=Mavo.Functions[e.callee.name];i&&i.needsContext&&(e.callee={type:"MemberExpression",computed:!1,object:e.callee,property:{type:"Identifier",name:"call"}},e.arguments.unshift({type:"Identifier",name:"$this"}))}},ThisExpression:()=>({type:"Identifier",name:"$this"})},closest(e,t){let i=e;do{if(i.type===t)return i}while(i=i.parent);return null},serialize:(e,t)=>{if("string"==typeof e)return e;t&&(e.parent=t);var i=s.transformations[e.type]?.(e,t);if("object"==typeof i&&i?.type)e=i;else if(void 0!==i)return i;return s.serializers[e.type](e,t)},rewrite:function(e,t){let i=s.parse(e);return t&&(t.ast=i),s.serialize(i)},compile:function(e,t){return/\S/.test(e)?(e=`with (Mavo.Data.stub)\n\twith (data || {}) {\n\t\tlet $fn = Mavo.Script.$fn;\n\t\treturn (${e=s.rewrite(e,t)});\n\t}`,t?.actions&&(e=`\nMavo.Actions._running = Mavo.Actions.running;\nMavo.Actions.running = true;\n${e}\nMavo.Actions.running = Mavo.Actions._running;`),new Function("data",e)):()=>""},parse:self.jsep,serializeScopeCall:e=>{var t=`with (Mavo.Script.subScope(scope, $this) || {}) { return (${s.serialize(e[1])}); }`;return`(function() {\n\tvar scope = ${s.serialize(e[0])};\n\tif (Array.isArray(scope)) {\n\t\treturn scope.map(function(scope) {\n\t\t\t${t}\n\t\t});\n\t}\n\n\t${t}\n})()`},subScope:(e,t)=>{var i=Object.keys(t).reduce(((e,t)=>(e[t]=!0,e)),{$this:!0});return e&&"object"==typeof e?new Proxy(e,{get:(e,t,r)=>t===Symbol.unscopables?i:Reflect.get(e,t,r)}):e}};for(let e in s.serializers.LogicalExpression=s.serializers.BinaryExpression,s.transformations.LogicalExpression=s.transformations.BinaryExpression,s.operators){let t=s.operators[e];if(2>t.scalar?.length)var a=s.addUnaryOperator(e,t);else a=s.addBinaryOperator(e,t);t.code=t.code||a,a&&!1!==t.export&&(Mavo.Functions[e]=a)}Mavo.Functions.compare=function(...e){let t=!0;for(let i=2;i<e.length;i+=2){let r=e[i-2],a=e[i-1],n=e[i],o=s.binaryOperation(r,n,Mavo.Script.operators[a]);t=s.binaryOperation(t,o,Mavo.Script.operators.and)}return t}}(Bliss,Mavo.value,Mavo.Functions.util),function(e){Mavo.attributes.push("mv-action");var t=Mavo.Actions={listener:e=>{var i="submit"===e.type?"form":":not(form)",r=e.target.closest(i+"[mv-action]");if(r){var s=Mavo.Node.get(r);s&&s.editing&&"edit"!==s.modes||("submit"===e.type&&e.preventDefault(),r&&t.run(r.getAttribute("mv-action"),r,e))}},run:(e,t,i)=>{if(e){var r=Mavo.Node.getClosest(t);if(r){var s=new Mavo.Expression(e,{actions:!0}),a=Mavo.Functions.$evt;Mavo.Functions.$evt=i;var n=s.eval(r.getLiveData());return Mavo.Functions.$evt=a,n}}},getNodes:e=>{var i=t.getNode(e);return i?[i]:Mavo.toArray(e).map((e=>t.getNode(e))).filter((e=>void 0!==e))},getNode:e=>e instanceof Mavo.Node?e:e?.[Mavo.toNode]?e[Mavo.toNode]:void 0,getCollection:e=>{var i=t.getNode(e);return i instanceof Mavo.Collection?i:i?.collection??null},nope:()=>{var e=Object.keys(t.Functions).map((e=>`${e}()`));Mavo.warn(`Mavo actions (${e}) can only be used in the mv-action attribute.`)},Functions:{add:function(e,i,r){if(3>arguments.length)if(1>=arguments.length)[e,i]=[void 0,e];else if(2===arguments.length){var s=t.getCollection(i);s||(s=t.getCollection(e))&&([e,i,r]=[void 0,e,i])}if(i){if(!(s=s||t.getCollection(i)))return Mavo.warn("No collection or collection item provided to add().",{once:!1}),e;if(void 0===r){var a=t.getNode(i);a!==s&&(r=a.index)}return(Array.isArray(e)?e:[e]).map((e=>{var t=s.add(void 0,r);return void 0!==e&&t.render(e),s.editing&&s.editItem(t),t.getLiveData()}))}},move:(i,r,s)=>{if(i&&void 0!==r){"number"!=e.type(r)||([s,r]=[r]);var a=t.getNode(r),n=Mavo.toArray(i).map(t.getNode).filter((e=>e?.closestCollection)),o=(a||n[0]).closestCollection;if(!n.length)return o?(Mavo.warn("First parameter of move() was not a collection or collection item, using add() instead.",{once:!1}),t.Functions.add(i,o,s)):(Mavo.warn("You need to provide at least one collection or collection item for move() to have something to do.",{once:!1}),i);var l=t.Functions.add(i,o,s);return Mavo.Collection.delete(n,{silent:!0}),l}},clear:(...e)=>{if(e.length&&e[0]){var i=t.getNodes(e.flat()),r=[];return i.forEach((e=>{e&&(e instanceof Mavo.Collection?r.push(...e.children):e.collection?r.push(e):e.walk((i=>{i instanceof Mavo.Primitive?i.value=null:i!==e&&t.clear(i)})))})),Mavo.Collection.delete(r),i.map((e=>e.getLiveData()))}},clearif:(e,...i)=>(i=i.map((t=>Mavo.Functions.iff(e,t))),t.Functions.clear(...i)),set:(e,i)=>{if(e){var r=t.getNode(e);if(r)r.render(i);else{var s=Array.isArray(e),a=t.getNodes(e);a.length?Mavo.Script.binaryOperation(s?a:a[0],i,{scalar:(e,t)=>e?e.render(t):null}):Mavo.warn(`The first parameter of set() needs to be one or more existing properties, ${Mavo.safeToJSON(e)} is not.`)}return i}}}};for(let e in t.Functions){let i=e+"if";i in t.Functions||(t.Functions[i]=(i,r,...s)=>(r=Mavo.Functions.iff(i,r),Mavo.value(i)?t.Functions[e](r,...s):null))}t.Functions.deleteif=t.Functions.clearif}(Bliss,Bliss.$),function(e){var t=Mavo.Data=e.Class(class{constructor(e,t){this.node=e,void 0!==t&&(this.data=t)}get parent(){return this.node.parent?.liveData??null}get collection(){return this.node.collection}get key(){return this._key=this.collection?this.node.index:this.node.property}proxify(){return t.proxify(this.data)}update(){if(this.node instanceof Mavo.Collection||this.node instanceof Mavo.ImplicitCollection){this.data.length=0;for(var e=0;e<this.node.children.length;e++)this.data[e]=this.node.children[e].liveData.data;this.node instanceof Mavo.ImplicitCollection&&(Mavo.filter(this.data,(e=>null!==Mavo.value(e))),this.updateParent())}else if(this.node instanceof Mavo.Primitive){var i=this.node.value;this.node.isDataNull({live:!0})&&(i=null),this.data=Mavo.objectify(i),Mavo.isPlainObject(i)||Array.isArray(i)?t.computeRoutes(this.data):t.computeMetadata(this.data,this.key,this.parent),this.updateParent()}}updateParent(){if(this.parent)if(this.node instanceof Mavo.ImplicitCollection){var e=1===this.data.length?this.data[0]:this.data;this.parent.set(this.node.property,e,!0)}else if(this.collection instanceof Mavo.ImplicitCollection)this.parent.update();else{var t=this.key,i=!1;this.collection instanceof Mavo.Collection&&(i=this.collection.children[this.node.index]!==this.node),void 0===t||i||this.parent.set(t,this.data,!0)}}set(e,i,r){this.data[e]=i,t["computeRoute"+(r?"":"s")](i,e,this.data)}updateKey(){var e=this._key;this.parent[e]===this.data&&delete this.parent[e],this.updateParent()}resolve(e){return t.resolve(e,this.data)}},{live:{data:function(e){if(e!==this._data)return this.isArray=Array.isArray(e),this._data=e,e[Mavo.toNode]=this.node,e[Mavo.parent]=this.parent?.data,e[Mavo.mavo]=this.node.mavo,this.proxy=this.proxify(),this.updateParent(),this._data}},static:{stub:self.Proxy?new Proxy({[Symbol.unscopables]:{data:!0,undefined:!0}},{get:(e,t)=>{var i=Reflect.get(e,t);if(void 0!==i||"string"!=typeof t)return i;var r=t.toLowerCase();if("$"===r[0]&&r in Mavo.Functions)return Mavo.Functions[r];var s=t.toUpperCase();if(s in Math)return Math[s];if("undefined"!=typeof window&&window.hasOwnProperty(t))return window[t];if("$"!==t[0]){var a="$"+t.toLowerCase();if(a in Mavo.Functions)return Mavo.Functions[a]}return t},has:(e,t)=>Reflect.has(e,t)||"string"==typeof t}):Mavo.Functions,isItem:e=>Array.isArray(e?.[Mavo.parent]),closest(e,t){var i=[];do{if(t(e))return{value:e,path:i};i.push(e[Mavo.property])}while(e=e[Mavo.parent]);return{value:null,path:i}},root:e=>t.closest(e,(e=>!e[Mavo.parent])),closestItem:e=>t.closest(e,t.isItem),closestArray:e=>t.closest(e,Array.isArray),getProperty:e=>(t.isItem(e)?e[Mavo.parent]:e)[Mavo.property],find(e,i,r={}){if(i&&r.exclude!==i){if(Mavo.in(e,i)&&r.exclude!==i[e])return i[e];if(!i[Mavo.route]||!Mavo.in(e,i[Mavo.route])){if(i[Mavo.property]===e)return i;if(t.isItem(i)&&t.getProperty(i)===e)return i;if(Array.isArray(i))if((s=i.map((i=>t.find(e,i))).filter((e=>void 0!==e))).length)return s.flat();return}var s,a=[],n=Array.isArray(i);a[Mavo.route]={},a[Mavo.mavo]=i[Mavo.mavo];var o=s=>{var o=t.find(e,i[s],r);if(void 0!==o){if(Mavo.in(Mavo.route,o))for(var l in o[Mavo.route])a[Mavo.route][l]=!0;Array.isArray(o)?(a.push(...o),n=!0):a.push(o)}};if(Array.isArray(i)||!0===i[Mavo.route][e])for(var l in i)o(l);else i[Mavo.route][e].forEach(o);return n||1<a.length?a:a[0]}},findUp(e,i){var r,s=i;do{var a=t.find(e,s,{exclude:r});if(void 0!==a)return a;if(t.getProperty(s)===e)return s;r=s,s=s[Mavo.parent]}while(s)},resolve(e,i){if(e===Mavo.isProxy)return!0;if("symbol"==typeof e)return i[e];var r,s=!isNaN(e);if(e in i)r=i[e];else if(!s)if(e in t.special)r=t.special[e](i);else if(i[Mavo.mavo]){var a=i[Mavo.mavo].root.liveData.data[Mavo.route];Mavo.in(e,a)&&(r=t.findUp(e,i))}else Mavo.in(Mavo.route,i)&&Mavo.in(e,i[Mavo.route])&&(r=t.find(e,i));if(!s)var n=e.toLowerCase();if(void 0!==r)return null!==r&&"object"==typeof r&&(Mavo.route in r||Mavo.toNode in r)?t.proxify(r):r;if(!s){if(isNaN(e)&&Mavo.all?.[e]?.root)return Mavo.all[e].root.getLiveData();if("$"!==e[0]){var o="$"+n;if(o in t.special)return t.resolve(o,i)}}},has(e,i){if(e===Mavo.isProxy)return!0;if("string"!=typeof e)return Reflect.has(i,e);var r=[i,Mavo.all,t.special];if(r.some((t=>e in t)))return!0;if("string"==typeof e){var s=e.toLowerCase();if(s!==e&&r.some((e=>s in e)))return!0;if("$"!==s[0]&&"$"+s in t.special)return!0}return i[Mavo.mavo]?Mavo.in(e,i[Mavo.mavo].root.liveData.data[Mavo.route]):void 0},proxify:e=>e&&"object"==typeof e&&self.Proxy&&!e[Mavo.isProxy]?new Proxy(e,{get:(e,i)=>t.resolve(i,e),has:(e,i)=>t.has(i,e),set:function(e,t="",i){return"symbol"==typeof t?Reflect.set(e,t,i):(Mavo.warn(`You cannot set data via expressions. Attempt to set ${t.toString()} to ${i} ignored.`),i)}}):e,computeMetadata(e,t,i){e&&"object"==typeof e&&(void 0!==t&&(e[Mavo.property]=t),i&&!e[Mavo.parent]&&(e[Mavo.parent]=i))},computeRoute(i,r,s){if("function"!=typeof i&&(t.computeMetadata(i,r,s),(Mavo.isPlainObject(i)===Object.prototype||Array.isArray(i))&&!i[Mavo.route]&&(i[Mavo.route]={}),"number"!==e.type(r)))for(var a=i;s;){s[Mavo.route]||(s[Mavo.route]={});var n=a?.[Mavo.property];if(n&&!0!==s[Mavo.route][r]){if(s[Mavo.route][r]||(s[Mavo.route][r]=new Set),s[Mavo.route][r].has(n))break;s[Mavo.route][r].add(n)}else s[Mavo.route][r]=!0;a=s,s=s[Mavo.parent]}},computeRoutes(e,i,r){t.traverse(t.computeRoute,e,i,r)},traverseDown(i,r){if(Array.isArray(r))r.forEach(((e,s)=>t.traverse(i,e,s,r)));else if("object"===e.type(r))for(var s in r)t.traverse(i,r[s],s,r)},traverse(e,i,r,s){e(i,r,s),t.traverseDown(e,i,r,s)},special:{$index:function(e){var i=t.closestItem(e).value;if(!i)return-1;var r=i[Mavo.property];return isNaN(r)?i[Mavo.parent].indexOf(i):r},$item:function(e){return t.closestItem(e).value},$all:function(i){var r=t.closestArray(i),s=r.path.reverse().slice(1),a=r.value.map((t=>e.value(t,...s)));return 0<a.length&&a?.[0]?.[Mavo.route]&&(a[Mavo.route]=e.each(a[0][Mavo.route],(()=>!0)),a[Mavo.mavo]=a[0][Mavo.mavo]),a},$next:function(i){var r=t.closestArray(i),s=r.path.reverse(),a=r.path[0];s=s.slice(1);var n=r.value?.[a+1];return n?e.value(n,...s):null},$previous:function(i){var r=t.closestArray(i),s=r.path.reverse(),a=r.path[0];s=s.slice(1);var n=r.value?.[a-1];return n?e.value(n,...s):null},$this:function(e){return e}}}})}(Bliss,Bliss.$),function(e){var t=Mavo.Backend.register(e.Class({extends:Mavo.Backend,id:"Dropbox",constructor:function(){this.permissions.on(["login","read"]),this.login(!0)},update:function(e,i){this.super.update.call(this,e,i),this.url=t.fixShareURL(this.url)},async upload(e,t){return t=this.path.replace(/[^/]+$/,"")+t,await this.put(e,t),this.getURL(t)},async getURL(e){let i=await this.request("sharing/create_shared_link_with_settings",{path:e},"POST");return t.fixShareURL(i.url)},put(e,t=this.path,i={}){return this.request("https://content.dropboxapi.com/2/files/upload",e,"POST",{headers:{"Dropbox-API-Arg":JSON.stringify({path:t,mode:"overwrite"}),"Content-Type":"application/octet-stream"}})},oAuthParams:()=>`&redirect_uri=${encodeURIComponent("https://auth.mavo.io")}&response_type=code`,async getUser(){if(this.user)return this.user;let t=await this.request("users/get_current_account","null","POST");this.user={username:t.email,name:t.name.display_name,avatar:t.profile_photo_url,info:t},e.fire(this.mavo.element,"mv-login",{backend:this})},async login(e){if(await this.oAuthenticate(e),await this.getUser(),this.user){this.permissions.logout=!0;let e=await this.request("sharing/get_shared_link_metadata",{url:this.source},"POST");this.path=e.path_lower,this.permissions.on(["edit","save"])}},logout:function(){return this.oAuthLogout()},static:{apiDomain:"https://api.dropboxapi.com/2/",oAuth:"https://www.dropbox.com/oauth2/authorize",key:"2mx6061p054bpbp",test:function(e){return e=new URL(e,Mavo.base),/dropbox.com/.test(e.host)},fixShareURL:e=>((e=new URL(e,Mavo.base)).hostname="dl.dropboxusercontent.com",e.search=e.search.replace(/\bdl=0|^$/,"raw=1"),e)}}))}(Bliss,Bliss.$),function(e){let t=Mavo.Backend.register(e.Class({extends:Mavo.Backend,id:"Github",constructor:function(){this.permissions.on(["login","read"]),this.login(!0)},update:function(i,r){this.super.update.call(this,i,r);let s=this.format.constructor.extensions[0]||".json";for(const e in this.defaults={repo:"mv-data",filename:`${this.mavo.id}${s}`},this.info=t.parseURL(this.source,this.defaults),r)if(!["format","mavo"].includes(e)){if("graphql"===this.info.apiCall&&"query"===e){this.info.apiData={query:r.query};continue}this.info[e]=r[e]}e.extend(this,this.info)},get:async function(i){if(this.isAuthenticated()||!this.path||i){let e=i?t.parseURL(i):this.info;return e.apiData?this.request(e.apiCall,e.apiData,"POST").then((e=>e.errors?.length?Promise.reject(e.errors.map((e=>e.message)).join("\n")):e.data)):this.request(e.apiCall,{ref:this.branch},"GET",{headers:{Accept:"application/vnd.github.squirrel-girl-preview"}}).then((i=>Promise.resolve(e.repo&&i.content?t.atob(i.content):i)))}(i=new URL(`https://raw.githubusercontent.com/${this.username}/${this.repo}/${this.branch||"main"}/${this.path}`)).searchParams.set("timestamp",Date.now());try{let t=await e.fetch(i.href);return this.branch=this.branch||"main",t.responseText}catch(t){if(404===t.status&&!this.branch){i.pathname=`/${this.username}/${this.repo}/master/${this.path}`;try{let t=await e.fetch(i.href);return this.branch="master",t.responseText}catch(e){}}}return null},upload:function(e,t=this.path){return Mavo.readFile(e).then((e=>{let i=e.slice(5),r=i.match(/^\w+\/[\w+]+/)[0];return r=r.replace("+","\\+"),i=i.replace(RegExp(`^${r}(;base64)?,`),""),t=this.path.replace(/[^/]+$/,"")+t,this.put(i,t,{isEncoded:!0})})).then((e=>this.getURL(t,e.commit.sha)))},put:function(e,i=this.path,r={}){if(!i)return;let s=`repos/${this.username}/${this.repo}`,a=`${s}/contents/${i}`,n=this.mavo.element.getAttribute("mv-github-commit-prefix")||"",o=this.repoInfo?Promise.resolve(this.repoInfo):this.request("user/repos",{name:this.repo},"POST").then((e=>this.repoInfo=e));return e=r.isEncoded?e:t.btoa(e),o.then((e=>this.canPush()?e:this.request(`${s}/forks`,{name:this.repo},"POST").then((e=>(a=`repos/${e.full_name}/contents/${i}`,this.forkInfo=e))).then((e=>{let t,i=r=>{clearTimeout(t),this.request(`repos/${e.full_name}/commits`,{until:"1970-01-01T00:00:00Z"},"HEAD").then((()=>{r(e)})).catch((()=>{t=setTimeout(i,1e3)}))};return new Promise(i)})))).then((()=>this.request(a,{ref:this.branch}).then((t=>this.request(a,{message:n+this.mavo._("gh-updated-file",{name:t.name||"file"}),content:e,branch:this.branch,sha:t.sha},"PUT")),(t=>404==t.status?this.request(a,{message:n+"Created file",content:e,branch:this.branch},"PUT"):t)))).then((e=>{const t={context:this,fileInfo:e};return Mavo.hooks.run("gh-after-commit",t),t.fileInfo}))},login:function(e){return this.oAuthenticate(e).then((()=>this.getUser())).catch((e=>{401==e.status&&this.logout()})).then((()=>{if(this.user&&(this.permissions.on("logout"),this.info.path&&this.permissions.on(["edit","save"]),this.repo))return this.request(`repos/${this.username}/${this.repo}`).then((e=>(void 0===this.branch&&(this.branch=e.default_branch),this.repoInfo=e,this.mavo.source||this.canPush()?e:this.user.info.public_repos<e.forks?this.request("https://api.github.com/graphql",{query:"query {\n\t\t\t\t\t\t\t\t\t\t\t\t\t  viewer {\n\t\t\t\t\t\t\t\t\t\t\t\t\t    name\n\t\t\t\t\t\t\t\t\t\t\t\t\t      repositories(last: 100, isFork: true) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t      nodes {\n\t\t\t\t\t\t\t\t\t\t\t\t\t        url\n\t\t\t\t\t\t\t\t\t\t\t\t\t        parent {\n\t\t\t\t\t\t\t\t\t\t\t\t\t          nameWithOwner\n\t\t\t\t\t\t\t\t\t\t\t\t\t        }\n\t\t\t\t\t\t\t\t\t\t\t\t\t      }\n\t\t\t\t\t\t\t\t\t\t\t\t\t    }\n\t\t\t\t\t\t\t\t\t\t\t\t\t  }\n\t\t\t\t\t\t\t\t\t\t\t\t\t}"},"POST").then((t=>{let i=t.data.viewer.repositories.nodes;for(let t in i)if(i[t].parent.nameWithOwner===e.full_name)return this.switchToMyForkDialog(i[t].url),e;return e})):this.request(e.forks_url).then((t=>{for(let i in t)if(t[i].owner.login===this.user.username)return this.switchToMyForkDialog(t[i].html_url),e;return e}))))).then((e=>{const t={context:this,repoInfo:e};return Mavo.hooks.run("gh-after-login",t),t.repoInfo}))}))},canPush:function(){return this.repoInfo?this.repoInfo.permissions.push:this.user?.username?.toLowerCase()==this.username.toLowerCase()},oAuthParams:()=>"&scope=repo",logout:function(){return this.oAuthLogout().then((()=>{this.user=null}))},getUser:function(){return this.user?Promise.resolve(this.user):this.request("user").then((t=>{this.user={username:t.login,name:t.name||t.login,avatar:t.avatar_url,url:"https://github.com/"+t.login,info:t},e.fire(this.mavo.element,"mv-login",{backend:this})}))},getURL:function(e=this.path,t){let i=this.forkInfo||this.repoInfo,r=i.full_name;return e=e.replace(/ /g,"%20"),i.pagesInfo=i.pagesInfo||this.request(`repos/${r}/pages`,{},"GET",{headers:{Accept:"application/vnd.github.mister-fantastic-preview+json"}}),i.pagesInfo.then((t=>t.html_url+e)).catch((()=>`https://cdn.jsdelivr.net/gh/${r}@${t||this.branch||"latest"}/${e}`))},switchToMyForkDialog:function(e){let t=new URL(location).searchParams;return t.append(`${this.mavo.id}-storage`,e+"/"+this.path),this.notice=this.mavo.message(`\n\t\t\t${this.mavo._("gh-login-fork-options")}\n\t\t\t<form onsubmit="return false">\n\t\t\t\t<a href="${location.pathname}?${t}"><button>${this.mavo._("gh-use-my-fork")}</button></a>\n\t\t\t</form>`,{classes:"mv-inline",dismiss:["button","submit"]}),void this.notice.closed.then((e=>{e&&(history.pushState({},"",`${location.pathname}?${t}`),location.replace(`${location.pathname}?${t}`))}))},static:{apiDomain:"https://api.github.com/",oAuth:"https://github.com/login/oauth/authorize",key:"7e08e016048000bc594e",test:function(e){return e=new URL(e,Mavo.base),/^((api\.)?github\.com|raw\.githubusercontent\.com)/.test(e.host)},parseURL:function(e,t={}){const i={};Object.defineProperties(i,{apiCall:{get(){let e=`repos/${this.username}/${this.repo}/${this.resources??"contents"}`;const t=this.path;return t&&(e+=`/${t}`),e+(this.apiParams??"")},set(e){delete this.apiCall,this.apiCall=e},configurable:!0,enumerable:!0},path:{get(){return this.filename?(this.filepath?this.filepath+"/":"")+this.filename:this.filepath},set(e){delete this.path,this.path=e},configurable:!0,enumerable:!0}});const r=new URL(e,Mavo.base);let s=r.pathname.slice(1).split("/");if(i.username=s.shift(),i.repo=s.shift()||t.repo,/raw.githubusercontent.com$/.test(r.host))i.branch=s.shift();else if(/api.github.com$/.test(r.host)){delete i.username,delete i.repo,i.apiParams=r.search,i.apiData=Mavo.Functions.from(e,"#");const t=r.pathname.slice(1)+i.apiParams;if("graphql"==t)return i.apiCall=t,i.apiData={query:i.apiData},i;s=r.pathname.slice(1).split("/");if("repos"!=s.shift())return i.apiCall=t,i;i.username=s.shift(),i.repo=s.shift(),i.resources=s.shift()}else"blob"==s[0]&&(s.shift(),i.branch=s.shift());const a=s[s.length-1];return/\.\w+$/.test(a)?(i.filename=a,s.splice(s.length-1,1)):i.filename=i.hasOwnProperty("apiParams")?"":t.filename,i.filepath=s.join("/")||t.filepath||"",i},btoa:e=>btoa(unescape(encodeURIComponent(e))),atob:e=>decodeURIComponent(escape(window.atob(e)))}}))}(Bliss,Bliss.$);